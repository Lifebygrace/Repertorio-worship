<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Repertorio Worship</title>

<!-- ğŸ“± ConfiguraciÃ³n para iOS (icono pantalla de inicio) -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Repertorio Worship">
<link rel="apple-touch-icon" sizes="180x180" href="logo-180.png">

<!-- ğŸ“¦ Manifest + favicons Android -->
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="logo-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="logo-512.png">
  
  <style>
  :root{
    --primary:#002244;--accent:#ff8c42;--bg:#f0f4f8;--text:#002244;
    --section-bg:#fff8e1;--card-bg:#ffffff;--edit-bg:#FFEB3B;
  }
  body.dark{--bg:#121212;--text:#f0f4f8;--card-bg:#1e1e1e;--section-bg:#2a2a2a;--edit-bg:#f9a825}
  html,body{height:100%;margin:0;padding:0}
  body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);transition:background .25s,color .25s}
  header{background:var(--primary);color:#fff;padding:18px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
  .logo{display:flex;align-items:center;gap:12px}
  .logo img{height:56px;border-radius:8px}
  .controls{display:flex;gap:8px;align-items:center}
button{
  background:var(--accent);
  color:#fff;
  border:0;
  padding:6px 10px;
  border-radius:10px;
  cursor:pointer;
  font-weight:700;

  transition:
    transform 0.15s ease-out,
    box-shadow 0.15s ease-out;

  -webkit-tap-highlight-color: transparent;
}

button:active{
  transform: scale(0.94);
}
  button:hover{transform:scale(1.03)}
  main{max-width:900px;margin:18px auto;padding:12px}
.card{
  background:var(--card-bg);
  padding:14px;
  border-radius:14px;
  margin-bottom:16px;

  box-shadow:
    0 1px 2px rgba(0,0,0,.04),
    0 4px 12px rgba(0,0,0,.06);

  transition:
    transform 0.25s cubic-bezier(.2,.8,.2,1),
    box-shadow 0.25s cubic-bezier(.2,.8,.2,1);

  will-change: transform, box-shadow;
  -webkit-tap-highlight-color: transparent;
}

/* Feedback tÃ¡ctil mÃ³vil */
.card:active{
  transform: scale(0.97);
  box-shadow:
    0 1px 1px rgba(0,0,0,.04),
    0 2px 6px rgba(0,0,0,.08);
}

/* Hover solo escritorio */
@media (hover: hover){
  .card:hover{
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,.10);
  }
}
  .section{background:var(--section-bg);padding:14px;border-radius:10px;margin-bottom:16px}
  input[type="text"],textarea,input[type="date"]{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;background:transparent;color:inherit}
  .search-container{position:relative;margin-bottom:16px}
  #search{padding:14px 44px 14px 14px;border-radius:10px;border:2px solid var(--accent);font-size:1.05rem}
  #clearSearch{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:var(--accent);font-size:1.2rem;display:none}
  .link-btn{display:inline-block;background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none}
  .edit-banner{position:sticky;top:0;background:var(--edit-bg);padding:8px;text-align:center;font-weight:bold;display:none;z-index:50}
  footer{text-align:center;margin-top:24px;padding:16px;display:flex;flex-direction:column;align-items:center;gap:10px;flex-wrap:wrap}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid #ccc;padding:6px;text-align:center}
  th{background:var(--accent);color:#fff;cursor:pointer}
  ul.fechas-lista{list-style:none;padding:0;margin:0;text-align:left}
  .fechas-box{min-width:180px}
  .small{font-size:0.8rem;padding:4px 6px;border-radius:6px;margin-left:2px}
  .meta-line{font-size:0.9rem;color:#555;display:flex;gap:10px;align-items:center;margin-top:6px}
  .meta-line .plays,.meta-line .last{display:inline-block}
  .tocada-btn{background:#0077cc;padding:6px 8px;border-radius:6px;color:#fff;border:0;cursor:pointer;font-weight:700}
  .tocada-btn:hover{opacity:0.95}
  .counter-badge{background:rgba(0,0,0,0.06);padding:6px 12px;border-radius:10px;font-weight:700}
  .preview-img{max-width:350px;border-radius:8px;margin:8px 8px 0 0;display:inline-block;box-shadow:0 0 6px rgba(0,0,0,0.15);}
  .th-sortable{position:relative}
  .th-sortable .sort-ind{font-size:0.9rem;opacity:0.9;margin-left:6px}
  .edit-input{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;background:transparent;color:inherit;margin-bottom:8px}
  .clear-btn{background-color:#e74c3c !important;color:white !important;border:none !important;border-radius:6px !important;padding:6px 12px !important;cursor:pointer !important;font-size:14px !important;font-weight:bold !important;transition:background-color 0.2s ease,transform 0.1s ease !important;}
  .clear-btn:hover{background-color:#c0392b;transform:scale(1.1);}
  .clear-btn:active{transform:scale(0.95);}
  .delete-btn{background-color:#e74c3c;color:white;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-weight:bold;transition:background-color 0.2s ease,transform 0.1s ease;}
  .delete-btn:hover{background-color:#c0392b;transform:scale(1.05);}
  .delete-btn:active{transform:scale(0.95);}
 .notas-card {
  background: #fff8e1; /* fondo cÃ¡lido */
  border-left: 5px solid var(--accent);
  border-radius: 10px;
  padding: 14px 18px;
  margin-top: 12px; /* espacio sobre notas */
  margin-bottom: 12px; /* espacio debajo de notas */
  box-shadow: 0 2px 6px rgba(0,0,0,0.08);
  font-size: 0.95rem;
  line-height: 1.5;
  white-space: pre-wrap; /* respeta saltos de lÃ­nea */
  transition: background 0.25s, color 0.25s;
}
.notas-card h3 {
  margin-top: 0;
  margin-bottom: 8px;
  font-size: 1.1rem;
  color: var(--primary); /* modo claro */
}
.notas-card ul {
  padding-left: 20px;
  margin: 0;
}
.notas-card li {
  margin-bottom: 6px;
}
body.dark .notas-card {
  background: #2a2a2a;
  color: #f0f4f8;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}
body.dark .notas-card h3 {
  color: #ffca28; /* tÃ­tulo visible en modo oscuro */
}

.fade-apple{
  animation: fadeApple 0.42s cubic-bezier(.2,.8,.2,1) both;
}

@keyframes fadeApple{
  from{
    opacity:0;
    transform:translateY(10px) scale(0.98);
  }
  to{
    opacity:1;
    transform:translateY(0) scale(1);
  }
}

details > summary {
  cursor: pointer;
  list-style: none;
  font-weight: 600;
}

details > summary::-webkit-details-marker {
  display: none;
}

details[open] > *:not(summary){
  animation: expandApple 0.26s cubic-bezier(.16,1,.3,1);
}

@keyframes expandApple{
  from{
    opacity:0;
    transform:translateY(-4px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

/* =========================
   Details Apple â€“ animaciÃ³n mÃ¡s lenta
   (Resumen mensual / Observaciones)
========================= */

.details-slow[open] > *:not(summary){
  animation: expandAppleSlow 0.42s cubic-bezier(.2,.8,.2,1);
}


/* =========================
   Ver notas â€“ animaciÃ³n lenta estilo Apple Notes
========================= */

.notas-toggle.show{
  animation: notasFadeIn 0.55s cubic-bezier(.2,.8,.2,1) both;
}

@keyframes notasFadeIn{
  from{
    opacity: 0;
    transform: translateY(12px);
  }
  to{
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes expandAppleSlow{
  from{
    opacity:0;
    transform:translateY(-6px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

@media (prefers-reduced-motion: reduce){
  *{
    animation: none !important;
    transition: none !important;
  }
}

.card,
.fade-apple,
details > *{
  will-change: transform, opacity;
}

.metronome-ui{
  display: flex;
  flex-direction: column;
  gap: 14px;
  margin-top: 10px;
}

.bpm-display{
  font-size: 1.4rem;
  font-weight: 700;
  text-align: center;
}

#bpmSlider{
  width: 100%;
}

.metro-buttons{
  display: flex;
  justify-content: center;
}

.modal{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 999;
}

.modal-content{
  background: var(--card-bg);
  width: 90%;
  max-width: 360px;
  padding: 16px;
  border-radius: 16px;
  box-shadow: 0 12px 32px rgba(0,0,0,0.25);
  position: relative;
}

.close-btn{
  position: absolute;
  top: 8px;
  right: 10px;
  background: transparent;
  font-size: 1.2rem;
}
  </style>
</head>
<body>
<div class="edit-banner">âœï¸ Modo ediciÃ³n activo</div>

<header>
  <div class="logo">
    <img src="https://raw.githubusercontent.com/Lifebygrace/Repertorio-worship/main/logo.jpeg" alt="Logo" />
    <h1 style="margin:0">Repertorio Worship</h1>
  </div>
  <div class="controls">
    <button onclick="toggleDark()">ğŸŒ™ / â˜€ï¸</button>
    <button onclick="activarEdicion()">âœï¸ Editar</button>
    <button onclick="abrirMetronomo()">ğŸ•’ MetrÃ³nomo</button>
    <button id="toggleCancionesBtn" onclick="toggleCanciones()">ğŸµ Mostrar lista</button>
  </div>
</header>

<main>
  <div class="search-container">
    <input id="search" placeholder="ğŸ” Buscar canciones por tÃ­tulo..." />
<button id="clearSearch" class="clear-btn">âœ‚ï¸borrarâŒ</button>
  </div>

<div class="section">
  <h2>ğŸ¶ Canciones para la semana</h2>
  <div id="mostrar-semana" style="margin-top:8px"></div>

  <button onclick="toggleNotas('semana')">ğŸ—’ï¸ Ver notas</button>
  <div id="notas-semana" class="notas-toggle" style="display:none; margin-top:8px;"></div>

  <button onclick="mostrarWorshipPack('semana')">ğŸ Worship Pack</button>
  <div id="worshippack-semana" style="display:none; margin-top:8px;"></div>

  <div id="contenedor-semana" style="display:none; margin-top:10px;">
  <input id="titulo-semana" placeholder="TÃ­tulo (ej. Semana del 7 al 13)" />
  <select id="cantante-semana" style="margin-bottom:10px">
  <option value="">ğŸ¤ Cantante</option>
  <option value="Milly">Milly</option>
  <option value="Carolina">Carolina</option>
  <option value="Jason">Jason</option>
</select>
  <textarea id="canciones-semana" placeholder="Canciones (una por lÃ­nea)"></textarea>
  <textarea id="notas-edit-semana" placeholder="Notas de esta semana..."></textarea>
  <button onclick="guardarSeccion('semana')">Guardar secciÃ³n</button>
</div>
</div>

<div class="section">
  <h2>ğŸ†• Canciones nuevas del mes</h2>

  <!-- Contenedor donde se mostrarÃ¡n las canciones del mes -->
  <div id="mostrar-mes" style="margin-top:8px"></div>

  <!-- BotÃ³n para mostrar/ocultar notas -->
  <button onclick="toggleNotas('mes')">ğŸ—’ï¸ Ver notas</button>
  <div id="notas-mes" class="notas-toggle" style="display:none; margin-top:8px;"></div>

  <!-- BotÃ³n para mostrar/ocultar Worship Pack -->
  <button onclick="mostrarWorshipPack('mes')">ğŸ Worship Pack</button>
  <div id="worshippack-mes" style="display:none; margin-top:8px;"></div>

  <!-- Contenedor de ediciÃ³n (solo visible en modo ediciÃ³n) -->
  <div id="contenedor-mes" style="display:none; margin-top:10px;">
    <input id="titulo-mes" placeholder="TÃ­tulo (ej. Octubre 2025)" />
    <textarea id="canciones-mes" placeholder="Canciones (una por lÃ­nea)"></textarea>
    <textarea id="notas-edit-mes" placeholder="Notas de este mes..."></textarea>
    <button onclick="guardarSeccion('mes')">Guardar secciÃ³n</button>
  </div>
</div>

  <button id="btnAgregar" onclick="toggleFormulario()" style="display:none;">â• Agregar nueva canciÃ³n</button>

  <form id="formulario" onsubmit="event.preventDefault(); agregarCancion();" style="display:none;margin-top:12px;">
    <div class="card">
      <h2>Agregar canciÃ³n</h2>
      <input id="titulo" placeholder="TÃ­tulo de la canciÃ³n" required class="edit-input" />
      <textarea id="acordes" placeholder="Acordes..." class="edit-input"></textarea>
      <textarea id="imagenes" placeholder="Links de imÃ¡genes (uno por lÃ­nea)" class="edit-input"></textarea>
      <input id="audio" placeholder="Link de audio" class="edit-input" />
      <input id="youtube" placeholder="Link de YouTube" class="edit-input" />
      <button type="submit">Guardar canciÃ³n</button>
    </div>
  </form>

  <div id="lista-canciones" style="display:none;margin-top:12px;"></div>

  <div id="registro-canciones-container" style="margin-top:12px;">
    <button style="background:var(--accent);" onclick="toggleRegistro()">ğŸ“Š Registro de canciones</button>
    <button onclick="toggleAnalisis()">ğŸ“Š AnÃ¡lisis mensual</button>
    <div id="analisis-mensual" class="section" style="display:none;"></div>
    <div id="registro-canciones" class="section" style="display:none;">
      <h2>ğŸ“‹ Registro de canciones</h2>
      <table id="tabla-registro">
        <thead>
          <tr>
            <th class="th-sortable" onclick="setOrden('titulo')">TÃ­tulo <span class="sort-ind" id="sortTitulo"></span></th>
            <th class="th-sortable" onclick="setOrden('veces')">Veces tocada <span class="sort-ind" id="sortVeces"></span></th>
            <th class="th-sortable" onclick="setOrden('ultima')">Ãšltima fecha <span class="sort-ind" id="sortUltima"></span></th>
          </tr>
        </thead>
        <script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('/service-worker.js')
    .then(() => console.log('âœ… Service Worker registrado correctamente.'))
    .catch(err => console.error('âŒ Error al registrar el Service Worker:', err));
}
</script>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<footer>
  <!-- CONTADOR EN TIEMPO REAL por encima del botÃ³n volver al inicio -->
  <div id="contador-final" class="counter-badge">Canciones totales ğŸ¶: 0</div>
  <button onclick="window.scrollTo({top:0, behavior:'smooth'})">â¬†ï¸ Volver al inicio</button>
</footer>

<script type="module">
// Firebase (Firestore v9 modular)
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, onSnapshot, getDocs, deleteDoc
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDahT6IuQwSYdpAMcPpAERpqVuobmqmVSQ",
  authDomain: "repertorioworship.firebaseapp.com",
  projectId: "repertorioworship",
  storageBucket: "repertorioworship.firebasestorage.app",
  messagingSenderId: "493050453266",
  appId: "1:493050453266:web:cf07ce9fbb471122f167cb"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


/* =========================
   SECCIONES EN TIEMPO REAL
========================= */
function escucharSeccion(tipo) {
  const ref = doc(db, "secciones", tipo);

  onSnapshot(ref, snap => {
    if (!snap.exists()) return;

    const data = snap.data();

    const cont = document.getElementById(`mostrar-${tipo}`);
    cont.innerHTML = `
      <h3>${data.titulo || ""}</h3>
      ${tipo === "semana"
        ? `<p>ğŸ¤ Cantante: <strong>${data.cantante || "-"}</strong></p>`
        : ""}
      <ul>
        ${(data.canciones || []).map(c => `<li>${c}</li>`).join("")}
      </ul>
    `;

    const notasBox = document.getElementById(`notas-${tipo}`);
    if (notasBox) {
      notasBox.innerHTML = `
        <div class="notas-card">
          <h3>ğŸ“ Notas</h3>
          ${renderNotas(data.notas)}
        </div>`;
    }

    // ğŸ” Si el Worship Pack estÃ¡ abierto, refrescarlo
    const pack = document.getElementById(`worshippack-${tipo}`);
    if (pack && pack.style.display === "block") {
      mostrarWorshipPack(tipo);
    }
  });
}
/* Estado */
let modoEdicion = false;
let cancionesCache = [];
let registroCache = {};
let debounceTimer;
let cancionesVisible = false;
let ordenActual = { campo: 'titulo', sentido: 'desc' };

/* Utilidades */
function normalizar(t){ return (t||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(); }
function resaltar(t,q){ if(!q) return t; try{ const r=new RegExp(`(${q})`,"gi"); return t.replace(r,"<mark>$1</mark>"); }catch(e){return t;} }
function pad(n){ return String(n).padStart(2,'0'); }
function isoToday(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function isoToDisplay(iso){ if(!iso) return 'â€”'; if(/^\d{4}-\d{2}-\d{2}$/.test(iso)){ const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; } const dt=new Date(iso); if(isNaN(dt.getTime())) return iso; return `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()}`; }


function ajustarAServicio(fechaISO) {
  if (!fechaISO) return fechaISO;

  const d = new Date(fechaISO);
  if (isNaN(d)) return fechaISO;

  // Si es sÃ¡bado (6), mover a domingo
  if (d.getDay() === 6) {
    d.setDate(d.getDate() + 1);
  }

  return d.toISOString().slice(0, 10);
}

async function obtenerCantantePorFecha(fechaISO){
  try {
    const fechaServicio = ajustarAServicio(fechaISO); // ğŸ‘ˆ clave
    const mes = fechaServicio.slice(0,7); // YYYY-MM

    const analisisSnap = await getDoc(doc(db,"analisis_mensual",mes));

    if (analisisSnap.exists()) {
      const data = analisisSnap.data();
      if (data.cantantes && data.cantantes[fechaServicio]) {
        return data.cantantes[fechaServicio];
      }
    }

    // fallback: cantante de la semana
    const semanaSnap = await getDoc(doc(db,"secciones","semana"));
    if (semanaSnap.exists()) {
      return semanaSnap.data().cantante || "â€”";
    }

    return "â€”";
  } catch (e) {
    console.error("Error obteniendo cantante:", e);
    return "â€”";
  }
}

/* =========================
   Fechas â€“ anÃ¡lisis mensual
========================= */
function obtenerDomingosDelMes(mes) {
  const [y, m] = mes.split("-").map(Number);
  const fechas = [];
  const d = new Date(y, m - 1, 1);

  while (d.getMonth() === m - 1) {
    if (d.getDay() === 0) { // Domingo
      fechas.push(d.toISOString().slice(0,10));
    }
    d.setDate(d.getDate() + 1);
  }
  return fechas;
}

/* InicializaciÃ³n: escucha realtime de canciones */
async function inicializarCanciones(){
  const col = collection(db,"canciones");
  onSnapshot(col, snap => {
    cancionesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    actualizarContador();
    cargarCanciones();
    if(document.getElementById("registro-canciones").style.display === "block") cargarRegistro();
  });
}

/* Contador en tiempo real (texto exacto pedido) */
function actualizarContador(){
  const el = document.getElementById("contador-final");
  const n = cancionesCache.length || 0;
  el.textContent = `Canciones totales ğŸ¶: ${n}`;
}

/* ConstrucciÃ³n de tarjeta â€” meta debajo del tÃ­tulo + ediciÃ³n completa + preview imÃ¡genes en ediciÃ³n */
function construirCard(d){
  const div = document.createElement("div");
  div.className = "card fade-apple";

  // tÃ­tulo (editable en modo ediciÃ³n)
  const q = document.getElementById("search").value || "";
  const tituloHtml = modoEdicion 
    ? `<input type="text" class="edit-titulo edit-input" value="${(d.titulo||'').replace(/"/g,'&quot;')}" />`
    : `<h2>${resaltar(d.titulo||'', q)}</h2>`;

  // meta-line (vecestocada / Ãºltima) justo debajo del tÃ­tulo
  const metaHtml = `
    <div class="meta-line">
      <span class="plays" id="plays-${d.id}">ğŸµ Veces tocada: â€”</span>
      <span class="last" id="last-${d.id}">| Ãšltima vez: â€”</span>
      ${modoEdicion ? `<button class="tocada-btn" id="tocadaBtn-${d.id}">Tocada +1</button>` : ''}
    </div>
  `;

  // acordes
  const acordesHtml = modoEdicion 
    ? `<textarea class="edit-acordes edit-input">${(d.acordes||'')}</textarea>`
    : `<p>${(d.acordes||'')}</p>`;

  // imÃ¡genes: en ediciÃ³n mostramos textarea para URLs + preview div; fuera de ediciÃ³n mostramos imgs
  const imagenesHtml = modoEdicion
    ? `<textarea class="edit-imagenes edit-input" data-id="${d.id}">${(d.imagenes||[]).join("\n")}</textarea><div id="preview-${d.id}">${(d.imagenes||[]).map(u=>`<img class="preview-img" src="${u}" />`).join("")}</div>`
    : `<div>${(d.imagenes||[]).map(u=>`<img src="${u}" style="width:100%;margin-top:8px;border-radius:8px;">`).join("")}</div>`;

  // audio / youtube fields
  const audioHtml = modoEdicion ? `<input type="text" class="edit-audio edit-input" value="${(d.audio||'').replace(/"/g,'&quot;')}" placeholder="Link de audio">` : (d.audio ? `<a class="link-btn" href="${d.audio}" target="_blank">ğŸ§ Escuchar</a>` : "");
  const youtubeHtml = modoEdicion ? `<input type="text" class="edit-youtube edit-input" value="${(d.youtube||'').replace(/"/g,'&quot;')}" placeholder="Link de YouTube">` : (d.youtube ? `<a class="link-btn" href="${d.youtube}" target="_blank">ğŸ“º YouTube</a>` : "");

  // edit buttons
const editButtons = modoEdicion 
  ? `<div style="margin-top:10px">
       <button onclick="guardarEdicion('${d.id}', this)">ğŸ’¾ Guardar</button> 
       <button class="delete-btn" onclick="borrarCancion('${d.id}')">ğŸ—‘ï¸ Borrar</button>
     </div>` 
  : "";

  div.innerHTML = tituloHtml + metaHtml + acordesHtml + `<div style="margin-top:8px">${imagenesHtml}</div>` + `<div style="margin-top:8px">${audioHtml} ${youtubeHtml}</div>` + editButtons;

  // actualizar data de registro en la tarjeta
  actualizarRegistroCard(d.id);

  // si estamos en modo ediciÃ³n, enlazamos listeners para preview e "Tocada +1"
  if(modoEdicion){
    // pequeÃ±a espera para que el DOM del card se inserte antes de seleccionar elementos
    setTimeout(()=>{
      const tocBtn = document.getElementById(`tocadaBtn-${d.id}`);
      if(tocBtn) tocBtn.addEventListener('click', ()=> marcarTocada(d.id));

      // listener de preview en textarea
      const area = div.querySelector(".edit-imagenes");
      const preview = document.getElementById(`preview-${d.id}`);
      if(area && preview){
        area.addEventListener('input', ()=> {
          const urls = area.value.split("\n").map(s=>s.trim()).filter(Boolean);
          preview.innerHTML = urls.map(u=>`<img class="preview-img" src="${u}" />`).join("");
        });
      }
    },0);
  }

  return div;
}

/* Actualiza la lÃ­nea de registro dentro de la tarjeta */
async function actualizarRegistroCard(id){
  try{
    const ref = doc(db,"registro",id);
    const snap = await getDoc(ref);
    const playsEl = document.getElementById(`plays-${id}`);
    const lastEl = document.getElementById(`last-${id}`);
    if(!playsEl || !lastEl) return;
    if(!snap.exists()){
      playsEl.innerHTML = `ğŸµ <strong>Veces tocada:</strong> 0`;
      lastEl.innerHTML = `| <strong>Ãšltima vez:</strong> â€”`;
      return;
    }
    const data = snap.data();
    const veces = Number(data.veces||0);
    const fechas = Array.isArray(data.fechas) ? data.fechas : [];
    const ultima = fechas.length ? fechas[fechas.length-1] : null;
    playsEl.innerHTML = `ğŸµ <strong>Veces tocada:</strong> ${veces}`;
    lastEl.innerHTML = `| <strong>Ãšltima vez:</strong> ${ultima ? isoToDisplay(ultima) : 'â€”'}`;
  } catch(e){ console.error("Error actualizarRegistroCard:", e); }
}

/* Marcar tocada +1 */
async function marcarTocada(id){
  try{
    const ref = doc(db,"registro",id);
    const snap = await getDoc(ref);
    const data = snap.exists()?snap.data():{veces:0,fechas:[]};
    const nuevas = Array.isArray(data.fechas)?[...data.fechas]:[];
    nuevas.push(isoToday());
    await setDoc(ref, {veces: nuevas.length, fechas: nuevas});
    actualizarRegistroCard(id);
    if(document.getElementById("registro-canciones").style.display==="block") cargarRegistro();
  } catch(e){ console.error("Error marcarTocada:", e); alert("Error marcando tocada (mira consola)."); }
}

/* Render lista de canciones (aplica bÃºsqueda) */

function cargarCanciones(){
  const cont = document.getElementById("lista-canciones");
  cont.innerHTML = "";

  // Limpia espacios antes y despuÃ©s de la bÃºsqueda
  const q = normalizar((document.getElementById("search").value || "").trim());

  // Si no hay texto, no aplicar filtro (muestra todo solo si estÃ¡ habilitado)
  cancionesCache.forEach(c => {
    const tituloNormalizado = normalizar(c.titulo || "").trim();
    if (tituloNormalizado.includes(q)) cont.appendChild(construirCard(c));
  });

  cont.style.display = (cancionesVisible || q.length > 0) ? "block" : "none";
}

/* Agregar canciÃ³n */
async function agregarCancion(){
  const titulo = document.getElementById("titulo").value.trim();
  if(!titulo) return alert("El tÃ­tulo es obligatorio");
  await addDoc(collection(db,"canciones"), {
    titulo,
    acordes: document.getElementById("acordes").value.trim(),
    imagenes: document.getElementById("imagenes").value.trim().split("\n").map(s=>s.trim()).filter(Boolean),
    audio: document.getElementById("audio").value.trim(),
    youtube: document.getElementById("youtube").value.trim()
  });
  document.getElementById("formulario").reset();
  document.getElementById("formulario").style.display = "none";
  // onSnapshot actualizarÃ¡ lista y contador automÃ¡ticamente
}

/* Guardar ediciÃ³n (lectura de inputs dentro de la tarjeta) */
async function guardarEdicion(id, btn){
  try{
    const card = btn.closest(".card");
    // Preferimos inputs/textareas con clases edit-*
    const titulo = card.querySelector(".edit-titulo") ? card.querySelector(".edit-titulo").value.trim() : (card.querySelector("h2")?card.querySelector("h2").innerText.trim():'');
    const acordes = card.querySelector(".edit-acordes") ? card.querySelector(".edit-acordes").value.trim() : (card.querySelector("p")?card.querySelector("p").innerText.trim():'');
    const imagenesTxt = card.querySelector(".edit-imagenes") ? card.querySelector(".edit-imagenes").value.trim() : "";
    const imagenes = imagenesTxt ? imagenesTxt.split("\n").map(s=>s.trim()).filter(Boolean) : [];
    const audio = card.querySelector(".edit-audio") ? card.querySelector(".edit-audio").value.trim() : "";
    const youtube = card.querySelector(".edit-youtube") ? card.querySelector(".edit-youtube").value.trim() : "";

    await updateDoc(doc(db,"canciones",id), { titulo, acordes, imagenes, audio, youtube });
    alert("âœ… Cambios guardados");
  } catch(e){
    console.error("Error guardarEdicion:", e);
    alert("Error al guardar cambios (ver consola).");
  }
}

/* Borrar canciÃ³n (y su registro) */
async function borrarCancion(id){
  if(!confirm("Â¿Seguro que quieres borrar esta canciÃ³n?")) return;
  try{
    await deleteDoc(doc(db,"canciones",id));
    // borrar registro histÃ³rico tambiÃ©n si existe
    try{ await deleteDoc(doc(db,"registro",id)); } catch(e){ /* ignore if missing */ }
    // onSnapshot actualizarÃ¡ lista/contador automÃ¡ticamente
    if(document.getElementById("registro-canciones").style.display==="block") cargarRegistro();
  } catch(e){
    console.error("Error borrarCancion:", e);
    alert("Error al borrar (ver consola).");
  }
}

/* SECCIONES (semana / mes) */

// FunciÃ³n para renderizar notas en lista con emojis
function renderNotas(texto){
  if(!texto) return "(No hay notas para esta secciÃ³n)";

  // Agregar emojis segÃºn palabras clave
  texto = texto.replace(/importante/gi, "âš ï¸ importante")
               .replace(/ensayar/gi, "ğŸµ ensayar")
               .replace(/recordar/gi, "ğŸ”” recordar")
               .replace(/audio/gi, "ğŸ§ audio");

  // Separar en lÃ­neas y convertir en <ul>
  const lineas = texto.split("\n").filter(l => l.trim());
  return `<ul>${lineas.map(l => `<li>${l}</li>`).join("")}</ul>`;
}

// FunciÃ³n principal
async function cargarSeccion(tipo){
  try{
    const snap = await getDoc(doc(db,"secciones",tipo));
    const cont = document.getElementById(`mostrar-${tipo}`);
    const notasBox = document.getElementById(`notas-${tipo}`);
    const notasEdit = document.getElementById(`notas-edit-${tipo}`);

    if(!cont){
      console.warn(`Contenedor mostrar-${tipo} no existe en DOM`);
      return;
    }

    if(snap.exists()){

      const data = snap.data();
            if (modoEdicion && tipo === "semana") {
  const sel = document.getElementById("cantante-semana");
  if (sel) sel.value = data.cantante || "";
}
      
      // SecciÃ³n principal con tÃ­tulo y canciones
     cont.innerHTML = `
  <h3>${data.titulo || ""}</h3>
  ${tipo === "semana"
    ? `<p>ğŸ¤ Cantante: <strong>${data.cantante || "-"}</strong></p>`
    : ""
  }
  <ul>${(data.canciones || []).map(c => `<li>${c}</li>`).join("")}</ul>
`;

      // Renderizar notas si existe el contenedor
      if(notasBox){
        notasBox.innerHTML = `<div class="notas-card"><h3>ğŸ“ Notas</h3>${renderNotas(data.notas)}</div>`;
      }

      // Actualizar textarea de ediciÃ³n si estamos en modo ediciÃ³n
      if(modoEdicion && notasEdit){
        notasEdit.value = data.notas || "";
      }

    } else {
      cont.innerHTML = "<p>AÃºn no hay informaciÃ³n guardada.</p>";
      if(notasBox) notasBox.innerHTML = "<p>(No hay notas)</p>";
      if(modoEdicion && notasEdit) notasEdit.value = "";
    }

    const contenedor = document.getElementById(`contenedor-${tipo}`);
    if(contenedor) contenedor.style.display = modoEdicion ? "block" : "none";

  } catch(e){
    console.error("Error en cargarSeccion:", e);
  }
}

// Toggle notas
function toggleNotas(tipo){
  const box = document.getElementById(`notas-${tipo}`);
  if(!box) return;

  const visible = box.style.display === "block";

  if(visible){
    box.style.display = "none";
    box.classList.remove("show");
  } else {
    box.style.display = "block";
    // fuerza reflow para que la animaciÃ³n siempre se ejecute
    box.offsetHeight;
    box.classList.add("show");
  }
}

async function guardarSeccion(tipo){
  const titulo = document.getElementById(`titulo-${tipo}`).value.trim();
  const canciones = document.getElementById(`canciones-${tipo}`).value.trim().split("\n").map(s=>s.trim()).filter(Boolean);
  const cantante =
  tipo === "semana"
    ? document.getElementById("cantante-semana")?.value || ""
    : undefined;
  const notas = document.getElementById(`notas-edit-${tipo}`).value.trim();

 await setDoc(doc(db, "secciones", tipo), { 
  titulo, 
  canciones, 
  ...(tipo === "semana" && { cantante }),
  notas 
});

  alert("âœ… SecciÃ³n guardada");
  cargarSeccion(tipo);
}

/* MODO EDICIÃ“N con PIN 2025 */
function activarEdicion(){
  if(!modoEdicion){
    const pin = prompt("Introduce el PIN para editar:");
    if(pin === "2025"){
      modoEdicion = true;
      document.querySelector(".edit-banner").style.display = "block";
      document.getElementById("btnAgregar").style.display = "block";
      alert("âœï¸ Modo ediciÃ³n activado");
    } else if(pin) {
      return alert("PIN incorrecto");
    }
  } else {
    modoEdicion = false;
    document.querySelector(".edit-banner").style.display = "none";
    document.getElementById("btnAgregar").style.display = "none";
    alert("ğŸ”’ Modo ediciÃ³n desactivado");
  }
  cargarSeccion("semana"); cargarSeccion("mes"); cargarCanciones(); cargarRegistro();
  if (document.getElementById("analisis-mensual").style.display === "block") {
  cargarAnalisisMensual();
  }
}

/* BÃºsqueda */
function debounceBuscar(){ clearTimeout(debounceTimer); debounceTimer = setTimeout(cargarCanciones, 300); }

/* Toggles y UI helpers */
function toggleDark(){ document.body.classList.toggle("dark"); localStorage.setItem("theme", document.body.classList.contains("dark") ? "dark" : "light"); }
function toggleFormulario(){ const f = document.getElementById("formulario"); f.style.display = f.style.display === "none" ? "block" : "none"; }
function toggleCanciones(){ cancionesVisible = !cancionesVisible; document.getElementById("toggleCancionesBtn").textContent = cancionesVisible ? "ğŸµ Ocultar lista" : "ğŸµ Mostrar lista"; cargarCanciones(); }
function toggleRegistro(){ const el = document.getElementById("registro-canciones"); el.style.display = el.style.display === "block" ? "none" : "block"; if(el.style.display==="block") cargarRegistro(); }
/* =========================
   ANÃLISIS MENSUAL
========================= */

/* Mostrar / ocultar anÃ¡lisis mensual */
function toggleAnalisis() {
  const el = document.getElementById("analisis-mensual");
  if(!el) return;

  // Alterna visibilidad
  el.style.display = el.style.display === "block" ? "none" : "block";

  // Solo cargar datos si se muestra
  if(el.style.display === "block") cargarAnalisisMensual();
}

/* Carga y renderiza el anÃ¡lisis mensual */
async function cargarAnalisisMensual() {
  const cont = document.getElementById("analisis-mensual");
  cont.innerHTML = "<h2>ğŸ“Š AnÃ¡lisis mensual</h2>";
  
  const toggleBtn = document.createElement("button");
  toggleBtn.textContent = "ğŸ“‚ Ver meses anteriores";
  toggleBtn.style.margin = "8px 0";
  toggleBtn.style.display = "block";
  
  const mesesAnterioresCont = document.createElement("div");
  mesesAnterioresCont.style.display = "none";
  
  toggleBtn.addEventListener("click", () => {
  const visible = mesesAnterioresCont.style.display === "block";
  mesesAnterioresCont.style.display = visible ? "none" : "block";
  toggleBtn.textContent = visible
    ? "ğŸ“‚ Ver meses anteriores"
    : "ğŸ“‚ Ocultar meses anteriores";
});



  const snapRegistro = await getDocs(collection(db,"registro"));
  const analisisSnap = await getDocs(collection(db,"analisis_mensual"));

  const analisisGuardado = {};
  analisisSnap.forEach(d => analisisGuardado[d.id] = d.data());

  // Agrupar por mes
  const mapaMeses = {}; 
  snapRegistro.forEach(docu => {
    const data = docu.data();
    const fechas = Array.isArray(data.fechas) ? data.fechas : [];
    const cancion = cancionesCache.find(c => c.id === docu.id);
    if(!cancion) return;

    fechas.forEach(f => {
      const mes = f.slice(0,7);
      if(!mapaMeses[mes]) mapaMeses[mes] = { canciones:{}, cantantes: "", evaluaciones:{}, observaciones:"" };
      mapaMeses[mes].canciones[cancion.id] = (mapaMeses[mes].canciones[cancion.id] || 0) + 1;
    });
  });

  let meses = Object.keys(mapaMeses).sort().reverse(); // Mes mÃ¡s reciente primero
  if(!meses.length){
    cont.innerHTML += "<p>No hay datos aÃºn.</p>";
    return;
  }

  const ultimoMes = meses[0];

meses.forEach((mes, index) => {
    const fecha = new Date(mes+"-01");
    const nombreMes = fecha.toLocaleDateString("es-ES",{month:"long",year:"numeric"});
    const datosMes = analisisGuardado[mes] || { canciones:{}, cantantes:{}, evaluaciones:{}, observaciones:"" };
    const cancionesMes = mapaMeses[mes].canciones;

    const listaCanciones = Object.keys(cancionesMes).map(id => {
      const c = cancionesCache.find(x=>x.id===id);
      return { id, titulo: c?.titulo || "â€”", veces: cancionesMes[id] };
    });

// Ordenar TODAS las canciones por popularidad ğŸ”¥
const resumen = [...listaCanciones].sort((a,b)=>b.veces - a.veces);

    const card = document.createElement("div");
    card.className = "card";
    card.style.marginTop = "12px";

// Cantantes
const domingos = obtenerDomingosDelMes(mes).map(f => ajustarAServicio(f));

const cantanteHtml = `
  <details class="details-slow" style="margin-top:6px;">
    <summary>ğŸ¤ Cantantes del mes</summary>

    ${domingos.map(fechaOriginal => {
      const fecha = ajustarAServicio(fechaOriginal);

      return `
        <div style="margin-top:6px">
          ${isoToDisplay(fecha)} â†’
          ${
            modoEdicion
              ? `<select class="cantante-select"
                    data-mes="${mes}"
                    data-fecha="${fecha}">
                  <option value=""></option>
                  <option value="Milly" ${datosMes.cantantes?.[fecha]==="Milly"?"selected":""}>Milly</option>
                  <option value="Carolina" ${datosMes.cantantes?.[fecha]==="Carolina"?"selected":""}>Carolina</option>
                  <option value="Jason" ${datosMes.cantantes?.[fecha]==="Jason"?"selected":""}>Jason</option>
                </select>`
              : `<strong>${datosMes.cantantes?.[fecha] || "-"}</strong>`
          }
        </div>
      `;
    }).join("")}

  </details>
`;
  
    // Top 3 canciones con veces tocadas y emoji de valoraciÃ³n
    const resumenHtml = resumen.map(c=>{
      const val = datosMes.evaluaciones?.[c.id] || "";
      const emoji = val === "A mejorar" ? "â€¼ï¸" : val === "Bien" ? "ğŸ‘" : val === "Excelente" ? "ğŸš€" : "";
      if(modoEdicion){
        return `<li>${c.titulo} (${c.veces}) - 
          <select class="eval-select" data-id="${c.id}" data-mes="${mes}">
            <option value="" ${val===""?"selected":""}></option>
            <option value="A mejorar" ${val==="A mejorar"?"selected":""}>â€¼ï¸</option>
            <option value="Bien" ${val==="Bien"?"selected":""}>ğŸ‘</option>
            <option value="Excelente" ${val==="Excelente"?"selected":""}>ğŸš€</option>
          </select>
        </li>`;
      } else {
        return `<li>${c.titulo} (${c.veces}) ${emoji}</li>`;
      }
    }).join("");

    // Observaciones con mismo estilo de top 3
    const obsHtml = modoEdicion 
      ? `<ul><li><textarea class="obs-textarea" data-mes="${mes}" placeholder="Escribe observaciones o consejos aquÃ­..." style="width:100%;height:60px;margin-top:4px;">${datosMes.observaciones||""}</textarea></li></ul>`
      : `<ul><li>${datosMes.observaciones||""}</li></ul>`;

    const abierto = mes === ultimoMes ? "open" : "";

    card.innerHTML = `
      <details ${abierto}>
        <summary>ğŸ“… ${nombreMes}</summary>
        <div style="margin-top:8px;">${cantanteHtml}</div>
        <details class="details-slow" style="margin-top:6px;">
        <summary>ğŸ“Œ resumen musical ğŸ”¥</summary>
          <div class="notas-card" style="margin-top:4px;"><ul>${resumenHtml}</ul></div>
        </details>
        <details class="details-slow" style="margin-top:6px;">
        <summary>ğŸ“ Observaciones / Consejos</summary>
          <div class="notas-card" style="margin-top:4px;">${obsHtml}</div>
        </details>
        ${modoEdicion ? `<button class="guardar-analisis-btn" data-mes="${mes}" style="margin-top:8px;">ğŸ’¾ Guardar anÃ¡lisis</button>` : ""}
      </details>
    `;

if (index === 0) {
  // ğŸŸ¢ Mes mÃ¡s reciente
  cont.appendChild(card);

  // â¬‡ï¸ BotÃ³n JUSTO debajo del contenido del mes actual
  cont.appendChild(toggleBtn);
  cont.appendChild(mesesAnterioresCont);
} else {
  // ğŸ“‚ Meses anteriores (orden correcto)
  mesesAnterioresCont.appendChild(card);
}
  });

  if(modoEdicion){
    document.querySelectorAll(".guardar-analisis-btn").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const mes = btn.dataset.mes;
        const evaluaciones = {};
        document.querySelectorAll(`.eval-select[data-mes="${mes}"]`).forEach(sel=>{
          const id = sel.dataset.id;
          evaluaciones[id] = sel.value;
        });
        const cantantes = {};
document.querySelectorAll(`.cantante-select[data-mes="${mes}"]`).forEach(sel => {
  cantantes[sel.dataset.fecha] = sel.value;
});
        const observaciones = document.querySelector(`.obs-textarea[data-mes="${mes}"]`).value;
        await setDoc(doc(db,"analisis_mensual",mes),{
  canciones: mapaMeses[mes].canciones,
  evaluaciones,
  cantantes,
  observaciones
});
        alert("âœ… AnÃ¡lisis mensual guardado");
      });
    });
  }
}

/* Registro (cargar/ordenar/editar fechas) */
async function cargarRegistro(){
  registroCache = {};
  const snap = await getDocs(collection(db,"registro"));
  snap.forEach(d=> registroCache[d.id] = d.data());
  const combinado = cancionesCache.map(c => {
    const r = registroCache[c.id] || { veces:0, fechas:[] };
    const fechas = Array.isArray(r.fechas) ? r.fechas : [];
    return { id: c.id, titulo: c.titulo || "Sin tÃ­tulo", veces: Number(r.veces||0), fechas };
  });

  combinado.sort((a,b) => {
    const campo = ordenActual.campo; const sentido = ordenActual.sentido === "asc" ? 1 : -1;
    if(campo === "veces") return (a.veces - b.veces) * sentido;
    if(campo === "ultima"){
      const da = a.fechas.length ? a.fechas[a.fechas.length-1] : "";
      const db = b.fechas.length ? b.fechas[b.fechas.length-1] : "";
      return ((da||'') < (db||'') ? -1 : ((da||'') > (db||'') ? 1 : 0)) * sentido;
    }
    return a.titulo.localeCompare(b.titulo) * sentido;
  });

  const tbody = document.querySelector("#tabla-registro tbody");
  tbody.innerHTML = "";
  combinado.forEach(r => {
    let fechasHtml = "";
    if(modoEdicion){
      fechasHtml = `<div class="fechas-box">${r.fechas.map((f,idx)=>`<div><input type="date" value="${f}" onchange="modificarFecha('${r.id}',${idx},this.value)"> <button class="small" onclick="borrarFecha('${r.id}',${idx})">âŒ</button></div>`).join("")}<div style="margin-top:4px"><button class="small" onclick="agregarFechaManual('${r.id}')">â• AÃ±adir fecha</button></div></div>`;
    } else {
const ultima = r.fechas.length ? r.fechas[r.fechas.length-1] : "";

fechasHtml = `
  <div class="fechas-box">
    ${ultima ? isoToDisplay(ultima) : ""}
    ${
      r.fechas.length > 1
        ? `<button class="small ver-mas-btn"
            data-fechas='${JSON.stringify(r.fechas)}'>
            Ver mÃ¡s
           </button>`
        : ""
    }
  </div>
`;
     }
    const tr = document.createElement("tr");
    tr.innerHTML = `<td style="text-align:left">${r.titulo}</td><td>${r.veces}</td><td>${fechasHtml}</td>`;
    tbody.appendChild(tr);
  });

  document.getElementById('sortTitulo').textContent = ordenActual.campo==='titulo' ? (ordenActual.sentido==='asc' ? 'ğŸ”¼' : 'ğŸ”½') : '';
  document.getElementById('sortVeces').textContent = ordenActual.campo==='veces' ? (ordenActual.sentido==='asc' ? 'ğŸ”¼' : 'ğŸ”½') : '';
  document.getElementById('sortUltima').textContent = ordenActual.campo==='ultima' ? (ordenActual.sentido==='asc' ? 'ğŸ”¼' : 'ğŸ”½') : '';
  }
// Activar botones "Ver mÃ¡s"
document.addEventListener("click", e => {
  const btn = e.target.closest(".ver-mas-btn");
  if (!btn) return;

  try {
    const fechas = JSON.parse(btn.dataset.fechas || "[]");
    verHistorialConCantante(fechas);
  } catch (err) {
    console.error("Error parseando fechas:", err);
    alert("Error mostrando el historial");
  }
});
/* =========================
   Historial con cantante
========================= */

async function verHistorialConCantante(fechas){
  let texto = "ğŸ“… Historial de canciones\n\n";

  for (const f of fechas) {
    const cantante = await obtenerCantantePorFecha(f);
    texto += `${isoToDisplay(f)} â†’ ${cantante || "â€”"}\n`;
  }

  alert(texto);
}

/* Fecha helpers */
async function agregarFechaManual(id){
  const fecha = prompt("Introduce la fecha (YYYY-MM-DD):");
  if(!fecha) return;
  const ref = doc(db,"registro",id);
  const snap = await getDoc(ref);
  const data = snap.exists()?snap.data():{veces:0,fechas:[]};
  const nuevas = Array.isArray(data.fechas) ? [...data.fechas, fecha] : [fecha];
  await setDoc(ref, { veces: nuevas.length, fechas: nuevas });
  cargarRegistro();
}
async function borrarFecha(id, idx){
  if(!confirm("Borrar esta fecha?")) return;
  const ref = doc(db,"registro",id);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const data = snap.data();
  const nuevas = Array.isArray(data.fechas) ? data.fechas.filter((_,i)=>i!==idx) : [];
  await setDoc(ref, { veces: nuevas.length, fechas: nuevas });
  cargarRegistro();
}
async function modificarFecha(id, idx, val){
  const ref = doc(db,"registro",id);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const data = snap.data();
  const nuevas = Array.isArray(data.fechas) ? [...data.fechas] : [];
  nuevas[idx] = val;
  await setDoc(ref, { veces: nuevas.length, fechas: nuevas });
  cargarRegistro();
}

function setOrden(campo){
  if(ordenActual.campo === campo) ordenActual.sentido = ordenActual.sentido === "asc" ? "desc" : "asc";
  else { ordenActual.campo = campo; ordenActual.sentido = "desc"; }
  cargarRegistro();
}
function generarResumenMes(mes, mapaMeses, datosMes){
  const canciones = Object.entries(mapaMeses[mes] || {});
  if(!canciones.length) return "";

  const total = canciones.length;
  const top = canciones.sort((a,b)=>b[1]-a[1])[0];
  const topSong = cancionesCache.find(c=>c.id===top[0])?.titulo || "â€”";

  const evals = { excelente:0, bien:0, mejorar:0 };
  Object.values(datosMes.canciones || {}).forEach(c=>{
    if(c.eval) evals[c.eval]++;
  });

  return `
    <div class="notas-card">
      <h3>ğŸ“ˆ Resumen del mes</h3>
      <ul>
        <li>ğŸµ Canciones distintas: <strong>${total}</strong></li>
        <li>ğŸ”¥ MÃ¡s tocada: <strong>${topSong}</strong> (${top[1]} veces)</li>
        <li>â­ Excelente: ${evals.excelente} | ğŸ‘ Bien: ${evals.bien} | âš ï¸ A mejorar: ${evals.mejorar}</li>
      </ul>
    </div>
  `;
}
async function guardarAnalisisMes(mes){
  const canciones = {};
  document.querySelectorAll(`.cantante-input[data-mes="${mes}"]`).forEach(i=>{
    const id = i.dataset.id;
    canciones[id] = canciones[id] || {};
    canciones[id].cantante = i.value.trim();
  });

  document.querySelectorAll(`.nota-input[data-mes="${mes}"]`).forEach(i=>{
    const id = i.dataset.id;
    canciones[id] = canciones[id] || {};
    canciones[id].notas = i.value.trim();
  });

  const notasGenerales = document.querySelector(`.notas-generales[data-mes="${mes}"]`).value.trim();
document.querySelectorAll(`.eval-input[data-mes="${mes}"]`).forEach(i=>{
  const id = i.dataset.id;
  canciones[id] = canciones[id] || {};
  canciones[id].eval = i.value;
});
  await setDoc(doc(db,"analisis_mensual",mes),{
    canciones,
    notasGenerales
  });

  alert("âœ… AnÃ¡lisis mensual guardado");
}

let audioCtx;
let metronomeInterval = null;
let isRunning = false;
let currentBpm = Number(localStorage.getItem("metroBpm")) || 80;

const bpmSlider = () => document.getElementById("bpmSlider");
const bpmValue  = () => document.getElementById("bpmValue");
const metroBtn  = () => document.getElementById("metroToggle");

function initMetronome(){
  if(!audioCtx){
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  }
}

function playClick(){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "square";
  osc.frequency.value = 1000;
  gain.gain.value = 0.15;

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start();
  osc.stop(audioCtx.currentTime + 0.05);
}

function startMetronome(){
  initMetronome();
  const interval = 60000 / currentBpm;

  playClick();
  metronomeInterval = setInterval(playClick, interval);
  isRunning = true;
  metroBtn().textContent = "â¸ Stop";
}

function stopMetronome(){
  clearInterval(metronomeInterval);
  metronomeInterval = null;
  isRunning = false;
  metroBtn().textContent = "â–¶ï¸ Start";
}

function toggleMetronome(){
  isRunning ? stopMetronome() : startMetronome();
}

function abrirMetronomo(){
  document.getElementById("modal-metronomo").style.display = "flex";

  bpmSlider().value = currentBpm;
  bpmValue().textContent = currentBpm;
}

function cerrarMetronomo(){
  stopMetronome();
  document.getElementById("modal-metronomo").style.display = "none";
}

/* Eventos */
document.addEventListener("input", e => {
  if(e.target.id === "bpmSlider"){
    currentBpm = Number(e.target.value);
    bpmValue().textContent = currentBpm;
    localStorage.setItem("metroBpm", currentBpm);

    if(isRunning){
      stopMetronome();
      startMetronome();
    }
  }
});

document.addEventListener("click", e => {
  if(e.target.id === "metroToggle"){
    toggleMetronome();
  }
});
/* BOOT */

/* Mostrar / ocultar Worship Pack (tarjetas de las canciones listadas en la secciÃ³n) */
async function mostrarWorshipPack(tipo) {
  const cont = document.getElementById(`worshippack-${tipo}`);
  const boton = document.querySelector(
    `button[onclick="mostrarWorshipPack('${tipo}')"]`
  );
  if (!cont || !boton) return;

  // Toggle
  if (cont.style.display === "block") {
    cont.style.display = "none";
    cont.innerHTML = "";
    boton.textContent = "ğŸ Worship Pack";
    return;
  }

  const snap = await getDoc(doc(db, "secciones", tipo));
  if (!snap.exists()) {
    cont.innerHTML = "<p>No hay canciones guardadas.</p>";
    cont.style.display = "block";
    boton.textContent = "ğŸ”½ Ocultar pack";
    return;
  }

  const data = snap.data();
  cont.innerHTML = "";

  // ğŸ”‘ CLAVE: recorrer en el orden escrito
  data.canciones.forEach(tituloSemana => {
    const cancion = cancionesCache.find(
      c => normalizar(c.titulo) === normalizar(tituloSemana)
    );

    if (cancion) {
      cont.appendChild(construirCard(cancion));
    }
  });

  if (!cont.innerHTML) {
    cont.innerHTML =
      "<p>âš ï¸ Ninguna de las canciones coincide con el repertorio.</p>";
  }

  cont.style.display = "block";
  boton.textContent = "ğŸ”½ Ocultar pack";
}

window.addEventListener('load', ()=>{
  const saved = localStorage.getItem("theme");
  if(saved === "dark") document.body.classList.add("dark");

  const searchInput = document.getElementById("search");
  const clearBtn = document.getElementById("clearSearch");
  searchInput.addEventListener("input", ()=>{ debounceBuscar(); clearBtn.style.display = searchInput.value ? "block" : "none"; });
  clearBtn.addEventListener("click", ()=>{ searchInput.value = ""; clearBtn.style.display = "none"; cargarCanciones(); });

  // bind global functions used from html
  window.agregarCancion = agregarCancion;
  window.guardarEdicion = guardarEdicion;
  window.toggleDark = toggleDark;
  window.toggleFormulario = toggleFormulario;
  window.activarEdicion = activarEdicion;
  window.guardarSeccion = guardarSeccion;
  window.toggleCanciones = toggleCanciones;
  window.toggleRegistro = toggleRegistro;
  window.agregarFechaManual = agregarFechaManual;
  window.borrarFecha = borrarFecha;
  window.modificarFecha = modificarFecha;
  window.setOrden = setOrden;
  window.guardarAnalisisMes = guardarAnalisisMes;
  window.marcarTocada = marcarTocada;
  window.actualizarRegistroCard = actualizarRegistroCard;
  window.mostrarWorshipPack = mostrarWorshipPack;
  window.toggleNotas = toggleNotas;
  window.abrirMetronomo = abrirMetronomo;
  window.cerrarMetronomo = cerrarMetronomo;
  window.toggleMetronome = toggleMetronome;
  inicializarCanciones();
  escucharSeccion("semana");
  escucharSeccion("mes");
  window.toggleAnalisis = toggleAnalisis;
  window.verHistorialConCantante = verHistorialConCantante;
});
</script>
<div id="modal-metronomo" class="modal">
  <div class="modal-content fade-apple">
    <button class="close-btn" onclick="cerrarMetronomo()">âœ–</button>

    <h3>ğŸ•’ MetrÃ³nomo</h3>

    <div class="metronome-ui">
      <div class="bpm-display">
        <span id="bpmValue">80</span> BPM
      </div>

      <input
        type="range"
        min="50"
        max="180"
        value="80"
        id="bpmSlider" />

      <div class="metro-buttons">
        <button id="metroToggle">â–¶ï¸ Start</button>
      </div>
    </div>
  </div>
</div>
</body>
</html>
