<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Repertorio Worship</title>
<style>
:root{
  --primary:#002244;--accent:#ff8c42;--bg:#f0f4f8;--text:#002244;
  --section-bg:#fff8e1;--card-bg:#ffffff;--edit-bg:#FFEB3B;
}
body.dark{--bg:#121212;--text:#f0f4f8;--card-bg:#1e1e1e;--section-bg:#2a2a2a;--edit-bg:#f9a825}
html,body{height:100%;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);transition:background .25s,color .25s}
header{background:var(--primary);color:#fff;padding:18px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:12px}
.logo img{height:56px;border-radius:8px}
.controls{display:flex;gap:8px;align-items:center}
button{background:var(--accent);color:#fff;border:0;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}
button:hover{transform:scale(1.03)}
main{max-width:900px;margin:18px auto;padding:12px}
.card{background:var(--card-bg);padding:14px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:16px}
.section{background:var(--section-bg);padding:14px;border-radius:10px;margin-bottom:16px}
.preview-img{max-width:350px;border-radius:8px;margin:8px 8px 0 0;display:inline-block;box-shadow:0 0 6px rgba(0,0,0,0.15)}
footer{text-align:center;margin-top:24px;padding:16px}
.counter-badge{background:rgba(0,0,0,0.06);padding:6px 12px;border-radius:10px;font-weight:700}
input,textarea{width:100%;padding:6px;margin:6px 0;border-radius:6px;border:1px solid #ccc}
</style>
</head>
<body>
<header>
  <div class="logo">
    <img src="logo.jpeg" alt="Logo">
    <h1>Repertorio Worship</h1>
  </div>
  <div class="controls">
    <button onclick="toggleDark()">üåô / ‚òÄÔ∏è</button>
    <button onclick="promptPin()">‚úèÔ∏è Editar</button>
    <button onclick="window.open('https://www.metronomeonline.com','_blank')">üïí Metr√≥nomo</button>
  </div>
</header>

<main>
  <!-- Secci√≥n Semana -->
  <div class="section">
    <h2>üé∂ Canciones para la semana</h2>
    <div id="editar-semana" style="display:none;">
      <input id="titulo-semana" placeholder="T√≠tulo (ej. Semana del 7 al 13)">
      <textarea id="canciones-semana" placeholder="Canciones (una por l√≠nea)"></textarea>
      <input type="file" id="imagenes-semana" multiple>
      <input type="file" id="audio-semana" accept="audio/*">
      <button onclick="guardarSeccion('semana')">Guardar</button>
    </div>
    <div id="mostrar-semana"></div>
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <button onclick="mostrarWorshipPack('semana')">üéµ Worship Pack</button>
      <button onclick="document.getElementById('worshipPackSemana').style.display = document.getElementById('worshipPackSemana').style.display === 'none' ? 'block' : 'none'">üîΩ Mostrar/ocultar</button>
    </div>
    <div id="worshipPackSemana" class="pack-contenedor" style="display:none;margin-top:10px"></div>
  </div>

  <!-- Secci√≥n Mes -->
  <div class="section">
    <h2>üÜï Canciones nuevas del mes</h2>
    <div id="editar-mes" style="display:none;">
      <input id="titulo-mes" placeholder="T√≠tulo (ej. Noviembre 2025)">
      <textarea id="canciones-mes" placeholder="Canciones (una por l√≠nea)"></textarea>
      <input type="file" id="imagenes-mes" multiple>
      <input type="file" id="audio-mes" accept="audio/*">
      <button onclick="guardarSeccion('mes')">Guardar</button>
    </div>
    <div id="mostrar-mes"></div>
    <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
      <button onclick="mostrarWorshipPack('mes')">üéµ Worship Pack</button>
      <button onclick="document.getElementById('worshipPackMes').style.display = document.getElementById('worshipPackMes').style.display === 'none' ? 'block' : 'none'">üîΩ Mostrar/ocultar</button>
    </div>
    <div id="worshipPackMes" class="pack-contenedor" style="display:none;margin-top:10px"></div>
  </div>

  <!-- Canciones -->
  <h2>üéµ Todas las canciones</h2>
  <div id="lista-canciones"></div>
  <div id="contador-final" class="counter-badge">Canciones totales üé∂: 0</div>
</main>

<footer>
  <button onclick="window.scrollTo({top:0, behavior:'smooth'})">‚¨ÜÔ∏è Volver arriba</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, doc, getDoc, onSnapshot, setDoc, addDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDahT6IuQwSYdpAMcPpAERpqVuobmqmVSQ",
  authDomain: "repertorioworship.firebaseapp.com",
  projectId: "repertorioworship",
  storageBucket: "repertorioworship.firebasestorage.app",
  messagingSenderId: "493050453266",
  appId: "1:493050453266:web:cf07ce9fbb471122f167cb"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let cancionesCache = [];
let modoEdicion = false;
const PIN_ADMIN = "1234"; // tu PIN de administrador

/* Utilidades UI */
function toggleDark(){document.body.classList.toggle("dark");}
function promptPin(){
  const pin = prompt("Ingresa el PIN de administrador:");
  if(pin===PIN_ADMIN){modoEdicion=true; document.getElementById("editar-semana").style.display="block"; document.getElementById("editar-mes").style.display="block"; alert("Modo edici√≥n activado");} 
  else alert("PIN incorrecto");
}

/* Normalizar t√≠tulos */
function normalizar(texto){ return texto ? texto.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim() : ""; }

/* Secciones */
async function guardarSeccion(tipo){
  const titulo = document.getElementById(`titulo-${tipo}`).value.trim();
  const canciones = document.getElementById(`canciones-${tipo}`).value.trim().split("\n").filter(Boolean);
  
  // subir archivos si existen
  let imagenes = [];
  const inputImgs = document.getElementById(`imagenes-${tipo}`);
  if(inputImgs && inputImgs.files.length>0){
    for(const file of inputImgs.files){
      const refImg = ref(storage, `imagenes/${tipo}/${file.name}`);
      await uploadBytes(refImg, file);
      const url = await getDownloadURL(refImg);
      imagenes.push(url);
    }
  }
  
  let audioUrl = "";
  const inputAudio = document.getElementById(`audio-${tipo}`);
  if(inputAudio && inputAudio.files.length>0){
    const file = inputAudio.files[0];
    const refAudio = ref(storage, `audios/${tipo}/${file.name}`);
    await uploadBytes(refAudio, file);
    audioUrl = await getDownloadURL(refAudio);
  }
  
  await setDoc(doc(db,"secciones",tipo), {titulo, canciones, imagenes, audio:audioUrl});
  cargarSeccion(tipo);
}

/* Cargar secciones */
async function cargarSeccion(tipo){
  const snap = await getDoc(doc(db,"secciones",tipo));
  const cont = document.getElementById(`mostrar-${tipo}`);
  if(!snap.exists()){ cont.innerHTML="<p>No hay informaci√≥n guardada.</p>"; return;}
  const data = snap.data();
  let html = `<h3>${data.titulo||""}</h3><ul>`;
  (data.canciones||[]).forEach(c => html+=`<li>${c}</li>`);
  html+="</ul>";
  if(data.imagenes) data.imagenes.forEach(img => html+=`<img src="${img}" class="preview-img">`);
  if(data.audio) html+=`<audio controls src="${data.audio}"></audio>`;
  cont.innerHTML = html;
}

/* Canciones */
function construirCard(c){
  const div = document.createElement("div");
  div.className="card";
  div.innerHTML=`
    <h3>${c.titulo}</h3>
    ${c.imagenes?(c.imagenes.map(img=>`<img src="${img}" class="preview-img">`).join("")):""}
    ${c.audio?`<audio controls src="${c.audio}"></audio>`:""}
    ${c.notas?`<p><strong>Notas:</strong> ${c.notas}</p>`:""}
  `;
  return div;
}
function cargarCanciones(){
  const cont = document.getElementById("lista-canciones");
  cont.innerHTML="";
  cancionesCache.forEach(c => cont.appendChild(construirCard(c)));
  document.getElementById("contador-final").textContent = `Canciones totales üé∂: ${cancionesCache.length}`;
}

/* Worship Pack */
async function mostrarWorshipPack(tipo){
  const contId = tipo==='semana'?'worshipPackSemana':'worshipPackMes';
  const cont = document.getElementById(contId);
  if(!cont) return;
  cont.innerHTML=""; cont.style.display='block';
  
  try{
    const snap = await getDoc(doc(db,"secciones",tipo));
    if(!snap.exists()){ cont.innerHTML="<p>No hay canciones guardadas en esta secci√≥n.</p>"; return;}
    const data = snap.data();
    const lista = Array.isArray(data.canciones)?data.canciones:[];
    
    const header = document.createElement('div');
    header.style.display="flex"; header.style.justifyContent="space-between"; header.style.marginBottom="8px";
    header.innerHTML=`<strong>${tipo==='semana'?'Worship Pack Semanal':'Worship Pack Mensual'} ‚Äî ${data.titulo||tipo}</strong>
      <button onclick="document.getElementById('${contId}').innerHTML='';document.getElementById('${contId}').style.display='none'">Cerrar</button>`;
    cont.appendChild(header);
    
    for(const nombre of lista){
      const encontrado = cancionesCache.find(c=>normalizar(c.titulo)===normalizar(nombre));
      if(encontrado){
        const card = construirCard(encontrado);
        const badge = document.createElement('div');
        badge.style.fontSize='0.85rem'; badge.style.marginBottom='6px';
        badge.innerHTML=`<span style="background:var(--accent);color:#fff;padding:4px 8px;border-radius:6px;font-weight:700">Worship Pack</span>`;
        card.insertBefore(badge,card.firstChild);
        cont.appendChild(card);
      } else {
        const ph = document.createElement("div");
        ph.className='card';
        ph.innerHTML=`<h3>${nombre}</h3><p><em>Esta canci√≥n no existe en la colecci√≥n "canciones". A√±√°dela (modo edici√≥n) para que se muestre con acordes, im√°genes y audio.</em></p>`;
        cont.appendChild(ph);
      }
    }
  } catch(err){ console.error(err); cont.innerHTML="<p>Error cargando worship pack (ver consola).</p>"; }
}

/* Inicializar */
function inicializarCanciones(){
  onSnapshot(collection(db,"canciones"), snap=>{
    cancionesCache = snap.docs.map(d=>({id:d.id,...d.data()}));
    cargarCanciones();
  });
  cargarSeccion("semana");
  cargarSeccion("mes");
}

/* Bind global */
window.toggleDark=toggleDark;
window.promptPin=promptPin;
window.guardarSeccion=guardarSeccion;
window.mostrarWorshipPack=mostrarWorshipPack;

inicializarCanciones();
</script>
</body>
</html>