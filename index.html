<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Repertorio Worship</title>
<style>
:root{
  --primary:#002244;--accent:#FF6F00;--bg:#f0f4f8;--text:#002244;
  --section-bg:#fff8e1;--card-bg:#ffffff;--edit-bg:#FFEB3B;
}
body.dark{--bg:#121212;--text:#f0f4f8;--card-bg:#1e1e1e;--section-bg:#2a2a2a;--edit-bg:#f9a825}
html,body{height:100%;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);transition:background .25s,color .25s}
header{background:var(--primary);color:#fff;padding:18px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:12px}
.logo img{height:56px;border-radius:8px}
.controls{display:flex;gap:8px;align-items:center}
button{background:var(--accent);color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
button:hover{transform:scale(1.03)}
main{max-width:900px;margin:18px auto;padding:12px}
.card{background:var(--card-bg);padding:14px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:16px}
.section{background:var(--section-bg);padding:14px;border-radius:10px;margin-bottom:16px}
input,textarea{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;background:transparent;color:inherit}
.search-container{position:relative;margin-bottom:16px}
#search{padding:14px 44px 14px 14px;border-radius:10px;border:2px solid var(--accent);font-size:1.05rem}
#clearSearch{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:var(--accent);font-size:1.2rem;display:none}
.link-btn{display:inline-block;background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none}
.edit-banner{position:sticky;top:0;background:var(--edit-bg);padding:8px;text-align:center;font-weight:bold;display:none;z-index:50}
footer{text-align:center;margin-top:24px;padding:16px;display:flex;flex-direction:column;gap:8px;align-items:center}
table{width:100%;border-collapse:collapse;margin-top:8px;font-family:'Segoe UI',sans-serif}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#003366;color:#fff}
tbody tr:nth-child(odd){background:#cce0ff}
tbody tr:nth-child(even){background:#e6f0ff}
.small{font-size:0.9rem;padding:6px 8px;border-radius:6px;margin-left:4px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);justify-content:center;align-items:center;z-index:100}
.modal-content{background:#fff;padding:20px;border-radius:12px;max-width:400px;width:90%;max-height:80%;overflow-y:auto;position:relative}
.modal-content h3{margin-top:0}
.modal-content button.close-btn{position:absolute;top:10px;right:10px;background:#ff4d4d;color:#fff;border:none;padding:4px 8px;border-radius:6px;cursor:pointer}
ul.fechas-lista{list-style:none;padding:0;margin:0;text-align:left}
.fechas-box{min-width:180px}
</style>
</head>
<body>
<div class="edit-banner">‚úèÔ∏è Modo edici√≥n activo</div>

<header>
  <div class="logo">
    <img src="https://raw.githubusercontent.com/Lifebygrace/Repertorio-worship/main/logo.jpeg" alt="Logo" />
    <h1>Repertorio Worship</h1>
  </div>
  <div class="controls">
    <button onclick="toggleDark()">üåô / ‚òÄÔ∏è</button>
    <button onclick="activarEdicion()">‚úèÔ∏è Editar</button>
    <button onclick="window.open('https://www.metronomeonline.com','_blank')">üïí Metr√≥nomo</button>
    <button id="toggleCancionesBtn" onclick="toggleCanciones()">üéµ Mostrar lista</button>
  </div>
</header>

<main>
  <div class="search-container">
    <input id="search" placeholder="üîç Buscar canciones por t√≠tulo..." />
    <button id="clearSearch">‚ùå</button>
  </div>

  <!-- Secciones -->
  <div class="section">
    <h2>üé∂ Canciones para la semana</h2>
    <div id="contenedor-semana" style="display:none;">
      <input id="titulo-semana" placeholder="T√≠tulo" />
      <textarea id="canciones-semana" placeholder="Canciones (una por l√≠nea)"></textarea>
      <button onclick="guardarSeccion('semana')">Guardar secci√≥n</button>
    </div>
    <div id="mostrar-semana" style="margin-top:8px"></div>
  </div>

  <div class="section">
    <h2>üÜï Canciones nuevas del mes</h2>
    <div id="contenedor-mes" style="display:none;">
      <input id="titulo-mes" placeholder="T√≠tulo" />
      <textarea id="canciones-mes" placeholder="Canciones (una por l√≠nea)"></textarea>
      <button onclick="guardarSeccion('mes')">Guardar secci√≥n</button>
    </div>
    <div id="mostrar-mes" style="margin-top:8px"></div>
  </div>

  <button id="btnAgregar" onclick="toggleFormulario()" style="display:none;">‚ûï Agregar nueva canci√≥n</button>

  <form id="formulario" onsubmit="event.preventDefault(); agregarCancion();" style="display:none;margin-top:12px;">
    <div class="card">
      <h2>Agregar canci√≥n</h2>
      <input id="titulo" placeholder="T√≠tulo de la canci√≥n" required />
      <textarea id="acordes" placeholder="Acordes..."></textarea>
      <textarea id="imagenes" placeholder="Links de im√°genes (uno por l√≠nea)"></textarea>
      <input id="audio" placeholder="Link de audio" />
      <input id="youtube" placeholder="Link de YouTube" />
      <button type="submit">Guardar canci√≥n</button>
    </div>
  </form>

  <div id="lista-canciones" style="display:none;"></div>

  <div id="registro-canciones" class="section" style="display:none;">
    <h2>üìã Registro de canciones</h2>
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
      <span>Ordenar por:</span>
      <button class="small" onclick="setOrden('titulo')">T√≠tulo</button>
      <button class="small" onclick="setOrden('veces')">Veces</button>
      <button class="small" onclick="setOrden('ultima')">√öltima</button>
    </div>
    <table id="tabla-registro">
      <thead>
        <tr><th>T√≠tulo</th><th>Veces tocada</th><th>√öltima fecha</th><th>Acci√≥n</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <footer>
    <p id="contador">üéµ Total de canciones: 0</p>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button onclick="window.scrollTo({top:0, behavior:'smooth'})">‚¨ÜÔ∏è Volver al inicio</button>
      <button onclick="toggleRegistro()">üìä Registro de canciones</button>
    </div>
  </footer>
</main>

<!-- Modal fechas -->
<div id="modal-fechas" class="modal">
  <div class="modal-content">
    <button class="close-btn" onclick="cerrarModal()">X</button>
    <h3>Fechas tocadas</h3>
    <ul id="lista-fechas"></ul>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

/* === Config === */
const firebaseConfig = {
  apiKey: "AIzaSyDahT6IuQwSYdpAMcPpAERpqVuobmqmVSQ",
  authDomain: "repertorioworship.firebaseapp.com",
  projectId: "repertorioworship",
  storageBucket: "repertorioworship.firebasestorage.app",
  messagingSenderId: "493050453266",
  appId: "1:493050453266:web:cf07ce9fbb471122f167cb",
  measurementId: "G-RB3G81DQQ1"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let modoEdicion = false;
let cancionesCache = [];
let registroCache = {};
let debounceTimer;
let cancionesVisible = false;
let ordenActual = {campo:'titulo', sentido:'desc'};

/* === Utilidades === */
function normalizar(text){ return (text||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(); }
function resaltar(text, q){ if(!q) return text; try{ const r=new RegExp(`(${q})`,"gi"); return text.replace(r,"<mark>$1</mark>"); }catch(e){return text;} }

/* === Canciones y UI === */
async function inicializarCanciones(){
  onSnapshot(collection(db, "canciones"), snapshot => {
    cancionesCache = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
    cargarCanciones();
    if(document.getElementById("registro-canciones").style.display==="block") cargarRegistro();
  });
}

async function cargarCanciones(){ /* Mantener tu l√≥gica existente */ }
async function agregarCancion(){ /* Mantener tu l√≥gica existente */ }
async function guardarEdicion(id, btn){ /* Mantener tu l√≥gica existente */ }

/* === Secciones === */
async function cargarSeccion(tipo){ /* Mantener tu l√≥gica existente */ }
async function guardarSeccion(tipo){ /* Mantener tu l√≥gica existente */ }

/* === Modo edici√≥n === */
function activarEdicion(){ /* Mantener tu l√≥gica existente */ }

/* === B√∫squeda === */
function debounceBuscar(){ clearTimeout(debounceTimer); debounceTimer=setTimeout(cargarCanciones,300); }

/* === Toggles UI === */
function toggleDark(){ document.body.classList.toggle("dark"); localStorage.setItem("theme",document.body.classList.contains("dark")?"dark":"light"); }
function toggleFormulario(){ const f=document.getElementById("formulario"); f.style.display=f.style.display==="none"?"block":"none"; }
function toggleCanciones(){ cancionesVisible=!cancionesVisible; document.getElementById("toggleCancionesBtn").textContent=cancionesVisible?"üéµ Ocultar lista":"üéµ Mostrar lista"; cargarCanciones(); }
function toggleRegistro(){ const el=document.getElementById("registro-canciones"); el.style.display=el.style.display==="block"?"none":"block"; if(el.style.display==="block") cargarRegistro(); }

/* === Registro de canciones === */
async function cargarRegistro(){
  registroCache={};
  const snap=await getDocs(collection(db,"registro"));
  snap.forEach(d=>{ registroCache[d.id]=d.data(); });

  const combinado=cancionesCache.map(c=>{
    const r=registroCache[c.id]||{veces:0,fechas:[]};
    return {id:c.id,titulo:c.titulo||"Sin t√≠tulo",veces:Number(r.veces||0),fechas:Array.isArray(r.fechas)?r.fechas:[]};
  });

  combinado.sort((a,b)=>{
    const campo=ordenActual.campo; const sentido=ordenActual.sentido==="asc"?1:-1;
    if(campo==="veces") return (a.veces-b.veces)*sentido;
    if(campo==="ultima"){ const da=a.fechas.length?Date.parse(a.fechas[a.fechas.length-1]):0; const dbt=b.fechas.length?Date.parse(b.fechas[b.fechas.length-1]):0; return (da-dbt)*sentido; }
    return a.titulo.localeCompare(b.titulo)*sentido;
  });

  const tbody=document.querySelector("#tabla-registro tbody");
  tbody.innerHTML="";
  combinado.forEach(r=>{
    let fechasHtml="";
    if(r.fechas.length>0){ fechasHtml=`<span>${r.fechas[r.fechas.length-1]}</span>`; if(r.fechas.length>1) fechasHtml+=` <button class="small" onclick="mostrarModal('${r.id}')">Ver m√°s</button>`;}
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td style="text-align:left">${r.titulo}</td>
      <td contenteditable="${modoEdicion}">${r.veces}</td>
      <td>${fechasHtml}${modoEdicion?`<div style="margin-top:6px"><button class="small" onclick="agregarFecha('${r.id}')">‚ûï A√±adir fecha (hoy)</button></div>`:""}</td>
      <td>${modoEdicion?`<button onclick="borrarRegistro('${r.id}')">üóëÔ∏è Borrar registro</button> <button onclick="guardarRegistro('${r.id}',this)">üíæ Guardar</button>`:""}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* === Modal fechas === */
function mostrarModal(id){
  const ul=document.getElementById("lista-fechas");
  ul.innerHTML="";
  const data=registroCache[id];
  if(data && Array.isArray(data.fechas)){ data.fechas.forEach(f=>{ const li=document.createElement("li"); li.textContent=f; ul.appendChild(li); }); }
  document.getElementById("modal-fechas").style.display="flex";
}
function cerrarModal(){ document.getElementById("modal-fechas").style.display="none"; }

/* === Fechas / CRUD registro === */
async function agregarFecha(id,fecha){ const hoy=fecha?fecha:new Date().toISOString().split("T")[0]; const ref=doc(db,"registro",id); const snap=await getDoc(ref); const data=snap.exists()?snap.data():{veces:0,fechas:[]}; const nuevas=Array.isArray(data.fechas)?[...data.fechas,hoy]:[hoy]; await setDoc(ref,{veces:(Number(data.veces)||0)+1,fechas:nuevas}); await cargarRegistro(); }
async function borrarRegistro(id){ if(!confirm("¬øSeguro que quieres borrar el registro completo?")) return; await setDoc(doc(db,"registro",id),{veces:0,fechas:[]}); await cargarRegistro(); }
async function borrarFecha(id,index){ if(!confirm("Borrar esta fecha del historial?")) return; const ref=doc(db,"registro",id); const snap=await getDoc(ref); if(!snap.exists()) return; const data=snap.data(); const nuevas=Array.isArray(data.fechas)?data.fechas.filter((_,i)=>i!==index):[]; await setDoc(ref,{veces:nuevas.length,fechas:nuevas}); await cargarRegistro(); }
async function guardarRegistro(id,btn){ const row=btn.closest("tr"); const veces=parseInt(row.querySelectorAll("td")[1].innerText.trim())||0; const ref=doc(db,"registro",id); const snap=await getDoc(ref); const data=snap.exists()?snap.data():{fechas:[]}; await setDoc(ref,{veces,fechas:Array.isArray(data.fechas)?data.fechas:[]}); alert("‚úÖ Registro guardado"); await cargarRegistro(); }

/* === Ordenaci√≥n === */
function setOrden(campo){ if(ordenActual.campo===campo) ordenActual.sentido=ordenActual.sentido==="asc"?"desc":"asc"; else {ordenActual.campo=campo;ordenActual.sentido='desc';} cargarRegistro(); }

/* === Boot / EventListeners === */
window.addEventListener('load',()=>{
  if(localStorage.getItem("theme")==="dark") document.body.classList.add("dark");

  const searchInput=document.getElementById("search");
  const clearBtn=document.getElementById("clearSearch");
  searchInput.addEventListener("input",()=>{ clearTimeout(debounceTimer); debounceTimer=setTimeout(cargarCanciones,300); clearBtn.style.display=searchInput.value?"block":"none"; });
  clearBtn.addEventListener("click",()=>{ searchInput.value=""; clearBtn.style.display="none"; cargarCanciones(); });

  inicializarCanciones();
  cargarSeccion("semana");
  cargarSeccion("mes");

  // Exponer funciones
  window.agregarCancion=agregarCancion;
  window.guardarEdicion=guardarEdicion;
  window.toggleDark=toggleDark;
  window.toggleFormulario=toggleFormulario;
  window.activarEdicion=activarEdicion;
  window.guardarSeccion=guardarSeccion;
  window.toggleCanciones=toggleCanciones;
  window.toggleRegistro=toggleRegistro;
  window.agregarFecha=agregarFecha;
  window.borrarFecha=borrarFecha;
  window.guardarRegistro=guardarRegistro;
  window.borrarRegistro=borrarRegistro;
  window.setOrden=setOrden;
  window.mostrarModal=mostrarModal;
  window.cerrarModal=cerrarModal;
});
</script>
</body>
</html>