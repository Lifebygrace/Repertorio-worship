<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Repertorio Worship</title>
<style>
:root {
  --primary: #002244;
  --accent: #FF6F00;
  --bg: #f0f4f8;
  --text: #002244;
  --section-bg: #fff8e1;
  --card-bg: #ffffff;
  --edit-bg: #FFEB3B;
}
body.dark {
  --bg: #121212;
  --text: #f0f4f8;
  --card-bg: #1e1e1e;
  --section-bg: #2a2a2a;
  --edit-bg: #f9a825;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;height:100%;font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);transition:background .3s,color .3s}
header{background:var(--primary);color:#fff;width:100vw;box-sizing:border-box;padding:20px 22px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px;min-height:80px}
.logo{display:flex;align-items:center;gap:10px}
.logo img{height:60px;border-radius:8px}
.controls{display:flex;align-items:center;gap:6px;flex-wrap:nowrap}
button{background-color:var(--accent);color:white;border:none;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:bold;font-size:.85em;transition:background .2s,transform .1s;white-space:nowrap}
button:hover{background-color:#e65e00;transform:scale(1.03)}
main{max-width:900px;margin:auto;padding:16px}
.card{background:var(--card-bg);padding:16px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:20px}
.section{background:var(--section-bg);padding:16px;border-radius:10px;margin-bottom:20px}
#proximo-domingo ul,#historial ul{padding-left:20px}
input,textarea{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;background:var(--bg);color:var(--text)}
.edit-banner{position:sticky;top:0;background:var(--edit-bg);text-align:center;font-weight:bold;padding:8px;display:none;z-index:100}
.nota{font-size:.85em;color:#333}
.week-card{border-radius:10px;padding:10px;margin:8px 0;background:rgba(255,255,255,.9);box-shadow:0 1px 3px rgba(0,0,0,.06)}
.week-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
.small{font-size:.9em;padding:6px 8px;border-radius:8px}
.mark-played{background:#4caf50}
.bad{background:#e53935}
.footer-row{display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;margin-top:8px}
.note-small{font-size:.9em;color:#555}
.search-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
#lista-mes{display:none}
</style>
</head>
<body>
  <div class="edit-banner">‚úèÔ∏è Modo edici√≥n activo</div>

  <header>
    <div class="logo">
      <img src="https://raw.githubusercontent.com/Lifebygrace/Repertorio-worship/main/logo.jpeg" alt="Logo Repertorio Worship" />
      <h1>Repertorio Worship</h1>
    </div>
    <div class="controls">
      <button id="themeBtn">üåô / ‚òÄÔ∏è</button>
      <button id="editBtn">‚úèÔ∏è Editar</button>
      <button onclick="window.open('https://www.metronomeonline.com','_blank')">üïí Metr√≥nomo</button>
      <button id="toggleListaBtn">üéµ Mostrar lista</button>
    </div>
  </header>

  <main>
    <section class="card section">
      <h2>üéµ Pr√≥ximo domingo</h2>
      <div id="proximo-domingo" class="card"></div>
    </section>

    <section class="card section">
      <h2>üóìÔ∏è Repertorio mensual (crear/editar semanas)</h2>

      <div style="margin-bottom:8px;" class="search-row">
        <label style="display:flex;align-items:center;gap:8px;">
          Mes:
          <input type="month" id="select-month" />
        </label>
        <div class="note-small">Selecciona un mes para ver/editar las semanas de ese mes</div>
      </div>

      <div id="editor-mes" style="display:none;">
        <p><strong>Agregar / actualizar semana (fecha del domingo)</strong></p>
        <label>Fecha (domingo): <input type="date" id="input-fecha" /></label>
        <label>Canciones (una por l√≠nea):</label>
        <textarea id="input-canciones" placeholder="T√≠tulo de la canci√≥n ‚Äî una por l√≠nea"></textarea>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="btnGuardarSemana">üíæ Guardar semana</button>
          <button id="btnEliminarSemana">üóëÔ∏è Eliminar semana</button>
          <button id="btnCrearMes" title="Crea todos los domingos del mes como semanas vac√≠as">üóìÔ∏è Crear semanas del mes</button>
        </div>
        <p class="nota">La fecha debe corresponder a un domingo. El PIN requerido para editar es <strong>2025</strong>.</p>
      </div>

      <div id="lista-mes"></div>
    </section>

    <section class="card section">
      <h2>üìú Historial de domingos anteriores</h2>
      <div id="historial"></div>
    </section>

    <footer>
      <div class="footer-row">
        <p id="contador">üéµ Total de semanas guardadas: 0</p>
        <div>
          <button onclick="window.scrollTo({top:0, behavior:'smooth'})">‚¨ÜÔ∏è Volver al inicio</button>
        </div>
      </div>
    </footer>
  </main>

<!-- Firebase + App script -->
<script type="module">
/* ==========================
   App integrado (un archivo)
   ========================== */

import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore, collection, doc, setDoc, getDoc, getDocs,
  query, where, orderBy, addDoc, serverTimestamp, deleteDoc
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

/* ---------- CONFIG FIREBASE (usa tu config actual) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyDahT6IuQwSYdpAMcPpAERpqVuobmqmVSQ",
  authDomain: "repertorioworship.firebaseapp.com",
  projectId: "repertorioworship",
  storageBucket: "repertorioworship.appspot.com",
  messagingSenderId: "493050453266",
  appId: "1:493050453266:web:cf07ce9fbb471122f167cb"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- UTILIDADES DE FECHA ---------- */
function formatDateISO(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth()+1).padStart(2,'0');
  const d = String(date.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}
function getLastSundayISO() {
  const d = new Date();
  const diff = (d.getDay() + 7 - 0) % 7; // 0 = Sunday
  d.setDate(d.getDate() - diff);
  return formatDateISO(d);
}
function getNextSundayISO() {
  const d = new Date();
  const daysUntilNextSunday = ((7 - d.getDay()) % 7) || 7;
  d.setDate(d.getDate() + daysUntilNextSunday);
  return formatDateISO(d);
}
function isMondayLocal() { return (new Date()).getDay() === 1; }
function monthKeyFromISO(isoDate) { return isoDate.slice(0,7); } // YYYY-MM
function escapeHtml(str){
  return String(str || '').replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s]));
}

/* ---------- ELEMENTOS UI ---------- */
const proximoDiv = document.getElementById('proximo-domingo');
const listaMesDiv = document.getElementById('lista-mes');
const historialDiv = document.getElementById('historial');
const contadorEl = document.getElementById('contador');

const editBanner = document.querySelector('.edit-banner');
const editorMes = document.getElementById('editor-mes');
const btnGuardarSemana = document.getElementById('btnGuardarSemana');
const btnEliminarSemana = document.getElementById('btnEliminarSemana');
const btnCrearMes = document.getElementById('btnCrearMes');
const inputFecha = document.getElementById('input-fecha');
const inputCanciones = document.getElementById('input-canciones');
const editBtn = document.getElementById('editBtn');
const themeBtn = document.getElementById('themeBtn');
const toggleListaBtn = document.getElementById('toggleListaBtn');
const selectMonth = document.getElementById('select-month');

let modoEdicion = false;
let semanasCache = [];
let mostrarLista = false;

/* ---------- Firestore - operaciones ---------- */
// Colecci√≥n 'semanas' (id = 'YYYY-MM-DD') y 'registro' (id = 'YYYY-MM-DD')

async function guardarSemana(dateISO, cancionesArr) {
  if (!dateISO) throw new Error('Fecha vac√≠a');
  const d = new Date(dateISO + 'T00:00:00');
  if (d.getDay() !== 0) throw new Error('La fecha seleccionada no es domingo');
  const docRef = doc(db, 'semanas', dateISO);
  await setDoc(docRef, {
    date: dateISO,
    monthKey: monthKeyFromISO(dateISO),
    canciones: cancionesArr,
    createdBy: 'web-editor',
    createdAt: serverTimestamp()
  }, { merge: true });
}

async function eliminarSemana(dateISO) {
  await deleteDoc(doc(db, 'semanas', dateISO));
}

async function cargarSemanasDeMes(monthKey) {
  const q = query(collection(db, 'semanas'), where('monthKey', '==', monthKey), orderBy('date', 'asc'));
  const snap = await getDocs(q);
  const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  semanasCache = arr;
  renderListaMes(arr, monthKey);
  contadorEl.textContent = `üéµ Total de semanas guardadas: ${arr.length}`;
}

function renderListaMes(arr, monthKey) {
  if (!arr.length) {
    listaMesDiv.innerHTML = `<p>No hay semanas guardadas para <strong>${monthKey}</strong>.</p>`;
    return;
  }
  listaMesDiv.innerHTML = arr.map(w => {
    const cancionesHtml = (w.canciones || []).map(c => `<li>${escapeHtml(c)}</li>`).join('');
    const playedTag = w.played ? `<span class="small mark-played">Tocada</span>` : '';
    return `
      <div class="week-card">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <strong>${w.date}</strong>
          <div>${playedTag}</div>
        </div>
        <ul>${cancionesHtml}</ul>
        <div class="week-controls">
          <button class="small" data-edit="${w.date}">‚úèÔ∏è Editar</button>
          <button class="small" data-copy="${w.date}">üìã Copiar</button>
        </div>
      </div>
    `;
  }).join('');
  // listeners
  listaMesDiv.querySelectorAll('[data-edit]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const date = e.currentTarget.dataset.edit;
      const week = semanasCache.find(s=>s.date===date);
      if(!week) return;
      inputFecha.value = week.date;
      inputCanciones.value = (week.canciones || []).join('\n');
      editorMes.scrollIntoView({behavior:'smooth'});
    });
  });
  listaMesDiv.querySelectorAll('[data-copy]').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const date = e.currentTarget.dataset.copy;
      const week = semanasCache.find(s=>s.date===date);
      if(!week) return;
      try {
        await navigator.clipboard.writeText((week.canciones||[]).join('\n'));
        alert('‚úÖ Canciones copiadas al portapapeles');
      } catch(e){ alert('‚ùå No se pudo copiar.'); }
    });
  });
}

/* ---------- Pr√≥ximo domingo: mostrar y acciones ---------- */
async function mostrarProximoDomingo() {
  const next = getNextSundayISO();
  const semanaSnap = await getDoc(doc(db, 'semanas', next));
  if (!semanaSnap.exists()) {
    proximoDiv.innerHTML = `<p>No hay repertorio creado para el pr√≥ximo domingo (${next}).</p>
      ${modoEdicion ? `<p>Puedes crear la semana con fecha ${next} desde el panel de edici√≥n.</p>` : ''}`;
    return;
  }
  const data = semanaSnap.data();
  const cancionesHtml = (data.canciones || []).map(c => `<li>${escapeHtml(c)}</li>`).join('');
  proximoDiv.innerHTML = `
    <h3>${data.date}</h3>
    <ul>${cancionesHtml}</ul>
    <div style="margin-top:10px">
      ${modoEdicion ? `<button id="editarProximo" class="small">‚úèÔ∏è Editar pr√≥ximo domingo</button>` : ''}
      <button id="marcarTocado" class="small">‚úÖ Marcar como tocado (mover a historial)</button>
    </div>
  `;
  const editarBtn = document.getElementById('editarProximo');
  if (editarBtn) {
    editarBtn.addEventListener('click', ()=>{
      inputFecha.value = data.date;
      inputCanciones.value = (data.canciones || []).join('\n');
      editorMes.scrollIntoView({behavior:'smooth'});
    });
  }
  document.getElementById('marcarTocado').addEventListener('click', async ()=>{
    const confirmMsg = confirm('¬øConfirmas que este repertorio se toc√≥ y quieres guardarlo en el historial?');
    if(!confirmMsg) return;
    await registrarDomingoPasadoManual(data.date);
    await refreshAll();
  });
}

/* ---------- Historial ---------- */
async function cargarHistorial() {
  const q = query(collection(db, 'registro'), orderBy('fecha', 'desc'));
  const snap = await getDocs(q);
  const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
  historialDiv.innerHTML = arr.length ? arr.map(r => {
    const cancionesHtml = (r.canciones || []).map(c => `<li>${escapeHtml(c)}</li>`).join('');
    return `<div class="week-card"><strong>${r.fecha}</strong><ul>${cancionesHtml}</ul></div>`;
  }).join('') : '<p>No hay registros a√∫n.</p>';
}

/* ---------- Registro autom√°tico (lunes) ---------- */
async function registrarDomingoPasado() {
  if (!isMondayLocal()) return;
  const last = getLastSundayISO();
  const regDoc = await getDoc(doc(db, 'registro', last));
  if (regDoc.exists()) return;
  const semanaSnap = await getDoc(doc(db, 'semanas', last));
  if (!semanaSnap.exists()) return;
  const data = semanaSnap.data();
  await setDoc(doc(db, 'registro', last), {
    fecha: last,
    canciones: data.canciones || [],
    creadoEn: serverTimestamp()
  });
  await setDoc(doc(db, 'semanas', last), { played: true }, { merge: true });
  console.log('‚úÖ Domingo pasado registrado autom√°ticamente:', last);
}

async function registrarDomingoPasadoManual(dateISO) {
  const last = dateISO;
  const regDoc = await getDoc(doc(db, 'registro', last));
  if (regDoc.exists()) {
    alert('Ya existe un registro para esa fecha.');
    return;
  }
  const semanaSnap = await getDoc(doc(db, 'semanas', last));
  if (!semanaSnap.exists()) { alert('No existe la semana seleccionada.'); return; }
  const data = semanaSnap.data();
  await setDoc(doc(db, 'registro', last), {
    fecha: last,
    canciones: data.canciones || [],
    creadoEn: serverTimestamp()
  });
  await setDoc(doc(db, 'semanas', last), { played: true }, { merge: true });
  alert('‚úÖ Registrado en historial.');
}

/* ---------- Botones y eventos UI ---------- */
editBtn.addEventListener('click', ()=> {
  if (!modoEdicion) {
    const pin = prompt('Introduce el PIN para editar:');
    if (pin === '2025') {
      modoEdicion = true;
      editBanner.style.display = 'block';
      editorMes.style.display = 'block';
      editBtn.textContent = 'üîí Salir edici√≥n';
      refreshAll();
      alert('‚úèÔ∏è Modo edici√≥n activado');
    } else if (pin) {
      alert('PIN incorrecto');
    }
  } else {
    modoEdicion = false;
    editBanner.style.display = 'none';
    editorMes.style.display = 'none';
    editBtn.textContent = '‚úèÔ∏è Editar';
    refreshAll();
  }
});

themeBtn.addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  const saved = document.body.classList.contains('dark') ? 'dark' : 'light';
  localStorage.setItem('theme', saved);
});

btnGuardarSemana.addEventListener('click', async ()=>{
  try {
    const dateISO = inputFecha.value;
    const cancionesArr = inputCanciones.value.split('\n').map(s=>s.trim()).filter(Boolean);
    if(!dateISO) return alert('Selecciona la fecha del domingo');
    const d = new Date(dateISO + 'T00:00:00');
    if (d.getDay() !== 0) return alert('La fecha seleccionada debe ser un domingo');
    await guardarSemana(dateISO, cancionesArr);
    alert('‚úÖ Semana guardada');
    inputFecha.value = '';
    inputCanciones.value = '';
    await cargarSemanasDeMes(monthKeyFromISO(dateISO));
    await refreshAll();
  } catch(e) {
    alert('‚ùå Error: ' + (e.message || e));
  }
});

btnEliminarSemana.addEventListener('click', async ()=>{
  const fecha = inputFecha.value;
  if(!fecha) return alert('Selecciona la semana para eliminar');
  if (!confirm('¬øEliminar la semana ' + fecha + ' ? Esta acci√≥n quitar√° el documento semana.')) return;
  await eliminarSemana(fecha);
  alert('üóëÔ∏è Semana eliminada');
  inputFecha.value = '';
  inputCanciones.value = '';
  await cargarSemanasDeMes(monthKeyFromISO(fecha));
  await refreshAll();
});

// Toggle visible lista mensual
toggleListaBtn.addEventListener('click', ()=>{
  mostrarLista = !mostrarLista;
  toggleListaBtn.textContent = mostrarLista ? 'üéµ Ocultar lista' : 'üéµ Mostrar lista';
  document.getElementById('lista-mes').style.display = mostrarLista ? 'block' : 'none';
});

// Select month change
selectMonth.addEventListener('change', async (e)=>{
  const val = e.target.value; // "YYYY-MM"
  if (!val) return;
  await cargarSemanasDeMes(val);
  // mostrar lista autom√°ticamente
  mostrarLista = true;
  document.getElementById('lista-mes').style.display = 'block';
  toggleListaBtn.textContent = mostrarLista ? 'üéµ Ocultar lista' : 'üéµ Mostrar lista';
});

// Crear todas las semanas (domingos) del mes seleccionado como documentos vac√≠os
btnCrearMes.addEventListener('click', async ()=>{
  if (!modoEdicion) return alert('Activa el modo edici√≥n para crear semanas del mes.');
  const month = selectMonth.value;
  if (!month) return alert('Selecciona un mes primero.');
  const [y, m] = month.split('-').map(Number);
  const generated = [];
  const d = new Date(y, m-1, 1);
  while (d.getMonth() === (m-1)) {
    if (d.getDay() === 0) { // domingo
      const iso = formatDateISO(d);
      generated.push(iso);
    }
    d.setDate(d.getDate() + 1);
  }
  if (!generated.length) return alert('No se encontraron domingos en ese mes (imposible).');
  const confirmMsg = confirm(`Se crear√°n ${generated.length} semanas (domingos) para ${month}. ¬øContinuar?`);
  if (!confirmMsg) return;
  try {
    for (const iso of generated) {
      // crea semana s√≥lo si no existe
      const snap = await getDoc(doc(db, 'semanas', iso));
      if (!snap.exists()) {
        await guardarSemana(iso, []);
      }
    }
    alert('‚úÖ Semanas del mes creadas (las que faltaban).');
    await cargarSemanasDeMes(month);
    await refreshAll();
  } catch(e) {
    alert('‚ùå Error creando semanas: ' + (e.message || e));
  }
});

/* ---------- Refresh general ---------- */
async function refreshAll() {
  await mostrarProximoDomingo();
  await cargarHistorial();
  const today = new Date();
  const currentMonthKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
  // if a month is selected, load that instead
  const selected = selectMonth.value || currentMonthKey;
  await cargarSemanasDeMes(selected);
}

/* ---------- Inicializaci√≥n al cargar la p√°gina ---------- */
window.addEventListener('load', async () => {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') document.body.classList.add('dark');

  // Si hoy es lunes, intentar registrar el domingo pasado (autom√°tico)
  try {
    if (isMondayLocal()) {
      await registrarDomingoPasado();
    }
  } catch(e){ console.error('Error al registrar domingo autom√°ticamente:', e); }

  // colocar month selector al mes actual por defecto
  const today = new Date();
  const ym = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
  selectMonth.value = ym;

  await refreshAll();
});

/* ---------- Helpers Firestore missing imports (getDoc used inside) ---------- */
/* We import getDoc lazily here to avoid reimport lines at top (but keep modular). */
import { getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

</script>
</body>
</html>