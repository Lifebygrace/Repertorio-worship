<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Repertorio Worship</title>
<style>
:root{
  --primary:#002244;--accent:#ff8c42;--bg:#f0f4f8;--text:#002244;
  --section-bg:#fff8e1;--card-bg:#ffffff;--edit-bg:#FFEB3B;
}
body.dark{--bg:#121212;--text:#f0f4f8;--card-bg:#1e1e1e;--section-bg:#2a2a2a;--edit-bg:#f9a825}
html,body{height:100%;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);transition:background .25s,color .25s}
header{background:var(--primary);color:#fff;padding:18px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:12px}
.logo img{height:56px;border-radius:8px}
.controls{display:flex;gap:8px;align-items:center}
button{background:var(--accent);color:#fff;border:0;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}
button:hover{transform:scale(1.03)}
main{max-width:900px;margin:18px auto;padding:12px}
.card{background:var(--card-bg);padding:14px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:16px}
.section{background:var(--section-bg);padding:14px;border-radius:10px;margin-bottom:16px}
input[type="text"],textarea,input[type="date"]{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;background:transparent;color:inherit}
.search-container{position:relative;margin-bottom:16px}
#search{padding:14px 44px 14px 14px;border-radius:10px;border:2px solid var(--accent);font-size:1.05rem}
#clearSearch{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:var(--accent);font-size:1.2rem;display:none}
.link-btn{display:inline-block;background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none}
.edit-banner{position:sticky;top:0;background:var(--edit-bg);padding:8px;text-align:center;font-weight:bold;display:none;z-index:50}
footer{text-align:center;margin-top:24px;padding:16px;display:flex;flex-direction:column;align-items:center;gap:10px;flex-wrap:wrap}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:var(--accent);color:#fff;cursor:pointer}
ul.fechas-lista{list-style:none;padding:0;margin:0;text-align:left}
.fechas-box{min-width:180px}
.small {font-size:0.8rem;padding:4px 6px;border-radius:6px;margin-left:2px}
.meta-line{font-size:0.9rem;color:#555;display:flex;gap:10px;align-items:center;margin-top:6px}
.meta-line .plays, .meta-line .last{display:inline-block}
.tocada-btn{background:#0077cc;padding:6px 8px;border-radius:6px;color:#fff;border:0;cursor:pointer;font-weight:700}
.tocada-btn:hover{opacity:0.95}
.counter-badge{background:rgba(0,0,0,0.06);padding:6px 12px;border-radius:10px;font-weight:700}
.preview-img {
  max-width: 350px;
  border-radius: 8px;
  margin: 8px 8px 0 0;
  display: inline-block;
  box-shadow: 0 0 6px rgba(0,0,0,0.15);
}
.th-sortable{position:relative}
.th-sortable .sort-ind{font-size:0.9rem;opacity:0.9;margin-left:6px}
.edit-input{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;background:transparent;color:inherit;margin-bottom:8px}
.clear-btn { background-color: #e74c3c !important; color: white !important; border: none !important; border-radius: 6px !important; padding: 6px 12px !important; cursor: pointer !important; font-size: 14px !important; font-weight: bold !important; transition: background-color 0.2s ease, transform 0.1s ease !important; }
.clear-btn:hover { background-color: #c0392b; transform: scale(1.1); }
.clear-btn:active { transform: scale(0.95); }
.delete-btn { background-color: #e74c3c; color: white; border: none; border-radius: 6px; padding: 6px 12px; cursor: pointer; font-weight: bold; transition: background-color 0.2s ease, transform 0.1s ease; }
.delete-btn:hover { background-color: #c0392b; transform: scale(1.05); }
.delete-btn:active { transform: scale(0.95); }
</style>
</head>
<body>
<div class="edit-banner">‚úèÔ∏è Modo edici√≥n activo</div>

<header>
  <div class="logo">
    <img src="https://raw.githubusercontent.com/Lifebygrace/Repertorio-worship/main/logo.jpeg" alt="Logo" />
    <h1 style="margin:0">Repertorio Worship</h1>
  </div>
  <div class="controls">
    <button onclick="toggleDark()">üåô / ‚òÄÔ∏è</button>
    <button onclick="activarEdicion()">‚úèÔ∏è Editar</button>
    <button onclick="window.open('https://www.metronomeonline.com','_blank')">üïí Metr√≥nomo</button>
    <button id="toggleCancionesBtn" onclick="toggleCanciones()">üéµ Mostrar lista</button>
    <button id="btnWorshipPack" onclick="toggleWorshipPack()">üéÅ Worship Pack</button>
  </div>
</header>

<main>
  <div class="search-container">
    <input id="search" placeholder="üîç Buscar canciones por t√≠tulo..." />
    <button id="clearSearch" class="clear-btn">‚úÇÔ∏èborrar‚ùå</button>
  </div>

  <!-- Secci√≥n semana -->
  <div class="section">
    <h2>üé∂ Canciones para la semana</h2>
    <div id="contenedor-semana" style="display:none;">
      <input id="titulo-semana" placeholder="T√≠tulo (ej. Semana del 7 al 13 de octubre)" />
      <textarea id="canciones-semana" placeholder="Canciones (una por l√≠nea)"></textarea>
      <button onclick="guardarSeccion('semana')">Guardar secci√≥n</button>
    </div>
    <div id="mostrar-semana" style="margin-top:8px"></div>
  </div>

  <!-- Secci√≥n Worship Pack editable -->
  <div class="section">
    <h2>üéÅ Worship Pack</h2>
    <div id="contenedor-worshippack" style="display:none;">
      <input id="titulo-worshippack" placeholder="T√≠tulo del Worship Pack (ej. Ensayo 15 Noviembre)" />
      <textarea id="canciones-worshippack" placeholder="Canciones (una por l√≠nea)"></textarea>
      <button onclick="guardarSeccion('worshippack')">Guardar Worship Pack</button>
    </div>
    <div id="worshipPackContainer" style="display:none; margin-top:12px;"></div>
    <div id="mostrar-worshippack" style="margin-top:8px"></div>
  </div>

  <!-- Secci√≥n canciones nuevas del mes -->
  <div class="section">
    <h2>üÜï Canciones nuevas del mes</h2>
    <div id="contenedor-mes" style="display:none;">
      <input id="titulo-mes" placeholder="T√≠tulo (ej. Octubre 2025)" />
      <textarea id="canciones-mes" placeholder="Canciones (una por l√≠nea)"></textarea>
      <button onclick="guardarSeccion('mes')">Guardar secci√≥n</button>
    </div>
    <div id="mostrar-mes" style="margin-top:8px"></div>
  </div>

  <button id="btnAgregar" onclick="toggleFormulario()" style="display:none;">‚ûï Agregar nueva canci√≥n</button>

  <form id="formulario" onsubmit="event.preventDefault(); agregarCancion();" style="display:none;margin-top:12px;">
    <div class="card">
      <h2>Agregar canci√≥n</h2>
      <input id="titulo" placeholder="T√≠tulo de la canci√≥n" required class="edit-input" />
      <textarea id="acordes" placeholder="Acordes..." class="edit-input"></textarea>
      <textarea id="imagenes" placeholder="Links de im√°genes (uno por l√≠nea)" class="edit-input"></textarea>
      <input id="audio" placeholder="Link de audio" class="edit-input" />
      <input id="youtube" placeholder="Link de YouTube" class="edit-input" />
      <button type="submit">Guardar canci√≥n</button>
    </div>
  </form>

  <div id="lista-canciones" style="display:none;margin-top:12px;"></div>

  <!-- Registro de canciones -->
  <div id="registro-canciones-container" style="margin-top:12px;">
    <button style="background:var(--accent);" onclick="toggleRegistro()">üìä Registro de canciones</button>
    <div id="registro-canciones" class="section" style="display:none;">
      <h2>üìã Registro de canciones</h2>
      <table id="tabla-registro">
        <thead>
          <tr>
            <th class="th-sortable" onclick="setOrden('titulo')">T√≠tulo <span class="sort-ind" id="sortTitulo"></span></th>
            <th class="th-sortable" onclick="setOrden('veces')">Veces tocada <span class="sort-ind" id="sortVeces"></span></th>
            <th class="th-sortable" onclick="setOrden('ultima')">√öltima fecha <span class="sort-ind" id="sortUltima"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<footer>
  <div id="contador-final" class="counter-badge">Canciones totales üé∂: 0</div>
  <button onclick="window.scrollTo({top:0, behavior:'smooth'})">‚¨ÜÔ∏è Volver al inicio</button>
</footer>

<script type="module">
// Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc, onSnapshot, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDahT6IuQwSYdpAMcPpAERpqVuobmqmVSQ",
  authDomain: "repertorioworship.firebaseapp.com",
  projectId: "repertorioworship",
  storageBucket: "repertorioworship.firebasestorage.app",
  messagingSenderId: "493050453266",
  appId: "1:493050453266:web:cf07ce9fbb471122f167cb"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* Estado */
let modoEdicion = false;
let cancionesCache = [];
let debounceTimer;
let cancionesVisible = false;
let ordenActual = { campo: 'titulo', sentido: 'desc' };

/* Utilidades */
function normalizar(t){ return (t||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase(); }
function resaltar(t,q){ if(!q) return t; try{ const r=new RegExp(`(${q})`,"gi"); return t.replace(r,"<mark>$1</mark>"); }catch(e){return t;} }
function pad(n){ return String(n).padStart(2,'0'); }
function isoToday(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function isoToDisplay(iso){ if(!iso) return '‚Äî'; if(/^\d{4}-\d{2}-\d{2}$/.test(iso)){ const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`; } const dt=new Date(iso); if(isNaN(dt.getTime())) return iso; return `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()}`; }

/* Inicializaci√≥n y realtime */
async function inicializarCanciones(){
  const col = collection(db,"canciones");
  onSnapshot(col, snap => {
    cancionesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    actualizarContador();
    cargarCanciones();
  });
}

/* Contador en tiempo real */
function actualizarContador(){
  const el = document.getElementById("contador-final");
  el.textContent = `Canciones totales üé∂: ${cancionesCache.length || 0}`;
}

/* Construcci√≥n de tarjeta */
function construirCard(d){
  const div = document.createElement("div");
  div.className = "card";
  const q = document.getElementById("search").value || "";
  const tituloHtml = modoEdicion ? `<input type="text" class="edit-titulo edit-input" value="${(d.titulo||'').replace(/"/g,'&quot;')}" />` : `<h2>${resaltar(d.titulo||'', q)}</h2>`;
  const acordesHtml = modoEdicion ? `<textarea class="edit-acordes edit-input">${(d.acordes||'')}</textarea>` : `<p>${(d.acordes||'')}</p>`;
  const imagenesHtml = modoEdicion ? `<textarea class="edit-imagenes edit-input" data-id="${d.id}">${(d.imagenes||[]).join("\n")}</textarea>` : `<div>${(d.imagenes||[]).map(u=>`<img src="${u}" style="width:100%;margin-top:8px;border-radius:8px;">`).join("")}</div>`;
  const audioHtml = modoEdicion ? `<input type="text" class="edit-audio edit-input" value="${(d.audio||'').replace(/"/g,'&quot;')}" placeholder="Link de audio">` : (d.audio ? `<a class="link-btn" href="${d.audio}" target="_blank">üéß Escuchar</a>` : "");
  const youtubeHtml = modoEdicion ? `<input type="text" class="edit-youtube edit-input" value="${(d.youtube||'').replace(/"/g,'&quot;')}" placeholder="Link de YouTube">` : (d.youtube ? `<a class="link-btn" href="${d.youtube}" target="_blank">üì∫ YouTube</a>` : "");
  const editButtons = modoEdicion ? `<div style="margin-top:10px"><button onclick="guardarEdicion('${d.id}', this)">üíæ Guardar</button> <button class="delete-btn" onclick="borrarCancion('${d.id}')">üóëÔ∏è Borrar</button></div>` : "";
  div.innerHTML = tituloHtml + acordesHtml + `<div style="margin-top:8px">${imagenesHtml}</div>` + `<div style="margin-top:8px">${audioHtml} ${youtubeHtml}</div>` + editButtons;
  return div;
}

/* Guardar secciones */
async function guardarSeccion(tipo){
  let tituloEl, cancionesEl;
  if(tipo==='semana'){ tituloEl=document.getElementById("titulo-semana"); cancionesEl=document.getElementById("canciones-semana"); }
  else if(tipo==='mes'){ tituloEl=document.getElementById("titulo-mes"); cancionesEl=document.getElementById("canciones-mes"); }
  else if(tipo==='worshippack'){ tituloEl=document.getElementById("titulo-worshippack"); cancionesEl=document.getElementById("canciones-worshippack"); }
  const titulo = tituloEl.value.trim();
  const canciones = cancionesEl.value.trim().split("\n").map(s=>s.trim()).filter(Boolean);
  await setDoc(doc(db,"secciones",tipo), { titulo, canciones });
  alert("‚úÖ Secci√≥n guardada");
  cargarSeccion(tipo);
}

/* Cargar secciones */
async function cargarSeccion(tipo){
  try{
    const snap = await getDoc(doc(db,"secciones",tipo));
    let contMostrar;
    if(tipo==='semana') contMostrar=document.getElementById("mostrar-semana");
    else if(tipo==='mes') contMostrar=document.getElementById("mostrar-mes");
    else if(tipo==='worshippack') contMostrar=document.getElementById("mostrar-worshippack");
    if(snap.exists()){
      const data = snap.data();
      contMostrar.innerHTML = `<h3>${data.titulo||""}</h3><ul>${(data.canciones||[]).map(c=>`<li>${c}</li>`).join("")}</ul>`;
    } else contMostrar.innerHTML = "<p>A√∫n no hay informaci√≥n guardada.</p>";
  } catch(e){ console.error("Error cargarSeccion:", e); }
}

/* Toggle Worship Pack */
async function toggleWorshipPack() {
  const contenedor = document.getElementById("worshipPackContainer");
  const btn = document.getElementById("btnWorshipPack");
  const visible = contenedor.style.display === "block";
  if (visible) { contenedor.style.display="none"; btn.textContent="üéÅ Worship Pack"; return; }
  try {
    const snap = await getDoc(doc(db,"secciones","worshippack"));
    if(!snap.exists()){ contenedor.innerHTML="<p>No hay canciones guardadas en el Worship Pack.</p>"; contenedor.style.display="block"; btn.textContent="‚ùå Cerrar pack"; return; }
    const data = snap.data();
    const lista = Array.isArray(data.canciones)?data.canciones.map(t=>t.trim()):[];
    const cancionesPack = cancionesCache.filter(c=>lista.some(nombre=>normalizar(c.titulo)===normalizar(nombre)));
    if(cancionesPack.length===0){ contenedor.innerHTML="<p>No se encontraron canciones coincidentes.</p>"; }
    else{ contenedor.innerHTML=""; cancionesPack.forEach(c=>contenedor.appendChild(construirCard(c))); }
    contenedor.style.display="block"; btn.textContent="‚ùå Cerrar pack";
  } catch(e){ console.error("Error al mostrar Worship Pack:",e); contenedor.innerHTML="<p>Error cargando el Worship Pack.</p>"; contenedor.style.display="block"; }
}
window.toggleWorshipPack = toggleWorshipPack;

/* Activar modo edici√≥n */
function activarEdicion(){
  modoEdicion=!modoEdicion;
  document.querySelector(".edit-banner").style.display=modoEdicion?"block":"none";
  document.getElementById("contenedor-semana").style.display=modoEdicion?"block":"none";
  document.getElementById("contenedor-mes").style.display=modoEdicion?"block":"none";
  document.getElementById("contenedor-worshippack").style.display=modoEdicion?"block":"none";
  document.getElementById("btnAgregar").style.display=modoEdicion?"inline-block":"none";
  cargarSeccion("semana"); cargarSeccion("mes"); cargarSeccion("worshippack");
  cargarCanciones();
}

/* Funciones darkmode, agregar, cargar, editar, borrar canciones, toggle de lista, registro y b√∫squeda */
function toggleDark(){document.body.classList.toggle("dark");}
function toggleCanciones(){cancionesVisible=!cancionesVisible;document.getElementById("lista-canciones").style.display=cancionesVisible?"block":"none";}
async function agregarCancion(){const t=document.getElementById("titulo").value.trim(); if(!t)return; const acordes=document.getElementById("acordes").value.trim(); const imgs=document.getElementById("imagenes").value.trim().split("\n").filter(Boolean); const audio=document.getElementById("audio").value.trim(); const yt=document.getElementById("youtube").value.trim(); await addDoc(collection(db,"canciones"),{titulo:t,acordes,imagenes:imgs,audio,audioYT:yt,youtube:yt}); document.getElementById("formulario").reset(); alert("‚úÖ Canci√≥n agregada"); }
async function cargarCanciones(){ const cont=document.getElementById("lista-canciones"); cont.innerHTML=""; cancionesCache.forEach(c=>cont.appendChild(construirCard(c))); }
async function guardarEdicion(id,btn){ const card=btn.closest(".card"); const t=card.querySelector(".edit-titulo").value.trim(); const a=card.querySelector(".edit-acordes").value.trim(); const imgs=card.querySelector(".edit-imagenes").value.trim().split("\n").filter(Boolean); const audio=card.querySelector(".edit-audio").value.trim(); const yt=card.querySelector(".edit-youtube").value.trim(); await updateDoc(doc(db,"canciones",id),{titulo:t,acordes:a,imagenes:imgs,audio,youtube:yt}); alert("‚úÖ Cambios guardados"); }
async function borrarCancion(id){if(confirm("¬øSeguro que deseas borrar esta canci√≥n?")){await deleteDoc(doc(db,"canciones",id)); alert("‚úÖ Canci√≥n eliminada"); }}
window.addEventListener("DOMContentLoaded",()=>{inicializarCanciones(); ["semana","mes","worshippack"].forEach(cargarSeccion);});

</script>
</body>
</html>