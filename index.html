<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Repertorio Worship</title>

<style>
:root {
  --primary: #002244;
  --accent: #FF6F00;
  --bg: #f0f4f8;
  --text: #002244;
  --section-bg: #fff8e1;
  --card-bg: #ffffff;
  --edit-bg: #FFEB3B;
}

body.dark {
  --bg: #121212;
  --text: #f0f4f8;
  --card-bg: #1e1e1e;
  --section-bg: #2a2a2a;
  --edit-bg: #f9a825;
}

html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
}

body {
  font-family: 'Segoe UI', sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background 0.3s, color 0.3s;
}

header {
  background: var(--primary);
  color: white;
  width: 100vw;            /* üîß siempre de borde a borde */
  box-sizing: border-box;  /* üîß padding no rompe el ancho */
  padding: 20px 22px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 6px;
  min-height: 80px;
}

.logo {
  display: flex;
  align-items: center;
  gap: 10px;
}

.logo img {
  height: 60px;
  border-radius: 8px;
}

.controls {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: nowrap;
}

button {
  background-color: var(--accent);
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 8px;
  cursor: pointer;
  font-weight: bold;
  font-size: 0.85em;
  transition: background 0.2s, transform 0.1s;
  white-space: nowrap;
}

button:hover {
  background-color: #e65e00;
  transform: scale(1.05);
}

main {
  max-width: 850px;
  margin: auto;
  padding: 16px;
}

.card {
  background: var(--card-bg);
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  margin-bottom: 20px;
}

input, textarea {
  width: 100%;
  padding: 10px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: var(--bg);
  color: var(--text);
}

.section {
  background: var(--section-bg);
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 20px;
}

#formulario {
  display: none;
  margin-top: 15px;
}

.search-container {
  position: relative;
  margin-bottom: 20px;
}

#search {
  width: 100%;
  padding: 16px 45px 16px 14px;
  border-radius: 10px;
  border: 2px solid var(--accent);
  font-size: 1.2em;
  box-shadow: 0 0 6px rgba(0,0,0,0.1);
  transition: 0.3s;
}

#search:focus {
  outline: none;
  box-shadow: 0 0 10px var(--accent);
  background: #fff3e0;
}

#clearSearch {
  position: absolute;
  right: 15px;
  top: 50%;
  transform: translateY(-50%);
  background: transparent;
  border: none;
  color: var(--accent);
  font-size: 1.4em;
  cursor: pointer;
  display: none;
}

a {
  text-decoration: none;
}

.link-btn {
  display: inline-block;
  background-color: var(--accent);
  color: white;
  padding: 10px 14px;
  border-radius: 8px;
  font-weight: bold;
  margin: 6px 5px 0 0;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  transition: 0.2s;
}

.link-btn:hover {
  background-color: #e65e00;
  transform: scale(1.05);
}

.edit-banner {
  position: sticky;
  top: 0;
  background: var(--edit-bg);
  text-align: center;
  font-weight: bold;
  padding: 8px;
  display: none;
  z-index: 100;
}

footer {
  text-align: center;
  margin-top: 40px;
  padding: 20px;
  font-size: 1em;
}

mark {
  background-color: yellow;
  color: black;
}
</style>
</head>
<body>
<div class="edit-banner">‚úèÔ∏è Modo edici√≥n activo</div>

<header>
  <div class="logo">
    <img src="https://raw.githubusercontent.com/Lifebygrace/Repertorio-worship/main/logo.jpeg" alt="Logo Repertorio Worship" />
    <h1>Repertorio Worship</h1>
  </div>
  <div class="controls">
    <button onclick="toggleDark()">üåô / ‚òÄÔ∏è</button>
    <button onclick="activarEdicion()">‚úèÔ∏è Editar</button>
    <button onclick="window.open('https://www.metronomeonline.com','_blank')">üïí Metr√≥nomo</button>
    <button id="toggleCancionesBtn" onclick="toggleCanciones()">üéµ Mostrar lista</button>
  </div>
</header>

<main>
  <div class="search-container">
    <input type="text" id="search" placeholder="üîç Buscar canciones por t√≠tulo..." />
    <button id="clearSearch">‚ùå</button>
  </div>

  <div class="section">
    <h2>üé∂ Canciones para la semana</h2>
    <div id="contenedor-semana" style="display:none;">
      <input type="text" id="titulo-semana" placeholder="T√≠tulo (ej. Semana del 7 al 13 de octubre)" />
      <textarea id="canciones-semana" placeholder="Canciones (una por l√≠nea)"></textarea>
      <button onclick="guardarSeccion('semana')">Guardar secci√≥n</button>
    </div>
    <div id="mostrar-semana" style="margin-top:10px;"></div>
  </div>

  <div class="section">
    <h2>üÜï Canciones nuevas del mes</h2>
    <div id="contenedor-mes" style="display:none;">
      <input type="text" id="titulo-mes" placeholder="T√≠tulo (ej. Octubre 2025)" />
      <textarea id="canciones-mes" placeholder="Canciones (una por l√≠nea)"></textarea>
      <button onclick="guardarSeccion('mes')">Guardar secci√≥n</button>
    </div>
    <div id="mostrar-mes" style="margin-top:10px;"></div>
  </div>

  <button id="btnAgregar" onclick="toggleFormulario()" style="display:none;">‚ûï Agregar nueva canci√≥n</button>

  <form id="formulario" onsubmit="event.preventDefault(); agregarCancion();">
    <div class="card">
      <h2>Agregar canci√≥n</h2>
      <input type="text" id="titulo" placeholder="T√≠tulo de la canci√≥n" required />
      <textarea id="acordes" placeholder="Acordes..."></textarea>
      <textarea id="imagenes" placeholder="Links de im√°genes (uno por l√≠nea)"></textarea>
      <input type="text" id="audio" placeholder="Link de audio" />
      <input type="text" id="youtube" placeholder="Link de YouTube" />
      <button type="submit">Guardar canci√≥n</button>
    </div>
  </form>

  <div id="lista-canciones" style="display:none;"></div>

  <footer>
    <p id="contador">üéµ Total de canciones: 0</p>
    <button onclick="window.scrollTo({top:0, behavior:'smooth'})">‚¨ÜÔ∏è Volver al inicio</button>
  </footer> 
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDahT6IuQwSYdpAMcPpAERpqVuobmqmVSQ",
  authDomain: "repertorioworship.firebaseapp.com",
  projectId: "repertorioworship",
  storageBucket: "repertorioworship.appspot.com",
  messagingSenderId: "493050453266",
  appId: "1:493050453266:web:cf07ce9fbb471122f167cb"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
let modoEdicion = false;
let cancionesCache = [];
let debounceTimer;
let cancionesVisible = false;

function normalizar(texto){ return texto.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase(); }
function resaltar(texto, busqueda){ const regex = new RegExp(`(${busqueda})`, "gi"); return texto.replace(regex, "<mark>$1</mark>"); }

async function cargarCanciones() {
  const contenedor = document.getElementById("lista-canciones");
  contenedor.innerHTML = "";
  const searchInput = document.getElementById("search").value;
  const search = normalizar(searchInput);

  cancionesCache.forEach((data)=>{
    if(!normalizar(data.titulo).includes(search)) return;
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <h2 contenteditable="${modoEdicion}">${modoEdicion ? data.titulo : resaltar(data.titulo, searchInput)}</h2>
      <p contenteditable="${modoEdicion}">${modoEdicion ? (data.acordes || "") : data.acordes || ""}</p>
      <textarea style="display:${modoEdicion ? "block" : "none"}" placeholder="Links de im√°genes (uno por l√≠nea)">${(data.imagenes || []).join("\n")}</textarea>
      <input style="display:${modoEdicion ? "block" : "none"}" value="${data.audio || ""}" placeholder="Link de audio">
      <input style="display:${modoEdicion ? "block" : "none"}" value="${data.youtube || ""}" placeholder="Link de YouTube">
      ${(data.imagenes || []).map(url => `<img src="${url}" width="100%" style="margin-top:10px;border-radius:8px;">`).join('')}
      ${!modoEdicion && data.audio ? `<a class="link-btn" href="${data.audio}" target="_blank">üéß Escuchar grabaci√≥n</a>` : ""}
      ${!modoEdicion && data.youtube ? `<a class="link-btn" href="${data.youtube}" target="_blank">üì∫ Ver en YouTube</a>` : ""}
      ${modoEdicion ? `<button onclick="guardarEdicion('${data.id}', this)">üíæ Guardar cambios</button>` : ""}
    `;
    contenedor.appendChild(div);
  });

  const searchActive = search.length > 0;
  contenedor.style.display = cancionesVisible || searchActive ? "block" : "none";
  document.getElementById("contador").textContent = `üéµ Total de canciones: ${cancionesCache.length}`;
}

async function guardarEdicion(id, btn){
  const card = btn.closest(".card");
  const [tituloEl, acordesEl, imagenesEl, audioEl, youtubeEl] = card.querySelectorAll("h2, p, textarea, input:nth-of-type(1), input:nth-of-type(2)");
  const titulo = tituloEl.innerText.trim();
  const acordes = acordesEl.innerText.trim();
  const imagenes = imagenesEl.value.trim().split("\n").filter(x=>x);
  const audio = audioEl.value.trim();
  const youtube = youtubeEl.value.trim();
  await updateDoc(doc(db, "canciones", id), {titulo, acordes, imagenes, audio, youtube});
  alert("‚úÖ Cambios guardados");
  cargarCanciones();
}

async function inicializarCanciones(){
  onSnapshot(collection(db, "canciones"), (snapshot)=>{
    cancionesCache = snapshot.docs.map(d=>({id:d.id, ...d.data()}));
    cargarCanciones();
  });
}

async function agregarCancion(){
  const titulo = document.getElementById("titulo").value.trim();
  const acordes = document.getElementById("acordes").value.trim();
  const youtube = document.getElementById("youtube").value.trim();
  const imagenes = document.getElementById("imagenes").value.trim().split("\n").filter(x=>x);
  const audio = document.getElementById("audio").value.trim();
  if(!titulo) return alert("El t√≠tulo es obligatorio");
  await addDoc(collection(db, "canciones"), {titulo, acordes, youtube, imagenes, audio});
  document.getElementById("formulario").reset();
  document.getElementById("formulario").style.display = "none";
}

function debounceBuscar(){ clearTimeout(debounceTimer); debounceTimer = setTimeout(cargarCanciones, 300); }

function toggleDark(){
  document.body.classList.toggle("dark");
  if(document.body.classList.contains("dark")){
    localStorage.setItem("theme", "dark");
  } else {
    localStorage.setItem("theme", "light");
  }
}

function toggleFormulario(){ const form = document.getElementById("formulario"); form.style.display = form.style.display === "none" ? "block" : "none"; }

async function cargarSeccion(tipo){
  const contenedor = document.getElementById(`contenedor-${tipo}`);
  const mostrar = document.getElementById(`mostrar-${tipo}`);
  const docRef = doc(db,"secciones",tipo);
  const snap = await getDoc(docRef);
  if(snap.exists()){
    const data = snap.data();
    mostrar.innerHTML = `<h3>${data.titulo || ""}</h3><ul>${(data.canciones||[]).map(c=>`<li>${c}</li>`).join("")}</ul>`;
  } else { mostrar.innerHTML = "<p>A√∫n no hay informaci√≥n guardada.</p>"; }
  contenedor.style.display = modoEdicion ? "block" : "none";
}

async function guardarSeccion(tipo){
  const titulo = document.getElementById(`titulo-${tipo}`).value.trim();
  const canciones = document.getElementById(`canciones-${tipo}`).value.trim().split("\n").filter(x=>x);
  await setDoc(doc(db,"secciones",tipo), {titulo, canciones});
  alert("‚úÖ Secci√≥n guardada");
  cargarSeccion(tipo);
}

function activarEdicion(){
  const addBtn = document.getElementById("btnAgregar");
  if(!modoEdicion){
    const pin = prompt("Introduce el PIN para editar:");
    if(pin==="2025"){
      modoEdicion=true;
      document.querySelector(".edit-banner").style.display="block";
      addBtn.style.display="block";
      alert("‚úèÔ∏è Modo edici√≥n activado");
    }else if(pin){ alert("PIN incorrecto"); return; }
  }else{
    modoEdicion=false;
    document.querySelector(".edit-banner").style.display="none";
    addBtn.style.display="none";
    alert("üîí Modo edici√≥n desactivado");
  }
  cargarSeccion("semana");
  cargarSeccion("mes");
  cargarCanciones();
}

function toggleCanciones() {
  cancionesVisible = !cancionesVisible;
  document.getElementById("toggleCancionesBtn").textContent = cancionesVisible ? "üéµ Ocultar lista" : "üéµ Mostrar lista";
  cargarCanciones();
}

window.onload=()=>{
  inicializarCanciones();
  cargarSeccion("semana");
  cargarSeccion("mes");

  // aplicar preferencia guardada de tema
  const savedTheme = localStorage.getItem("theme");
  if(savedTheme === "dark"){
    document.body.classList.add("dark");
  }

  const searchInput = document.getElementById("search");
  const clearBtn = document.getElementById("clearSearch");
  searchInput.addEventListener("input", ()=>{
    debounceBuscar();
    clearBtn.style.display = searchInput.value ? "block" : "none";
  });
  clearBtn.addEventListener("click", ()=>{
    searchInput.value = "";
    clearBtn.style.display = "none";
    cargarCanciones();
  });
}

window.agregarCancion=agregarCancion;
window.guardarEdicion=guardarEdicion;
window.toggleDark=toggleDark;
window.toggleFormulario=toggleFormulario;
window.activarEdicion=activarEdicion;
window.guardarSeccion=guardarSeccion;
window.toggleCanciones=toggleCanciones;
</script>
</body>
</html>