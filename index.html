<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Repertorio Worship</title>
<style>
:root{
  --primary:#002244;--accent:#ff8c42;--bg:#f0f4f8;--text:#002244;
  --section-bg:#fff8e1;--card-bg:#ffffff;--edit-bg:#FFEB3B;
}
body.dark{--bg:#121212;--text:#f0f4f8;--card-bg:#1e1e1e;--section-bg:#2a2a2a;--edit-bg:#f9a825}
html,body{height:100%;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);transition:background .25s,color .25s}
header{background:var(--primary);color:#fff;padding:18px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:12px}
.logo img{height:56px;border-radius:8px}
.controls{display:flex;gap:8px;align-items:center}
button{background:var(--accent);color:#fff;border:0;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}
button:hover{transform:scale(1.03)}
main{max-width:900px;margin:18px auto;padding:12px}
.card{background:var(--card-bg);padding:14px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:16px}
.section{background:var(--section-bg);padding:14px;border-radius:10px;margin-bottom:16px}
input,textarea{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;background:transparent;color:inherit}
.search-container{position:relative;margin-bottom:16px}
#search{padding:14px 44px 14px 14px;border-radius:10px;border:2px solid var(--accent);font-size:1.05rem}
#clearSearch{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:var(--accent);font-size:1.2rem;display:none}
.link-btn{display:inline-block;background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none}
.edit-banner{position:sticky;top:0;background:var(--edit-bg);padding:8px;text-align:center;font-weight:bold;display:none;z-index:50}
footer{text-align:center;margin-top:24px;padding:16px;display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:var(--accent);color:#fff;cursor:pointer}
ul.fechas-lista{list-style:none;padding:0;margin:0;text-align:left}
.fechas-box{min-width:180px}
.small {font-size:0.8rem;padding:4px 6px;border-radius:6px;margin-left:2px}
.meta-line{font-size:0.9rem;color:#555;display:flex;gap:10px;align-items:center;margin-top:8px}
.meta-line .plays, .meta-line .last{display:inline-block}
.tocada-btn{background:#0077cc;padding:6px 8px;border-radius:6px;color:#fff;border:0;cursor:pointer;font-weight:700}
.tocada-btn:hover{opacity:0.95}
.counter-badge{background:rgba(255,255,255,0.12);padding:6px 10px;border-radius:10px;font-weight:700;margin-left:8px}
.th-sortable{position:relative}
.th-sortable .sort-ind{font-size:0.9rem;opacity:0.9;margin-left:6px}
#contadorFinal{margin-top:24px;font-weight:700;color:#555;font-size:1rem;text-align:center;}
</style>
</head>
<body>
<div class="edit-banner">‚úèÔ∏è Modo edici√≥n activo</div>

<header>
  <div class="logo" style="align-items:center">
    <img src="https://raw.githubusercontent.com/Lifebygrace/Repertorio-worship/main/logo.jpeg" alt="Logo" />
    <div>
      <h1 style="margin:0;display:flex;align-items:center;gap:8px">Repertorio Worship</h1>
    </div>
  </div>
  <div class="controls">
    <button onclick="toggleDark()">üåô / ‚òÄÔ∏è</button>
    <button onclick="activarEdicion()">‚úèÔ∏è Editar</button>
    <button onclick="window.open('https://www.metronomeonline.com','_blank')">üïí Metr√≥nomo</button>
    <button id="toggleCancionesBtn" onclick="toggleCanciones()">üéµ Mostrar lista</button>
  </div>
</header>

<main>
  <div class="search-container">
    <input id="search" placeholder="üîç Buscar canciones por t√≠tulo..." />
    <button id="clearSearch">‚ùå</button>
  </div>

  <div class="section">
    <h2>üé∂ Canciones para la semana</h2>
    <div id="contenedor-semana" style="display:none;">
      <input id="titulo-semana" placeholder="T√≠tulo (ej. Semana del 7 al 13 de octubre)" />
      <textarea id="canciones-semana" placeholder="Canciones (una por l√≠nea)"></textarea>
      <button onclick="guardarSeccion('semana')">Guardar secci√≥n</button>
    </div>
    <div id="mostrar-semana" style="margin-top:8px"></div>
  </div>

  <div class="section">
    <h2>üÜï Canciones nuevas del mes</h2>
    <div id="contenedor-mes" style="display:none;">
      <input id="titulo-mes" placeholder="T√≠tulo (ej. Octubre 2025)" />
      <textarea id="canciones-mes" placeholder="Canciones (una por l√≠nea)"></textarea>
      <button onclick="guardarSeccion('mes')">Guardar secci√≥n</button>
    </div>
    <div id="mostrar-mes" style="margin-top:8px"></div>
  </div>

  <button id="btnAgregar" onclick="toggleFormulario()" style="display:none;">‚ûï Agregar nueva canci√≥n</button>

  <form id="formulario" onsubmit="event.preventDefault(); agregarCancion();" style="display:none;margin-top:12px;">
    <div class="card">
      <h2>Agregar canci√≥n</h2>
      <input id="titulo" placeholder="T√≠tulo de la canci√≥n" required />
      <textarea id="acordes" placeholder="Acordes..."></textarea>
      <textarea id="imagenes" placeholder="Links de im√°genes (uno por l√≠nea)"></textarea>
      <input id="audio" placeholder="Link de audio" />
      <input id="youtube" placeholder="Link de YouTube" />
      <button type="submit">Guardar canci√≥n</button>
    </div>
  </form>

  <div id="lista-canciones" style="display:none;margin-top:12px;"></div>

  <div id="registro-canciones-container" style="margin-top:12px;">
    <button style="background:var(--accent);" onclick="toggleRegistro()">üìä Registro de canciones</button>
    <div id="registro-canciones" class="section" style="display:none;">
      <h2>üìã Registro de canciones</h2>
      <table id="tabla-registro">
        <thead>
          <tr>
            <th class="th-sortable" onclick="setOrden('titulo')">T√≠tulo <span class="sort-ind" id="sortTitulo"></span></th>
            <th class="th-sortable" onclick="setOrden('veces')">Veces tocada <span class="sort-ind" id="sortVeces"></span></th>
            <th class="th-sortable" onclick="setOrden('ultima')">√öltima fecha <span class="sort-ind" id="sortUltima"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="contadorFinal">Canciones totales üé∂: 0</div>

  <footer>
    <button onclick="window.scrollTo({top:0, behavior:'smooth'})">‚¨ÜÔ∏è Volver al inicio</button>
  </footer>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, onSnapshot, getDocs, deleteDoc
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDahT6IuQwSYdpAMcPpAERpqVuobmqmVSQ",
  authDomain: "repertorioworship.firebaseapp.com",
  projectId: "repertorioworship",
  storageBucket: "repertorioworship.firebasestorage.app",
  messagingSenderId: "493050453266",
  appId: "1:493050453266:web:cf07ce9fbb471122f167cb"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let modoEdicion=false;
let cancionesCache=[];
let registroCache={};
let debounceTimer;
let cancionesVisible=false;
let ordenActual={campo:'titulo',sentido:'desc'};

function normalizar(t){return (t||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();}
function resaltar(t,q){if(!q)return t;try{const r=new RegExp(`(${q})`,"gi");return t.replace(r,"<mark>$1</mark>")}catch(e){return t;}}
function pad(n){return String(n).padStart(2,'0');}
function isoToday(){const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;}
function isoToDisplay(iso){if(!iso) return '‚Äî';if(/^\d{4}-\d{2}-\d{2}$/.test(iso)){const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`;} const dt=new Date(iso); if(isNaN(dt.getTime())) return iso; return `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()}`;}

async function inicializarCanciones(){
  const col = collection(db,"canciones");
  onSnapshot(col,snap=>{
    cancionesCache = snap.docs.map(d=>({id:d.id,...d.data()}));
    actualizarContador();
    cargarCanciones();
    if(document.getElementById("registro-canciones").style.display==="block") cargarRegistro();
  });
}

function actualizarContador(){
  const el = document.getElementById("contadorFinal");
  const n = cancionesCache.length || 0;
  el.textContent = `Canciones totales üé∂: ${n}`;
}

function construirCard(d){
  const div=document.createElement("div");div.className="card";

  if(modoEdicion){
    div.innerHTML=`
      <h2><input type="text" value="${d.titulo||''}" style="width:100%"/></h2>
      <textarea placeholder="Acordes" style="width:100%;margin-top:4px">${d.acordes||''}</textarea>
      <textarea placeholder="Links de im√°genes (uno por l√≠nea)" style="width:100%;margin-top:4px">${(d.imagenes||[]).join('\n')}</textarea>
      <input placeholder="Link de audio" value="${d.audio||''}" style="width:100%;margin-top:4px"/>
      <input placeholder="Link de YouTube" value="${d.youtube||''}" style="width:100%;margin-top:4px"/>
      <div class="meta-line">
        <span class="plays" id="plays-${d.id}">üéµ Veces tocada: ‚Äî</span>
        <span class="last" id="last-${d.id}">| √öltima vez: ‚Äî</span>
        <button class="tocada-btn" id="tocadaBtn-${d.id}">Tocada +1</button>
      </div>
      <div style="margin-top:10px">
        <button onclick="guardarEdicion('${d.id}', this)">üíæ Guardar</button>
        <button onclick="borrarCancion('${d.id}')">üóëÔ∏è Borrar</button>
      </div>
    `;
    setTimeout(()=>{ 
      const btn = document.getElementById(`tocadaBtn-${d.id}`);
      if(btn) btn.addEventListener('click', ()=> marcarTocada(d.id));
    },0);
  } else {
    const tituloHtml = `<h2>${resaltar(d.titulo||'',document.getElementById("search").value)}</h2>`;
    const acordesHtml = `<p>${d.acordes||''}</p>`;
    div.innerHTML=`
      ${tituloHtml}
      ${acordesHtml}
      <div class="meta-line">
        <span class="plays" id="plays-${d.id}">üéµ Veces tocada: ‚Äî</span>
        <span class="last" id="last-${d.id}">| √öltima vez: ‚Äî</span>
      </div>
      <div style="margin-top:8px">
        ${(d.imagenes||[]).map(u=>`<img src="${u}" width="100%" style="margin-top:8px;border-radius:8px;">`).join('')}
      </div>
      <div style="margin-top:8px">
        ${d.audio?`<a class="link-btn" href="${d.audio}" target="_blank">üéß Escuchar</a>`:""}
        ${d.youtube?` <a class="link-btn" href="${d.youtube}" target="_blank">üì∫ YouTube</a>`:""}
      </div>
    `;
  }

  actualizarRegistroCard(d.id);
  return div;
}

// --- Funciones de edici√≥n, agregar, borrar, marcar tocada ---
async function agregarCancion(){
  const t=document.getElementById("titulo").value;
  const a=document.getElementById("acordes").value;
  const i=document.getElementById("imagenes").value.split('\n').filter(u=>u);
  const au=document.getElementById("audio").value;
  const y=document.getElementById("youtube").value;
  await addDoc(collection(db,"canciones"),{titulo:t,acordes:a,imagenes:i,audio:au,youtube:y,veces:0,ultima:""});
  document.getElementById("formulario").reset();
}
async function guardarEdicion(id, btn){
  const card = btn.closest(".card");
  const inputs = card.querySelectorAll("input,textarea");
  const [titulo,acordes,imagenes,audio,youtube] = Array.from(inputs).map(x=>x.value);
  await setDoc(doc(db,"canciones",id),{
    titulo,acordes,imagenes:imagenes.split('\n').filter(u=>u),audio,youtube,veces:cancionesCache.find(c=>c.id===id).veces||0,ultima:cancionesCache.find(c=>c.id===id).ultima||""
  });
}
async function borrarCancion(id){if(confirm("¬øSeguro que quieres borrar esta canci√≥n?")) await deleteDoc(doc(db,"canciones",id));}
async function marcarTocada(id){
  const c = cancionesCache.find(c=>c.id===id);
  if(!c) return;
  const veces = (c.veces||0)+1;
  const ultima = isoToday();
  await updateDoc(doc(db,"canciones",id),{veces,ultima});
}

// --- Mostrar canciones ---
function cargarCanciones(){
  const cont = document.getElementById("lista-canciones");
  cont.innerHTML="";
  let q = document.getElementById("search").value.toLowerCase();
  cancionesCache.forEach(c=>{
    if(!c.titulo.toLowerCase().includes(q)) return;
    cont.appendChild(construirCard(c));
  });
}

// --- Registro ---
function actualizarRegistroCard(id){
  const c = cancionesCache.find(c=>c.id===id);
  if(!c) return;
  const plays = document.getElementById(`plays-${id}`);
  const last = document.getElementById(`last-${id}`);
  if(plays) plays.textContent = `üéµ Veces tocada: ${c.veces||0}`;
  if(last) last.textContent = `| √öltima vez: ${isoToDisplay(c.ultima)}`;
}
function cargarRegistro(){
  const tbody = document.querySelector("#tabla-registro tbody");
  tbody.innerHTML="";
  let arr = [...cancionesCache];
  if(ordenActual.campo==='titulo') arr.sort((a,b)=>ordenActual.sentido==='asc'?a.titulo.localeCompare(b.titulo):b.titulo.localeCompare(a.titulo));
  else if(ordenActual.campo==='veces') arr.sort((a,b)=>ordenActual.sentido==='asc'? (a.veces||0)-(b.veces||0) : (b.veces||0)-(a.veces||0));
  else if(ordenActual.campo==='ultima') arr.sort((a,b)=>ordenActual.sentido==='asc'? new Date(a.ultima||0)-new Date(b.ultima||0): new Date(b.ultima||0)-new Date(a.ultima||0));
  arr.forEach(c=>{
    const tr = document.createElement("tr");
    tr.innerHTML=`<td>${c.titulo||''}</td><td>${c.veces||0}</td><td>${isoToDisplay(c.ultima)}</td>`;
    tbody.appendChild(tr);
  });
}

// --- UI ---
function toggleDark(){document.body.classList.toggle("dark");}
function activarEdicion(){
  modoEdicion=!modoEdicion;
  document.querySelector(".edit-banner").style.display = modoEdicion?"block":"none";
  cargarCanciones();
}
function toggleFormulario(){
  const f = document.getElementById("formulario");
  f.style.display = f.style.display==="block"?"none":"block";
}
function toggleCanciones(){
  cancionesVisible = !cancionesVisible;
  const cont = document.getElementById("lista-canciones");
  cont.style.display = cancionesVisible?"block":"none";
  document.getElementById("toggleCancionesBtn").textContent = cancionesVisible?"üéµ Ocultar lista":"üéµ Mostrar lista";
}
function toggleRegistro(){
  const r = document.getElementById("registro-canciones");
  r.style.display = r.style.display==="block"?"none":"block";
  if(r.style.display==="block") cargarRegistro();
}
function setOrden(campo){
  if(ordenActual.campo===campo) ordenActual.sentido=ordenActual.sentido==='asc'?'desc':'asc';
  else {ordenActual.campo=campo;ordenActual.sentido='asc';}
  cargarRegistro();
}

// --- B√∫squeda ---
document.getElementById("search").addEventListener("input",()=>{
  clearTimeout(debounceTimer);
  debounceTimer=setTimeout(()=>{cargarCanciones();document.getElementById("clearSearch").style.display=document.getElementById("search").value?"inline":"none";},200);
});
document.getElementById("clearSearch").addEventListener("click",()=>{document.getElementById("search").value="";cargarCanciones();document.getElementById("clearSearch").style.display="none";});

// --- Secciones ---
function guardarSeccion(tipo){
  const t = document.getElementById(`titulo-${tipo}`).value;
  const c = document.getElementById(`canciones-${tipo}`).value.split("\n").filter(x=>x);
  localStorage.setItem(`seccion-${tipo}`, JSON.stringify({titulo:t,canciones:c}));
  mostrarSeccion(tipo);
}
function mostrarSeccion(tipo){
  const d = JSON.parse(localStorage.getItem(`seccion-${tipo}`)||"{}");
  const cont = document.getElementById(`mostrar-${tipo}`);
  if(!d.titulo) return cont.innerHTML="";
  cont.innerHTML=`<strong>${d.titulo}</strong><ul>${(d.canciones||[]).map(x=>`<li>${x}</li>`).join('')}</ul>`;
}

// --- Inicializaci√≥n ---
inicializarCanciones();
['semana','mes'].forEach(mostrarSeccion);
</script>
</body>
</html>