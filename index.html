<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Repertorio Worship</title>
<style>
:root {
  --primary: #002244;
  --accent: #FF6F00;
  --bg: #f0f4f8;
  --text: #002244;
  --section-bg: #fff8e1;
  --card-bg: #ffffff;
  --edit-bg: #FFEB3B;
  --btn-orange: #FF8C42;
}
body.dark {
  --bg:#121212;
  --text:#f0f4f8;
  --card-bg:#1e1e1e;
  --section-bg:#2a2a2a;
  --edit-bg:#f9a825;
}
html, body {margin:0;padding:0;font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);}
header{background:var(--primary);color:#fff;padding:18px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:12px}
.logo img{height:56px;border-radius:8px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
button{background:var(--btn-orange);color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}
button:hover{transform:scale(1.03)}
main{max-width:900px;margin:18px auto;padding:12px}
.card{background:var(--card-bg);padding:14px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:16px}
.section{background:var(--section-bg);padding:14px;border-radius:10px;margin-bottom:16px}
input,textarea{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;background:transparent;color:inherit}
.search-container{position:relative;margin-bottom:16px}
#search{padding:14px 44px 14px 14px;border-radius:10px;border:2px solid var(--accent);font-size:1.05rem}
#clearSearch{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:var(--accent);font-size:1.2rem;display:none}
.link-btn{display:inline-block;background:var(--btn-orange);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;margin:2px 2px 2px 0}
.edit-banner{position:sticky;top:0;background:var(--edit-bg);padding:8px;text-align:center;font-weight:bold;display:none;z-index:50}
footer{text-align:center;margin-top:24px;padding:16px;display:flex;justify-content:center;gap:10px;flex-wrap:wrap}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:var(--btn-orange);color:#fff;cursor:pointer}
input.small-btn,input[type=date]{padding:4px 6px;border-radius:6px;margin:2px;font-size:0.85rem;}
ul.fechas-lista{list-style:none;padding:0;margin:0;text-align:left}
.fechas-box{min-width:180px;text-align:left}
</style>
</head>
<body>
<div class="edit-banner">‚úèÔ∏è Modo edici√≥n activo</div>

<header>
  <div class="logo">
    <img src="https://raw.githubusercontent.com/Lifebygrace/Repertorio-worship/main/logo.jpeg" alt="Logo">
    <h1>Repertorio Worship</h1>
  </div>
  <div class="controls">
    <button onclick="toggleDark()">üåô / ‚òÄÔ∏è</button>
    <button onclick="activarEdicion()">‚úèÔ∏è Editar</button>
    <button onclick="window.open('https://www.metronomeonline.com','_blank')">üïí Metr√≥nomo</button>
    <button id="toggleCancionesBtn" onclick="toggleCanciones()">üéµ Mostrar lista</button>
  </div>
</header>

<main>
  <div class="search-container">
    <input id="search" placeholder="üîç Buscar canciones por t√≠tulo..." />
    <button id="clearSearch">‚ùå</button>
  </div>

  <div class="section">
    <h2>üé∂ Canciones para la semana</h2>
    <div id="contenedor-semana" style="display:none;">
      <input id="titulo-semana" placeholder="T√≠tulo (ej. Semana del 7 al 13 de octubre)" />
      <textarea id="canciones-semana" placeholder="Canciones (una por l√≠nea)"></textarea>
      <button onclick="guardarSeccion('semana')">Guardar secci√≥n</button>
    </div>
    <div id="mostrar-semana" style="margin-top:8px"></div>
  </div>

  <div class="section">
    <h2>üÜï Canciones nuevas del mes</h2>
    <div id="contenedor-mes" style="display:none;">
      <input id="titulo-mes" placeholder="T√≠tulo (ej. Octubre 2025)" />
      <textarea id="canciones-mes" placeholder="Canciones (una por l√≠nea)"></textarea>
      <button onclick="guardarSeccion('mes')">Guardar secci√≥n</button>
    </div>
    <div id="mostrar-mes" style="margin-top:8px"></div>
  </div>

  <button id="btnAgregar" onclick="toggleFormulario()" style="display:none;">‚ûï Agregar nueva canci√≥n</button>

  <form id="formulario" onsubmit="event.preventDefault(); agregarCancion();" style="display:none;margin-top:12px;">
    <div class="card">
      <h2>Agregar canci√≥n</h2>
      <input id="titulo" placeholder="T√≠tulo de la canci√≥n" required />
      <textarea id="acordes" placeholder="Acordes..."></textarea>
      <textarea id="imagenes" placeholder="Links de im√°genes (uno por l√≠nea)"></textarea>
      <input id="audio" placeholder="Link de audio" />
      <input id="youtube" placeholder="Link de YouTube" />
      <button type="submit">Guardar canci√≥n</button>
    </div>
  </form>

  <div id="lista-canciones" style="display:none;"></div>

  <!-- Botones fijos abajo -->
  <div style="display:flex;justify-content:center;gap:10px;margin-top:12px;flex-wrap:wrap;">
    <button onclick="window.scrollTo({top:0,behavior:'smooth'})">‚¨ÜÔ∏è Volver al inicio</button>
    <button id="btn-registro" onclick="toggleRegistro()">üìä Registro de canciones</button>
  </div>

  <!-- Tabla registro debajo de los botones -->
  <div id="registro-canciones" class="section" style="display:none;margin-top:8px;">
    <h2>üìã Registro de canciones</h2>
    <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:center;margin-bottom:8px;">
      <span>Ordenar por:</span>
      <button class="small-btn" onclick="setOrden('titulo')">T√≠tulo</button>
      <button class="small-btn" onclick="setOrden('veces')">Veces</button>
      <button class="small-btn" onclick="setOrden('ultima')">√öltima</button>
    </div>
    <table id="tabla-registro">
      <thead>
        <tr>
          <th onclick="setOrden('titulo')">T√≠tulo</th>
          <th onclick="setOrden('veces')">Veces tocada</th>
          <th onclick="setOrden('ultima')">Fechas</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <p id="contador">üéµ Total de canciones: 0</p>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey:"AIzaSyDahT6IuQwSYdpAMcPpAERpqVuobmqmVSQ",
  authDomain:"repertorioworship.firebaseapp.com",
  projectId:"repertorioworship",
  storageBucket:"repertorioworship.firebasestorage.app",
  messagingSenderId:"493050453266",
  appId:"1:493050453266:web:cf07ce9fbb471122f167cb"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let modoEdicion=false, cancionesCache=[], registroCache={}, debounceTimer, cancionesVisible=false, ordenActual={campo:'titulo',sentido:'desc'};

function normalizar(text){return (text||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();}
function resaltar(text,q){if(!q)return text;try{const r=new RegExp(`(${q})`,"gi");return text.replace(r,"<mark>$1</mark>");}catch(e){return text;}}

/* === CANCIONES === */
async function inicializarCanciones(){
  onSnapshot(collection(db,"canciones"),snap=>{
    cancionesCache=snap.docs.map(d=>({id:d.id,...d.data()}));
    cargarCanciones();
    if(document.getElementById("registro-canciones").style.display==="block") cargarRegistro();
  });
}

function construirCard(d){
  const div=document.createElement("div");
  div.className="card";
  div.innerHTML=`<h2 contenteditable="${modoEdicion}">${modoEdicion?d.titulo:resaltar(d.titulo,document.getElementById('search').value)}</h2>
  <p contenteditable="${modoEdicion}">${modoEdicion?(d.acordes||""):(d.acordes||"")}</p>
  <textarea style="display:${modoEdicion?"block":"none"}" placeholder="Links de im√°genes (uno por l√≠nea)">${(d.imagenes||[]).join("\n")}</textarea>
  <input style="display:${modoEdicion?"block":"none"}" value="${d.audio||""}" placeholder="Link de audio">
  <input style="display:${modoEdicion?"block":"none"}" value="${d.youtube||""}" placeholder="Link de YouTube">
  ${(d.imagenes||[]).map(u=>`<img src="${u}" width="100%" style="margin-top:8px;border-radius:8px;">`).join('')}
  ${!modoEdicion && d.audio?`<a class="link-btn" href="${d.audio}" target="_blank">üéß Escuchar</a>`:""}
  ${!modoEdicion && d.youtube?`<a class="link-btn" href="${d.youtube}" target="_blank">üì∫ YouTube</a>`:""}
  ${modoEdicion?`<div style="margin-top:8px"><button class="small-btn" onclick="guardarEdicion('${d.id}',this)">üíæ Guardar cambios</button></div>`:""}`;
  return div;
}

async function cargarCanciones(){
  const cont=document.getElementById("lista-canciones"); cont.innerHTML="";
  const s=normalizar(document.getElementById("search").value||"");
  cancionesCache.forEach(d=>{if(!normalizar(d.titulo).includes(s)) return; cont.appendChild(construirCard(d));});
  const searchActive=s.length>0; cont.style.display=cancionesVisible||searchActive?"block":"none";
  document.getElementById("contador").textContent=`üéµ Total de canciones: ${cancionesCache.length}`;
}

async function agregarCancion(){
  const titulo=document.getElementById("titulo").value.trim();
  if(!titulo) return alert("El t√≠tulo es obligatorio");
  await addDoc(collection(db,"canciones"),{
    titulo,
    acordes: document.getElementById("acordes").value.trim(),
    imagenes: document.getElementById("imagenes").value.trim().split("\n").filter(x=>x),
    audio: document.getElementById("audio").value.trim(),
    youtube: document.getElementById("youtube").value.trim()
  });
  document.getElementById("formulario").reset();
  document.getElementById("formulario").style.display="none";
}

async function guardarEdicion(id,btn){
  const card=btn.closest(".card");
  const [tituloEl,acordesEl,imagenesEl,audioEl,youtubeEl]=card.querySelectorAll("h2,p,textarea,input:nth-of-type(1),input:nth-of-type(2)");
  const titulo=tituloEl.innerText.trim(),acordes=acordesEl.innerText.trim();
  const imagenes=imagenesEl.value.trim().split("\n").filter(x=>x),audio=audioEl.value.trim(),youtube=youtubeEl.value.trim();
  await updateDoc(doc(db,"canciones",id),{titulo,acordes,imagenes,audio,youtube});
  alert("‚úÖ Cambios guardados");
}

/* === SECCIONES semana/mes === */
async function cargarSeccion(tipo){
  try{
    const snap=await getDoc(doc(db,"secciones",tipo));
    const cont=document.getElementById(`mostrar-${tipo}`);
    if(snap.exists()){
      const data=snap.data();
      cont.innerHTML=`<h3>${data.titulo||""}</h3><ul>${(data.canciones||[]).map(c=>`<li>${c}</li>`).join("")}</ul>`;
    } else cont.innerHTML="<p>A√∫n no hay informaci√≥n guardada.</p>";
    document.getElementById(`contenedor-${tipo}`).style.display=modoEdicion?"block":"none";
  } catch(e){console.error("Error cargarSeccion:",e);}
}
async function guardarSeccion(tipo){
  const titulo=document.getElementById(`titulo-${tipo}`).value.trim();
  const canciones=document.getElementById(`canciones-${tipo}`).value.trim().split("\n").filter(x=>x);
  await setDoc(doc(db,"secciones",tipo),{titulo,canciones});
  alert("‚úÖ Secci√≥n guardada");
  cargarSeccion(tipo);
}

/* === MODO EDICION === */
function activarEdicion(){
  const addBtn=document.getElementById("btnAgregar");
  if(!modoEdicion){
    const pin=prompt("Introduce el PIN para editar:");
    if(pin==="2025"){
      modoEdicion=true;document.querySelector(".edit-banner").style.display="block";addBtn.style.display="block";alert("‚úèÔ∏è Modo edici√≥n activado");
    } else if(pin){alert("PIN incorrecto"); return;}
  } else {modoEdicion=false;document.querySelector(".edit-banner").style.display="none";addBtn.style.display="none";alert("üîí Modo edici√≥n desactivado");}
  cargarSeccion("semana"); cargarSeccion("mes"); cargarCanciones(); cargarRegistro();
}

/* === B√öSQUEDA === */
function debounceBuscar(){clearTimeout(debounceTimer);debounceTimer=setTimeout(cargarCanciones,300);}

/* === TOGGLES UI === */
function toggleDark(){document.body.classList.toggle("dark");localStorage.setItem("theme",document.body.classList.contains("dark")?"dark":"light");}
function toggleFormulario(){const f=document.getElementById("formulario");f.style.display=f.style.display==="none"?"block":"none";}
function toggleCanciones(){cancionesVisible=!cancionesVisible;document.getElementById("toggleCancionesBtn").textContent=cancionesVisible?"üéµ Ocultar lista":"üéµ Mostrar lista";cargarCanciones();}
async function toggleRegistro(){const el=document.getElementById("registro-canciones");el.style.display=el.style.display==="block"?"none":"block";if(el.style.display==="block") await cargarRegistro();}

/* === REGISTRO === */
async function cargarRegistro(){
  registroCache={};
  try{(await getDocs(collection(db,"registro"))).forEach(d=>{registroCache[d.id]=d.data();});}catch(e){console.warn("No hay registros o error:",e);}
  const combinado=cancionesCache.map(c=>{const r=registroCache[c.id]||{veces:0,fechas:[]};return{id:c.id,titulo:c.titulo||"Sin t√≠tulo",veces:Number(r.veces||0),fechas:Array.isArray(r.fechas)?r.fechas:[]};});
  combinado.sort((a,b)=>{
    const campo=ordenActual.campo,sentido=ordenActual.sentido==="asc"?1:-1;
    if(campo==="veces") return (a.veces-b.veces)*sentido;
    if(campo==="ultima"){const da=a.fechas.length?Date.parse(a.fechas[a.fechas.length-1]):0,dbt=b.fechas.length?Date.parse(b.fechas[b.fechas.length-1]):0;return(da-dbt)*sentido;}
    return a.titulo.localeCompare(b.titulo)*sentido;
  });

  const tbody=document.querySelector("#tabla-registro tbody");tbody.innerHTML="";
  combinado.forEach(r=>{
    const fechasHtml=r.fechas.map((f,idx)=>`<input type="date" class="small-btn" value="${f}" onchange="editarFecha('${r.id}',${idx},this.value)">`).join("");
    const addBtn=modoEdicion?`<button class="small-btn" onclick="agregarFecha('${r.id}')">‚ûï A√±adir fecha</button>`:"";
    const acciones=modoEdicion?`<button class="small-btn" onclick="borrarRegistro('${r.id}')">üóëÔ∏è Borrar</button> <button class="small-btn" onclick="guardarRegistro('${r.id}',this)">üíæ Guardar</button>`:"";
    const tr=document.createElement("tr");
    tr.innerHTML=`<td style="text-align:left">${r.titulo}</td><td contenteditable="${modoEdicion}">${r.veces}</td><td class="fechas-box">${fechasHtml}${addBtn}</td><td>${acciones}</td>`;
    tbody.appendChild(tr);
  });
}

async function agregarFecha(id){
  const nueva=prompt("Introduce la nueva fecha (YYYY-MM-DD):"); if(!nueva) return;
  const ref=doc(db,"registro",id); const snap=await getDoc(ref); const data=snap.exists()?snap.data():{veces:0,fechas:[]};
  const nuevas=Array.isArray(data.fechas)?[...data.fechas,nueva]:[nueva];
  await setDoc(ref,{veces:nuevas.length,fechas:nuevas}); await cargarRegistro();
}

async function editarFecha(id,index,valor){
  const ref=doc(db,"registro",id); const snap=await getDoc(ref); if(!snap.exists()) return;
  const data=snap.data(); if(!Array.isArray(data.fechas)) data.fechas=[];
  data.fechas[index]=valor;
  await setDoc(ref,{veces:data.fechas.length,fechas:data.fechas});
}

async function borrarRegistro(id){if(!confirm("¬øSeguro que quieres borrar el registro completo?")) return;await setDoc(doc(db,"registro",id),{veces:0,fechas:[]});cargarRegistro();}
async function guardarRegistro(id,btn){const row=btn.closest("tr");const veces=parseInt(row.querySelectorAll("td")[1].innerText.trim())||0;const ref=doc(db,"registro",id);const snap=await getDoc(ref);const data=snap.exists()?snap.data():{fechas:[]};await setDoc(ref,{veces,fechas:Array.isArray(data.fechas)?data.fechas:[]});alert("‚úÖ Registro guardado");cargarRegistro();}
function setOrden(campo){if(ordenActual.campo===campo) ordenActual.sentido=ordenActual.sentido==="asc"?"desc":"asc";else{ordenActual.campo=campo;ordenActual.sentido="desc";}cargarRegistro();}

/* === BOOT === */
window.addEventListener("load",()=>{
  const saved=localStorage.getItem("theme"); if(saved==="dark") document.body.classList.add("dark");
  const searchInput=document.getElementById("search"),clearBtn=document.getElementById("clearSearch");
  searchInput.addEventListener("input",()=>{debounceBuscar(); clearBtn.style.display=searchInput.value?"block":"none";});
  clearBtn.addEventListener("click",()=>{searchInput.value=""; clearBtn.style.display="none"; cargarCanciones();});
  inicializarCanciones(); cargarSeccion("semana"); cargarSeccion("mes");
  window.agregarCancion=agregarCancion; window.guardarEdicion=guardarEdicion; window.toggleDark=toggleDark; window.toggleFormulario=toggleFormulario;
  window.activarEdicion=activarEdicion; window.guardarSeccion=guardarSeccion; window.toggleCanciones=toggleCanciones; window.toggleRegistro=toggleRegistro;
  window.agregarFecha=agregarFecha; window.editarFecha=editarFecha; window.borrarRegistro=borrarRegistro; window.guardarRegistro=guardarRegistro;
  window.setOrden=setOrden;
});
</script>
</body>
</html>