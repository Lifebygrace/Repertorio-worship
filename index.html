<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Repertorio Worship</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }
    :root {
      --bg: #111;
      --text: #eee;
      --accent: #2196f3;
      --section-bg: #1b1b1b;
    }
    header, footer {
      text-align: center;
      padding: 10px;
      background: var(--section-bg);
    }
    h1, h2 { color: var(--accent); }
    .section {
      background: var(--section-bg);
      margin: 10px auto;
      padding: 15px;
      max-width: 900px;
      border-radius: 8px;
    }
    button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { opacity: 0.85; }
    .song { border-bottom: 1px solid #333; padding: 6px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #333; padding: 5px; text-align: center; }
    th { background: var(--accent); color: white; }
    ul.fechas-lista { list-style: none; padding: 0; margin: 0; }
    ul.fechas-lista li {
      border-bottom: 1px solid #333;
      padding: 2px 0;
    }
    footer div { display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
  </style>
</head>
<body>

  <header>
    <h1>üé∂ Repertorio Worship</h1>
    <button onclick="toggleModoEdicion()">‚úèÔ∏è Modo edici√≥n</button>
  </header>

  <div class="section" id="lista-canciones">
    <h2>üéµ Canciones</h2>
    <div id="canciones"></div>
  </div>

  <footer>
    <p id="contador">üéµ Total de canciones: 0</p>
    <div>
      <button onclick="window.scrollTo({top:0, behavior:'smooth'})">‚¨ÜÔ∏è Volver al inicio</button>
      <button onclick="toggleRegistro()">üìä Registro de canciones</button>
    </div>
  </footer>

  <div id="registro-canciones" class="section" style="display:none;">
    <h2>üìã Registro de canciones</h2>
    <table id="tabla-registro">
      <thead>
        <tr>
          <th>T√≠tulo</th>
          <th>Veces tocada</th>
          <th>Fechas</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDahT6IuQwSYdpAMcPpAERpqVuobmqmVSQ",
      authDomain: "repertorioworship.firebaseapp.com",
      projectId: "repertorioworship",
      storageBucket: "repertorioworship.firebasestorage.app",
      messagingSenderId: "493050453266",
      appId: "1:493050453266:web:cf07ce9fbb471122f167cb",
      measurementId: "G-RB3G81DQQ1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let cancionesCache = [];
    let modoEdicion = false;

    async function cargarCanciones() {
      const querySnapshot = await getDocs(collection(db, "canciones"));
      cancionesCache = [];
      querySnapshot.forEach(docu => {
        const data = docu.data();
        cancionesCache.push({ id: docu.id, ...data });
      });
      mostrarCanciones();
    }

    function mostrarCanciones() {
      const div = document.getElementById("canciones");
      div.innerHTML = "";
      cancionesCache.forEach(c => {
        const el = document.createElement("div");
        el.className = "song";
        el.innerHTML = `<strong>${c.titulo}</strong>`;
        div.appendChild(el);
      });
      document.getElementById("contador").innerText =
        "üéµ Total de canciones: " + cancionesCache.length;
    }

    async function toggleRegistro(){
      const div = document.getElementById("registro-canciones");
      const visible = div.style.display === "block";
      div.style.display = visible ? "none" : "block";
      if(!visible) await cargarRegistro();
    }

    async function cargarRegistro(){
      const tbody = document.querySelector("#tabla-registro tbody");
      tbody.innerHTML = "";
      for(const c of cancionesCache){
        const regRef = doc(db, "registro", c.id);
        const snap = await getDoc(regRef);
        const data = snap.exists() ? snap.data() : {veces:0, fechas:[]};

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${c.titulo}</td>
          <td>${data.veces}</td>
          <td class="fechas-box">
            <ul class="fechas-lista">
              ${data.fechas.map(f => `<li>${f}</li>`).join("")}
            </ul>
            ${modoEdicion ? `<button onclick="agregarFecha('${c.id}')">‚ûï A√±adir fecha</button>` : ""}
          </td>
          <td>${modoEdicion ? `<button onclick="borrarRegistro('${c.id}')">üóëÔ∏è Borrar registro</button>` : ""}</td>
        `;
        tbody.appendChild(row);
      }
    }

    async function agregarFecha(id){
      const hoy = new Date().toISOString().split("T")[0];
      const regRef = doc(db, "registro", id);
      const snap = await getDoc(regRef);
      const data = snap.exists() ? snap.data() : {veces:0, fechas:[]};
      const nuevasFechas = data.fechas ? [...data.fechas, hoy] : [hoy];
      await setDoc(regRef, {veces: (data.veces || 0) + 1, fechas: nuevasFechas});
      await cargarRegistro();
    }

    async function borrarRegistro(id){
      if(confirm("¬øSeguro que quieres borrar este registro?")){
        await setDoc(doc(db, "registro", id), {veces:0, fechas:[]});
        await cargarRegistro();
      }
    }

    function toggleModoEdicion(){
      if(!modoEdicion){
        const pin = prompt("üîí Ingresa el PIN de administrador:");
        if(pin === "2025"){
          modoEdicion = true;
          alert("‚úÖ Modo edici√≥n activado");
        } else {
          alert("‚ùå PIN incorrecto");
          return;
        }
      } else {
        modoEdicion = false;
        alert("üõë Modo edici√≥n desactivado");
      }
      if(document.getElementById("registro-canciones").style.display === "block"){
        cargarRegistro();
      }
    }

    window.toggleRegistro = toggleRegistro;
    window.agregarFecha = agregarFecha;
    window.toggleModoEdicion = toggleModoEdicion;
    window.borrarRegistro = borrarRegistro;

    cargarCanciones();
  </script>

</body>
</html>