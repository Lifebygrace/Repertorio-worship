<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Repertorio Worship</title>
<style>
:root{
  --primary:#002244;--accent:#ff8c42;--bg:#f0f4f8;--text:#002244;
  --section-bg:#fff8e1;--card-bg:#ffffff;--edit-bg:#FFEB3B;
}
body.dark{--bg:#121212;--text:#f0f4f8;--card-bg:#1e1e1e;--section-bg:#2a2a2a;--edit-bg:#f9a825}
html,body{height:100%;margin:0;padding:0}
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--text);transition:background .2s,color .2s}
header{background:var(--primary);color:#fff;padding:14px 18px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:12px}
.logo img{height:48px;border-radius:8px}
.controls{display:flex;gap:8px;align-items:center}
button{background:var(--accent);color:#fff;border:0;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}
button.small {padding:4px 8px;font-size:.85rem}
main{max-width:980px;margin:18px auto;padding:12px}
.card{background:var(--card-bg);padding:12px;border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.06);margin-bottom:12px}
.section{background:var(--section-bg);padding:12px;border-radius:8px;margin-bottom:12px}
input[type="text"], input[type="url"], textarea{width:100%;padding:10px;margin:6px 0;border-radius:8px;border:1px solid #ccc;background:transparent;color:inherit}
.search-container{position:relative;margin-bottom:14px}
#search{padding:12px 44px 12px 12px;border-radius:10px;border:2px solid var(--accent);font-size:1rem}
#clearSearch{position:absolute;right:10px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:var(--accent);font-size:1.1rem;display:none}
.link-btn{display:inline-block;background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none;margin-right:6px}
.edit-banner{position:sticky;top:0;background:var(--edit-bg);padding:8px;text-align:center;font-weight:bold;display:none;z-index:50;border-bottom:1px solid rgba(0,0,0,.06)}
.table{width:100%;border-collapse:collapse;margin-top:8px}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid #ddd;padding:6px;text-align:center}
th{background:var(--accent);color:#fff;cursor:pointer}
.meta-line{font-size:.9rem;color:#444;display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
.tocada-btn{background:#0077cc;padding:6px 8px;border-radius:6px;color:#fff;border:0;cursor:pointer}
.counter-small{font-size:.95rem;color:#444;opacity:.85}
.fechas-box{min-width:160px;text-align:left}
.small{font-size:0.8rem;padding:4px 6px;border-radius:6px;margin-left:6px}
.footer-center{text-align:center;margin-top:20px;color:#555;opacity:.9}
</style>
</head>
<body>
<div class="edit-banner">‚úèÔ∏è Modo edici√≥n activo</div>

<header>
  <div class="logo">
    <img src="https://raw.githubusercontent.com/Lifebygrace/Repertorio-worship/main/logo.jpeg" alt="Logo" />
    <div><strong>Repertorio Worship</strong></div>
  </div>
  <div class="controls">
    <button onclick="toggleDark()" title="Modo oscuro/claro">üåô / ‚òÄÔ∏è</button>
    <button onclick="activarEdicion()" title="Activar/desactivar edici√≥n">‚úèÔ∏è Editar</button>
    <button onclick="window.open('https://www.metronomeonline.com','_blank')" title="Abrir metr√≥nomo">üïí Metr√≥nomo</button>
    <button id="toggleCancionesBtn" onclick="toggleCanciones()" title="Mostrar/ocultar lista">üéµ Mostrar lista</button>
  </div>
</header>

<main>
  <div class="search-container">
    <input id="search" placeholder="üîç Buscar canciones por t√≠tulo..." />
    <button id="clearSearch" title="Limpiar b√∫squeda">‚ùå</button>
  </div>

  <div class="section">
    <h3>üé∂ Canciones para la semana</h3>
    <div id="contenedor-semana" style="display:none;">
      <input id="titulo-semana" placeholder="T√≠tulo (ej. Semana del 7 al 13 de octubre)" />
      <textarea id="canciones-semana" placeholder="Canciones (una por l√≠nea)"></textarea>
      <button onclick="guardarSeccion('semana')">Guardar secci√≥n</button>
    </div>
    <div id="mostrar-semana" style="margin-top:8px"></div>
  </div>

  <div class="section">
    <h3>üÜï Canciones nuevas del mes</h3>
    <div id="contenedor-mes" style="display:none;">
      <input id="titulo-mes" placeholder="T√≠tulo (ej. Octubre 2025)" />
      <textarea id="canciones-mes" placeholder="Canciones (una por l√≠nea)"></textarea>
      <button onclick="guardarSeccion('mes')">Guardar secci√≥n</button>
    </div>
    <div id="mostrar-mes" style="margin-top:8px"></div>
  </div>

  <div style="margin:10px 0">
    <button id="btnAgregar" onclick="toggleFormulario()" style="display:none">‚ûï Agregar nueva canci√≥n</button>
  </div>

  <form id="formulario" onsubmit="event.preventDefault(); agregarCancion();" style="display:none">
    <div class="card">
      <h4>Agregar canci√≥n</h4>
      <input id="titulo" placeholder="T√≠tulo" required />
      <textarea id="acordes" placeholder="Acordes (texto)"></textarea>
      <textarea id="imagenes" placeholder="Links de im√°genes (uno por l√≠nea)"></textarea>
      <input id="audio" placeholder="Link de audio (mp3/url)" />
      <input id="youtube" placeholder="Link de YouTube" />
      <div style="margin-top:8px"><button type="submit">Guardar canci√≥n</button></div>
    </div>
  </form>

  <div id="lista-canciones" style="display:none;margin-top:12px"></div>

  <div id="registro-canciones-container" style="margin-top:12px">
    <button style="background:var(--accent)" onclick="toggleRegistro()">üìä Registro de canciones</button>
    <div id="registro-canciones" class="section" style="display:none;margin-top:8px">
      <h4>üìã Registro de canciones</h4>
      <table id="tabla-registro">
        <thead>
          <tr>
            <th onclick="setOrden('titulo')">T√≠tulo <span id="sortTitulo"></span></th>
            <th onclick="setOrden('veces')">Veces tocada <span id="sortVeces"></span></th>
            <th onclick="setOrden('ultima')">√öltima fecha <span id="sortUltima"></span></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="footer-center">
    <div id="contadorFinal" class="counter-small">üé∂ Canciones totales: 0</div>
    <div style="margin-top:10px"><button onclick="window.scrollTo({top:0, behavior:'smooth'})">‚¨ÜÔ∏è Volver al inicio</button></div>
  </div>
</main>

<script type="module">
/* ---------- Firebase imports & config ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, deleteDoc, onSnapshot, getDocs
} from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDahT6IuQwSYdpAMcPpAERpqVuobmqmVSQ",
  authDomain: "repertorioworship.firebaseapp.com",
  projectId: "repertorioworship",
  storageBucket: "repertorioworship.firebasestorage.app",
  messagingSenderId: "493050453266",
  appId: "1:493050453266:web:cf07ce9fbb471122f167cb"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- Estado local ---------- */
let modoEdicion = false;
let cancionesCache = []; // array de {id, titulo, acordes, imagenes[], audio, youtube}
let registroCache = {};  // cache de docs registro
let debounceTimer;
let cancionesVisible = false;
let ordenActual = { campo: 'titulo', sentido: 'desc' };

/* ---------- Utilidades ---------- */
function normalizar(t){ return (t||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase(); }
function resaltar(t,q){ if(!q) return t; try{ const r=new RegExp(`(${q})`,'gi'); return t.replace(r,'<mark>$1</mark>'); } catch(e){ return t; } }
function pad(n){ return String(n).padStart(2,'0'); }
function isoToday(){ const d=new Date(); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function isoToDisplay(iso){ if(!iso) return '‚Äî'; if(/^\d{4}-\d{2}-\d{2}$/.test(iso)){ const [y,m,d]=iso.split('-'); return `${d}/${m}/${y}`;} const dt=new Date(iso); if(isNaN(dt.getTime())) return iso; return `${pad(dt.getDate())}/${pad(dt.getMonth()+1)}/${dt.getFullYear()}`; }

/* ---------- Inicializaci√≥n (realtime) ---------- */
function inicializarCanciones(){
  const col = collection(db, "canciones");
  onSnapshot(col, snap => {
    cancionesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    // normalize some fields to avoid undefined
    cancionesCache = cancionesCache.map(c => ({
      id: c.id,
      titulo: c.titulo || '',
      acordes: c.acordes || '',
      imagenes: Array.isArray(c.imagenes) ? c.imagenes : [],
      audio: c.audio || '',
      youtube: c.youtube || '',
      veces: Number(c.veces || 0),
      ultima: c.ultima || ''
    }));
    actualizarContador();
    cargarCanciones();
    if(document.getElementById("registro-canciones").style.display === "block") cargarRegistro();
  });
}

/* ---------- Contador (final) ---------- */
function actualizarContador(){
  const el = document.getElementById("contadorFinal");
  const n = cancionesCache.length || 0;
  el.textContent = `üé∂ Canciones totales: ${n}`;
}

/* ---------- Construcci√≥n de tarjeta (editable) ---------- */
function construirCard(c){
  const div = document.createElement('div');
  div.className = 'card';
  if(modoEdicion){
    // inputs con clases para recoger al guardar
    div.innerHTML = `
      <input class="edit-titulo" type="text" value="${escapeHtml(c.titulo)}" placeholder="T√≠tulo" />
      <textarea class="edit-acordes" placeholder="Acordes">${escapeHtml(c.acordes)}</textarea>
      <textarea class="edit-imagenes" placeholder="Links de im√°genes (uno por l√≠nea)">${(c.imagenes||[]).join('\n')}</textarea>
      <input class="edit-audio" type="url" value="${escapeHtml(c.audio)}" placeholder="Link de audio" />
      <input class="edit-youtube" type="url" value="${escapeHtml(c.youtube)}" placeholder="Link de YouTube" />
      <div class="meta-line">
        <span id="plays-${c.id}" class="counter-small">üéµ Veces tocada: ${c.veces||0}</span>
        <span id="last-${c.id}" class="counter-small">| √öltima vez: ${c.ultima?isoToDisplay(c.ultima):'‚Äî'}</span>
        <button class="tocada-btn" id="tocadaBtn-${c.id}">Tocada +1</button>
      </div>
      <div style="margin-top:8px">
        <button onclick="guardarEdicion('${c.id}', this)">üíæ Guardar</button>
        <button onclick="borrarCancion('${c.id}')">üóëÔ∏è Borrar</button>
      </div>
    `;
    // bind tocar +1 (necesario porque el bot√≥n se crea din√°micamente)
    setTimeout(()=>{ const b = document.getElementById(`tocadaBtn-${c.id}`); if(b) b.onclick = ()=> marcarTocada(c.id); }, 0);
  } else {
    div.innerHTML = `
      <h3>${resaltar(escapeHtml(c.titulo), document.getElementById("search").value)}</h3>
      <div><pre style="white-space:pre-wrap;margin:6px 0">${escapeHtml(c.acordes)}</pre></div>
      <div class="meta-line">
        <span id="plays-${c.id}" class="counter-small">üéµ Veces tocada: ${c.veces||0}</span>
        <span id="last-${c.id}" class="counter-small">| √öltima vez: ${c.ultima?isoToDisplay(c.ultima):'‚Äî'}</span>
      </div>
      <div style="margin-top:8px">
        ${(c.imagenes||[]).map(u=>`<img src="${escapeHtml(u)}" style="width:100%;margin-top:8px;border-radius:8px;">`).join('')}
      </div>
      <div style="margin-top:8px">
        ${c.audio?`<a class="link-btn" href="${escapeHtml(c.audio)}" target="_blank">üéß Escuchar</a>`:''}
        ${c.youtube?`<a class="link-btn" href="${escapeHtml(c.youtube)}" target="_blank">üì∫ YouTube</a>`:''}
      </div>
    `;
  }
  // actualizar indicadores si hay registro ya
  actualizarRegistroCard(c.id);
  return div;
}

/* escape b√°sico para inyectar en value/textarea sin romper HTML */
function escapeHtml(s){
  if(!s) return '';
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;');
}

/* ---------- Cargar lista visible ---------- */
function cargarCanciones(){
  const cont = document.getElementById('lista-canciones');
  cont.innerHTML = '';
  const q = (document.getElementById('search').value || '').trim();
  const s = normalizar(q);
  cancionesCache.forEach(c => {
    if(s && !normalizar(c.titulo).includes(s)) return;
    cont.appendChild(construirCard(c));
  });
  cont.style.display = cancionesVisible || s.length>0 ? 'block' : 'none';
}

/* ---------- Agregar / Guardar edici√≥n / Borrar ---------- */
async function agregarCancion(){
  const titulo = document.getElementById('titulo').value.trim();
  if(!titulo) return alert('El t√≠tulo es obligatorio');
  const acordes = document.getElementById('acordes').value.trim();
  const imagenes = document.getElementById('imagenes').value.split('\n').map(x=>x.trim()).filter(Boolean);
  const audio = document.getElementById('audio').value.trim();
  const youtube = document.getElementById('youtube').value.trim();
  await addDoc(collection(db,'canciones'),{
    titulo, acordes, imagenes, audio, youtube, veces:0, ultima: ''
  });
  document.getElementById('formulario').reset();
  document.getElementById('formulario').style.display='none';
}

async function guardarEdicion(id, btn){
  try{
    const card = btn.closest('.card');
    // los inputs/textarea est√°n dentro de la card
    const titulo = card.querySelector('.edit-titulo').value.trim();
    const acordes = card.querySelector('.edit-acordes').value.trim();
    const imagenes = (card.querySelector('.edit-imagenes').value || '').split('\n').map(x=>x.trim()).filter(Boolean);
    const audio = card.querySelector('.edit-audio').value.trim();
    const youtube = card.querySelector('.edit-youtube').value.trim();
    // actualizamos parcialmente el doc (usa updateDoc para no sobreescribir campos extra)
    await updateDoc(doc(db,'canciones',id), { titulo, acordes, imagenes, audio, youtube });
    alert('‚úÖ Cambios guardados');
  } catch(e){
    console.error('guardarEdicion:', e);
    alert('Error al guardar. Mira la consola.');
  }
}

async function borrarCancion(id){
  if(!confirm('¬øBorrar canci√≥n (esto eliminar√° tambi√©n su registro)?')) return;
  try{
    await deleteDoc(doc(db,'canciones',id));
    // borrar registro si existe
    try{ await deleteDoc(doc(db,'registro',id)); } catch(e){ /* ignore if not exists */ }
    // onSnapshot actualizar√° la UI, pero forzamos recarga
    actualizarContador();
    cargarCanciones();
    if(document.getElementById('registro-canciones').style.display==='block') cargarRegistro();
    alert('‚úÖ Canci√≥n y registro (si exist√≠a) eliminados.');
  } catch(e){
    console.error('borrarCancion:', e);
    alert('Error al borrar. Mira la consola.');
  }
}

/* ---------- Funci√≥n "Tocada +1" que guarda en colecci√≥n registro ---------- */
async function marcarTocada(songId){
  try{
    const ref = doc(db,'registro',songId);
    const snap = await getDoc(ref);
    let data = snap.exists() ? snap.data() : { veces:0, fechas:[] };
    const fechas = Array.isArray(data.fechas) ? [...data.fechas] : [];
    const hoy = isoToday();
    fechas.push(hoy);
    await setDoc(ref, { veces: fechas.length, fechas });
    // Also update simple summary on canciones collection (veces + ultima) to show in cards/table
    await updateDoc(doc(db,'canciones',songId), { veces: fechas.length, ultima: hoy });
    actualizarRegistroCard(songId);
    if(document.getElementById('registro-canciones').style.display==='block') cargarRegistro();
  } catch(e){
    console.error('marcarTocada:', e);
    alert('Error al marcar tocada. Revisa consola.');
  }
}

/* ---------- Actualizar tarjeta con datos desde collection registro (si se usa) ---------- */
async function actualizarRegistroCard(id){
  try{
    // Prefer showing times stored in canciones collection (sin llamar extra), but keep fallback to registro collection
    const c = cancionesCache.find(x=>x.id===id);
    const playsEl = document.getElementById(`plays-${id}`);
    const lastEl = document.getElementById(`last-${id}`);
    if(!playsEl || !lastEl) return;
    if(c){
      playsEl.textContent = `üéµ Veces tocada: ${Number(c.veces||0)}`;
      lastEl.textContent = `| √öltima vez: ${c.ultima ? isoToDisplay(c.ultima) : '‚Äî'}`;
      return;
    }
    // fallback:
    const ref = doc(db,'registro',id);
    const snap = await getDoc(ref);
    if(!snap.exists()){
      playsEl.textContent = `üéµ Veces tocada: 0`;
      lastEl.textContent = `| √öltima vez: ‚Äî`;
      return;
    }
    const data = snap.data();
    playsEl.textContent = `üéµ Veces tocada: ${Number(data.veces||0)}`;
    lastEl.textContent = `| √öltima vez: ${data.fechas && data.fechas.length ? isoToDisplay(data.fechas[data.fechas.length-1]) : '‚Äî'}`;
  } catch(e){
    console.error('actualizarRegistroCard:', e);
  }
}

/* ---------- Registro (tabla) ---------- */
async function cargarRegistro(){
  registroCache = {};
  const snap = await getDocs(collection(db,'registro'));
  snap.forEach(d=> registroCache[d.id] = d.data() );
  // combinar con cancionesCache para mostrar t√≠tulo
  const combinado = cancionesCache.map(c => {
    const r = registroCache[c.id] || { veces:0, fechas:[] };
    return { id: c.id, titulo: c.titulo||'Sin t√≠tulo', veces: Number(r.veces||0), fechas: Array.isArray(r.fechas)?r.fechas:[] };
  });
  // ordenar
  combinado.sort((a,b)=>{
    const campo = ordenActual.campo;
    const sentido = ordenActual.sentido === 'asc' ? 1 : -1;
    if(campo === 'veces') return (a.veces - b.veces) * sentido;
    if(campo === 'ultima'){
      const da = a.fechas.length ? a.fechas[a.fechas.length-1] : '';
      const db = b.fechas.length ? b.fechas[b.fechas.length-1] : '';
      return ( (da||'') < (db||'') ? -1 : ((da||'') > (db||'') ? 1 : 0) ) * sentido;
    }
    return a.titulo.localeCompare(b.titulo) * sentido;
  });
  const tbody = document.querySelector('#tabla-registro tbody');
  tbody.innerHTML = '';
  combinado.forEach(r=>{
    const tr = document.createElement('tr');
    const ultima = r.fechas.length ? isoToDisplay(r.fechas[r.fechas.length-1]) : '';
    const fechasHtml = r.fechas.length > 1 ? `<button class="small" onclick="alert('Historial de fechas:\\n${r.fechas.join('\\n')}')">Ver m√°s</button>` : '';
    tr.innerHTML = `<td style="text-align:left">${escapeHtml(r.titulo)}</td><td>${r.veces}</td><td class="fechas-box">${ultima} ${fechasHtml}</td>`;
    tbody.appendChild(tr);
  });
  // indicadores de orden
  document.getElementById('sortTitulo').textContent = ordenActual.campo==='titulo' ? (ordenActual.sentido==='asc'?'üîº':'üîΩ') : '';
  document.getElementById('sortVeces').textContent = ordenActual.campo==='veces' ? (ordenActual.sentido==='asc'?'üîº':'üîΩ') : '';
  document.getElementById('sortUltima').textContent = ordenActual.campo==='ultima' ? (ordenActual.sentido==='asc'?'üîº':'üîΩ') : '';
}

/* ---------- Fechas (edici√≥n en registro) ---------- */
async function agregarFechaManual(id){
  const fecha = prompt('Introduce la fecha (YYYY-MM-DD):');
  if(!fecha) return;
  const ref = doc(db,'registro',id);
  const snap = await getDoc(ref);
  const data = snap.exists() ? snap.data() : { veces:0, fechas:[] };
  const nuevas = Array.isArray(data.fechas) ? [...data.fechas, fecha] : [fecha];
  await setDoc(ref, { veces: nuevas.length, fechas: nuevas });
  cargarRegistro();
}
async function borrarFecha(id, idx){
  if(!confirm('Borrar esta fecha?')) return;
  const ref = doc(db,'registro',id);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const data = snap.data();
  const nuevas = Array.isArray(data.fechas) ? data.fechas.filter((_,i)=>i!==idx) : [];
  await setDoc(ref, { veces: nuevas.length, fechas: nuevas });
  cargarRegistro();
}
async function modificarFecha(id, idx, val){
  const ref = doc(db,'registro',id);
  const snap = await getDoc(ref);
  if(!snap.exists()) return;
  const data = snap.data();
  const nuevas = Array.isArray(data.fechas) ? [...data.fechas] : [];
  nuevas[idx] = val;
  await setDoc(ref, { veces: nuevas.length, fechas: nuevas });
  cargarRegistro();
}

/* ---------- Orden tabla ---------- */
function setOrden(campo){
  if(ordenActual.campo === campo) ordenActual.sentido = ordenActual.sentido === 'asc' ? 'desc' : 'asc';
  else { ordenActual.campo = campo; ordenActual.sentido = 'desc'; }
  cargarRegistro();
}

/* ---------- Secciones (semana/mes) ---------- */
async function cargarSeccion(tipo){
  try{
    const snap = await getDoc(doc(db,'secciones',tipo));
    const cont = document.getElementById(`mostrar-${tipo}`);
    if(snap.exists()){
      const data = snap.data();
      cont.innerHTML = `<strong>${escapeHtml(data.titulo||'')}</strong><ul>${(data.canciones||[]).map(x=>`<li>${escapeHtml(x)}</li>`).join('')}</ul>`;
    } else cont.innerHTML = '<p>A√∫n no hay informaci√≥n guardada.</p>';
    document.getElementById(`contenedor-${tipo}`).style.display = modoEdicion ? 'block' : 'none';
  } catch(e){ console.error('cargarSeccion', e); }
}
async function guardarSeccion(tipo){
  const titulo = document.getElementById(`titulo-${tipo}`).value.trim();
  const canciones = (document.getElementById(`canciones-${tipo}`).value || '').split('\n').map(x=>x.trim()).filter(Boolean);
  await setDoc(doc(db,'secciones',tipo), { titulo, canciones });
  alert('‚úÖ Secci√≥n guardada');
  cargarSeccion(tipo);
}

/* ---------- UI: toggles, b√∫squeda, etc ---------- */
function debounceBuscar(){ clearTimeout(debounceTimer); debounceTimer = setTimeout(()=>{ cargarCanciones(); document.getElementById('clearSearch').style.display = document.getElementById('search').value ? 'inline' : 'none'; }, 250); }
function toggleDark(){ document.body.classList.toggle('dark'); localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light'); }
function toggleFormulario(){ const f = document.getElementById('formulario'); f.style.display = f.style.display === 'block' ? 'none' : 'block'; }
function toggleCanciones(){ cancionesVisible = !cancionesVisible; document.getElementById('lista-canciones').style.display = cancionesVisible ? 'block' : 'none'; document.getElementById('toggleCancionesBtn').textContent = cancionesVisible ? 'üéµ Ocultar lista' : 'üéµ Mostrar lista'; }
function toggleRegistro(){ const el = document.getElementById('registro-canciones'); el.style.display = el.style.display === 'block' ? 'none' : 'block'; if(el.style.display === 'block') cargarRegistro(); }
function activarEdicion(){
  if(!modoEdicion){
    const pin = prompt('Introduce el PIN para editar:');
    if(pin === '2025'){ modoEdicion = true; document.querySelector('.edit-banner').style.display='block'; document.getElementById('btnAgregar').style.display='inline-block'; alert('‚úèÔ∏è Modo edici√≥n activado'); }
    else if(pin) alert('PIN incorrecto');
  } else { modoEdicion = false; document.querySelector('.edit-banner').style.display='none'; document.getElementById('btnAgregar').style.display='none'; alert('üîí Modo edici√≥n desactivado'); }
  cargarSeccion('semana'); cargarSeccion('mes'); cargarCanciones(); cargarRegistro();
}

/* ---------- Bindings ---------- */
document.getElementById('search').addEventListener('input', debounceBuscar);
document.getElementById('clearSearch').addEventListener('click', ()=>{ document.getElementById('search').value=''; document.getElementById('clearSearch').style.display='none'; cargarCanciones(); });

/* ---------- Startup ---------- */
window.addEventListener('load', ()=>{
  const saved = localStorage.getItem('theme');
  if(saved === 'dark') document.body.classList.add('dark');
  inicializarCanciones();
  cargarSeccion('semana'); cargarSeccion('mes');
  // exportar funciones para uso en HTML inline
  window.agregarCancion = agregarCancion;
  window.guardarEdicion = guardarEdicion;
  window.borrarCancion = borrarCancion;
  window.toggleDark = toggleDark;
  window.toggleFormulario = toggleFormulario;
  window.activarEdicion = activarEdicion;
  window.guardarSeccion = guardarSeccion;
  window.toggleCanciones = toggleCanciones;
  window.toggleRegistro = toggleRegistro;
  window.agregarFechaManual = agregarFechaManual;
  window.borrarFecha = borrarFecha;
  window.modificarFecha = modificarFecha;
  window.setOrden = setOrden;
  window.marcarTocada = marcarTocada;
  window.actualizarRegistroCard = actualizarRegistroCard;
});

/* ---------- helpers (getDoc alias to prevent extra import confusion) ---------- */
async function getDoc(ref){ return (await import("https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js")).getDoc(ref); }
async function setDocWrap(ref, data){ return (await import("https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js")).setDoc(ref, data); }

</script>
</body>
</html>