<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Repertorio Worship</title>
<style>
:root{
  --primary:#002244;--accent:#ff8c42;--bg:#f0f4f8;--text:#002244;
  --section-bg:#fff8e1;--card-bg:#ffffff;--edit-bg:#FFEB3B;
}
body.dark{--bg:#121212;--text:#f0f4f8;--card-bg:#1e1e1e;--section-bg:#2a2a2a;--edit-bg:#f9a825}
html,body{height:100%;margin:0;padding:0}
body{font-family:'Segoe UI',sans-serif;background:var(--bg);color:var(--text);transition:background .25s,color .25s}
header{background:var(--primary);color:#fff;padding:18px 20px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
.logo{display:flex;align-items:center;gap:12px}
.logo img{height:56px;border-radius:8px}
.controls{display:flex;gap:8px;align-items:center}
.controls button{flex:1;min-width:40px}
button{background:var(--accent);color:#fff;border:0;padding:6px 10px;border-radius:8px;cursor:pointer;font-weight:700}
button:hover{transform:scale(1.03)}
main{max-width:900px;margin:18px auto;padding:12px}
.card{background:var(--card-bg);padding:14px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08);margin-bottom:16px}
.section{background:var(--section-bg);padding:14px;border-radius:10px;margin-bottom:16px}
input,textarea{width:100%;padding:10px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;background:transparent;color:inherit}
.search-container{position:relative;margin-bottom:16px}
#search{padding:14px 44px 14px 14px;border-radius:10px;border:2px solid var(--accent);font-size:1.05rem}
#clearSearch{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:transparent;border:0;color:var(--accent);font-size:1.2rem;display:none}
.link-btn{display:inline-block;background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;text-decoration:none}
.edit-banner{position:sticky;top:0;background:var(--edit-bg);padding:8px;text-align:center;font-weight:bold;display:none;z-index:50}
footer{text-align:center;margin-top:24px;padding:16px;display:flex;flex-direction:column;align-items:center;gap:10px;flex-wrap:wrap}
table{width:100%;border-collapse:collapse;margin-top:8px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}
th{background:var(--accent);color:#fff;cursor:pointer}
ul.fechas-lista{list-style:none;padding:0;margin:0;text-align:left}
.fechas-box{min-width:180px}
.small {font-size:0.8rem;padding:4px 6px;border-radius:6px;margin-left:2px}
#contadorFinal{font-weight:700;color:#555;margin-bottom:8px}
@media(max-width:600px){.controls{flex-wrap:wrap}.controls button{flex:auto;min-width:45%}}
</style>
</head>
<body>
<div class="edit-banner">âœï¸ Modo ediciÃ³n activo</div>

<header>
  <div class="logo">
    <img src="https://raw.githubusercontent.com/Lifebygrace/Repertorio-worship/main/logo.jpeg" alt="Logo" />
    <h1>Repertorio Worship</h1>
  </div>
  <div class="controls">
    <button onclick="toggleDark()">ğŸŒ™ / â˜€ï¸</button>
    <button onclick="activarEdicion()">âœï¸ Editar</button>
    <button onclick="window.open('https://www.metronomeonline.com','_blank')">ğŸ•’ MetrÃ³nomo</button>
    <button id="toggleCancionesBtn" onclick="toggleCanciones()">ğŸµ Mostrar lista</button>
  </div>
</header>

<main>
  <div class="search-container">
    <input id="search" placeholder="ğŸ” Buscar canciones por tÃ­tulo..." />
    <button id="clearSearch">âŒ</button>
  </div>

  <div class="section">
    <h2>ğŸ¶ Canciones para la semana</h2>
    <div id="contenedor-semana" style="display:none;">
      <input id="titulo-semana" placeholder="TÃ­tulo (ej. Semana del 7 al 13 de octubre)" />
      <textarea id="canciones-semana" placeholder="Canciones (una por lÃ­nea)"></textarea>
      <button onclick="guardarSeccion('semana')">Guardar secciÃ³n</button>
    </div>
    <div id="mostrar-semana" style="margin-top:8px"></div>
  </div>

  <div class="section">
    <h2>ğŸ†• Canciones nuevas del mes</h2>
    <div id="contenedor-mes" style="display:none;">
      <input id="titulo-mes" placeholder="TÃ­tulo (ej. Octubre 2025)" />
      <textarea id="canciones-mes" placeholder="Canciones (una por lÃ­nea)"></textarea>
      <button onclick="guardarSeccion('mes')">Guardar secciÃ³n</button>
    </div>
    <div id="mostrar-mes" style="margin-top:8px"></div>
  </div>

  <button id="btnAgregar" onclick="toggleFormulario()" style="display:none;">â• Agregar nueva canciÃ³n</button>

  <form id="formulario" onsubmit="event.preventDefault(); agregarCancion();" style="display:none;margin-top:12px;">
    <div class="card">
      <h2>Agregar canciÃ³n</h2>
      <input id="titulo" placeholder="TÃ­tulo de la canciÃ³n" required />
      <textarea id="acordes" placeholder="Acordes..."></textarea>
      <textarea id="imagenes" placeholder="Links de imÃ¡genes (uno por lÃ­nea)"></textarea>
      <input id="audio" placeholder="Link de audio" />
      <input id="youtube" placeholder="Link de YouTube" />
      <button type="submit">Guardar canciÃ³n</button>
    </div>
  </form>

  <div id="lista-canciones" style="display:none;margin-top:12px;"></div>

  <div id="registro-canciones-container" style="margin-top:12px;">
    <button style="background:var(--accent);" onclick="toggleRegistro()">ğŸ“Š Registro de canciones</button>
    <div id="registro-canciones" class="section" style="display:none;">
      <h2>ğŸ“‹ Registro de canciones</h2>
      <table id="tabla-registro">
        <thead>
          <tr>
            <th onclick="setOrden('titulo')">TÃ­tulo</th>
            <th onclick="setOrden('veces')">Veces tocada</th>
            <th onclick="setOrden('ultima')">Ãšltima fecha</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<footer>
  <div id="contadorFinal">canciones totales ğŸ¶: 0</div>
  <button onclick="window.scrollTo({top:0, behavior:'smooth'})">â¬†ï¸ Volver al inicio</button>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getFirestore, collection, addDoc, doc, setDoc, getDoc, updateDoc, onSnapshot, getDocs } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDahT6IuQwSYdpAMcPpAERpqVuobmqmVSQ",
  authDomain: "repertorioworship.firebaseapp.com",
  projectId: "repertorioworship",
  storageBucket: "repertorioworship.firebasestorage.app",
  messagingSenderId: "493050453266",
  appId: "1:493050453266:web:cf07ce9fbb471122f167cb"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let modoEdicion=false;
let cancionesCache=[];

/* === UTILIDADES === */
function normalizar(t){return (t||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase();}
function actualizarContador(){document.getElementById("contadorFinal").textContent = `canciones totales ğŸ¶: ${cancionesCache.length}`;}
function debounce(fn,delay){let t;return (...args)=>{clearTimeout(t); t=setTimeout(()=>fn(...args),delay);}}

/* === CARGA CANCIONES === */
function construirCard(d){
  const div=document.createElement("div"); div.className="card";
  div.innerHTML=`
    <h2 contenteditable="${modoEdicion}">${d.titulo}</h2>
    <p contenteditable="${modoEdicion}">${d.acordes||""}</p>
    <textarea style="display:${modoEdicion?"block":"none"}">${(d.imagenes||[]).join("\n")}</textarea>
    <input style="display:${modoEdicion?"block":"none"}" value="${d.audio||""}">
    <input style="display:${modoEdicion?"block":"none"}" value="${d.youtube||""}">
    ${(d.imagenes||[]).map(u=>`<img src="${u}" width="100%" style="margin-top:8px;border-radius:8px;">`).join('')}
    ${!modoEdicion && d.audio?`<a class="link-btn" href="${d.audio}" target="_blank">ğŸ§ Escuchar</a>`:""}
    ${!modoEdicion && d.youtube?`<a class="link-btn" href="${d.youtube}" target="_blank">ğŸ“º YouTube</a>`:""}
    ${modoEdicion?`<button onclick="guardarEdicion('${d.id}',this)">ğŸ’¾ Guardar</button>`:""}
  `;
  return div;
}

function cargarCanciones(){
  const cont=document.getElementById("lista-canciones");
  const q=normalizar(document.getElementById("search").value||"");
  cont.innerHTML="";
  cancionesCache.filter(d=>normalizar(d.titulo).includes(q)).forEach(d=>cont.appendChild(construirCard(d)));
  cont.style.display = cancionesCache.length>0?"block":"none";
  actualizarContador();
}

/* === FIRESTORE === */
async function inicializarCanciones(){
  const col=collection(db,"canciones");
  onSnapshot(col,snap=>{
    cancionesCache = snap.docs.map(d=>({id:d.id,...d.data()}));
    cargarCanciones();
  });
}

/* === AGREGAR Y EDITAR === */
async function agregarCancion(){
  const titulo=document.getElementById("titulo").value.trim();
  if(!titulo) return alert("El tÃ­tulo es obligatorio");
  await addDoc(collection(db,"canciones"),{
    titulo,
    acordes:document.getElementById("acordes").value.trim(),
    imagenes:document.getElementById("imagenes").value.trim().split("\n").filter(x=>x),
    audio:document.getElementById("audio").value.trim(),
    youtube:document.getElementById("youtube").value.trim()
  });
  document.getElementById("formulario").reset(); document.getElementById("formulario").style.display="none";
}

async function guardarEdicion(id,btn){
  const card=btn.closest(".card");
  const [tituloEl,acordesEl,imagenesEl,audioEl,youtubeEl]=card.querySelectorAll("h2,p,textarea,input:nth-of-type(1),input:nth-of-type(2)");
  await updateDoc(doc(db,"canciones",id),{
    titulo:tituloEl.innerText.trim(),
    acordes:acordesEl.innerText.trim(),
    imagenes:imagenesEl.value.trim().split("\n").filter(x=>x),
    audio:audioEl.value.trim(),
    youtube:youtubeEl.value.trim()
  });
  alert("âœ… Cambios guardados");
}

/* === MODO EDICIÃ“N === */
function activarEdicion(){
  if(!modoEdicion){
    const pin=prompt("Introduce el PIN para editar:");
    if(pin==="2025"){modoEdicion=true; document.querySelector(".edit-banner").style.display="block"; document.getElementById("btnAgregar").style.display="block"; alert("âœï¸ Modo ediciÃ³n activado");}
    else if(pin) return alert("PIN incorrecto");
  } else {modoEdicion=false; document.querySelector(".edit-banner").style.display="none"; document.getElementById("btnAgregar").style.display="none"; alert("ğŸ”’ Modo ediciÃ³n desactivado");}
  cargarCanciones();
}

/* === TOGGLES === */
function toggleDark(){document.body.classList.toggle("dark"); localStorage.setItem("theme",document.body.classList.contains("dark")?"dark":"light");}
function toggleFormulario(){const f=document.getElementById("formulario"); f.style.display=f.style.display==="none"?"block":"none";}
function toggleCanciones(){const c=document.getElementById("lista-canciones"); c.style.display=c.style.display==="none"?"block":"none";}
document.getElementById("search").addEventListener("input",debounce(cargarCanciones,300));

/* === INICIALIZAR === */
window.addEventListener("load",()=>{
  if(localStorage.getItem("theme")==="dark") document.body.classList.add("dark");
  inicializarCanciones();
  window.agregarCancion=agregarCancion;
  window.guardarEdicion=guardarEdicion;
  window.toggleFormulario=toggleFormulario;
  window.activarEdicion=activarEdicion;
  window.toggleDark=toggleDark;
  window.toggleCanciones=toggleCanciones;
});
</script>
</body>
</html>