<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Repertorio Worship ‚Äî Demo (con PIN)</title>
<style>
  :root{
    --blue:#0b5ed7;
    --bg:#f6f7fb;
    --card:#ffffff;
    --text:#222;
    --muted:#666;
  }
  [data-theme="dark"]{
    --bg:#0f1720;
    --card:#0b1220;
    --text:#e6eef8;
    --muted:#9fb0c8;
    --blue:#0b66d6;
  }

  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--text);}
  .header{
    background:var(--blue);
    color:white;
    padding:10px 12px;
    display:flex;
    align-items:center;
    gap:8px;
    box-shadow:0 2px 6px rgba(0,0,0,0.12);
    position:sticky;
    top:0;
    z-index:50;
    /* keep children in single line and centered appropriately */
    justify-content:space-between;
    flex-wrap:nowrap;
  }
  .header .left,.header .center,.header .right{
    display:flex;
    align-items:center;
    min-width:0;
  }
  .header .left{flex:0 0 auto;}
  .header .center{flex:1 1 auto; justify-content:center;}
  .header .right{flex:0 0 auto;}
  .btn{
    background:transparent;border:0;color:inherit;padding:8px 10px;border-radius:8px;font-size:15px;cursor:pointer;
  }
  .btn:focus{outline:2px solid rgba(255,255,255,0.25)}
  .btn.primary{background:rgba(255,255,255,0.08);backdrop-filter:blur(2px)}
  .btn.icon{font-size:18px;padding:8px;}
  main{max-width:980px;margin:18px auto;padding:0 14px;}
  .controls-row{display:flex;gap:8px;align-items:center;margin-bottom:14px;flex-wrap:wrap;}
  .card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(3,10,20,0.06);margin-bottom:12px;}
  h2{margin:0 0 8px 0;font-size:18px}
  label{display:block;font-size:14px;margin-bottom:6px;color:var(--muted)}
  input[type="text"], textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);font-size:14px;background:transparent;color:var(--text)}
  .song-list{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:10px}
  .song{padding:10px;border-radius:8px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);position:relative}
  .song h3{margin:0 0 6px 0;font-size:16px}
  .song p{margin:0 0 8px 0;color:var(--muted);font-size:14px}
  .song-actions{position:absolute;right:10px;top:10px;display:flex;gap:6px}
  .small{font-size:13px;padding:6px 8px;border-radius:6px}
  .muted{color:var(--muted)}
  /* Modal PIN */
  .overlay{position:fixed;inset:0;background:rgba(3,6,10,0.45);display:flex;align-items:center;justify-content:center;z-index:100;opacity:0;pointer-events:none;transition:opacity .18s}
  .overlay.show{opacity:1;pointer-events:auto}
  .pin-box{background:var(--card);padding:18px;border-radius:12px;min-width:320px;max-width:90%;box-shadow:0 8px 30px rgba(2,6,23,0.4)}
  .pin-box h3{margin-top:0;margin-bottom:8px}
  .pin-row{display:flex;gap:8px;align-items:center}
  .text-danger{color:#c53030;margin-top:8px}
  /* Responsive ensure header items don't wrap and center is centered */
  @media (max-width:420px){
    .header{padding:8px}
    .btn{padding:6px 8px;font-size:14px}
    .pin-box{min-width:260px}
  }
  footer{max-width:980px;margin:18px auto;text-align:center;color:var(--muted);font-size:13px}
</style>
</head>
<body>

<header class="header" role="banner" aria-label="Barra Superior">
  <div class="left" style="gap:6px;">
    <button id="metBtn" class="btn primary" title="Metr√≥nomo (activar / parar)">
      ‚è±Ô∏è <span id="metLabel" style="margin-left:6px;font-weight:600">Metr√≥nomo</span>
    </button>
  </div>

  <div class="center">
    <button id="editBtn" class="btn primary" aria-pressed="false" title="Editar">
      Editar ‚úèÔ∏è
    </button>
  </div>

  <div class="right" style="gap:6px;">
    <button id="themeBtn" class="btn primary" title="Cambiar tema">
      üåô
    </button>
  </div>
</header>

<main>
  <section class="card">
    <h2>Repertorio</h2>
    <div class="muted" style="margin-bottom:8px">Lista de canciones (usa el modo edici√≥n para agregar/editar/borrar).</div>

    <div id="songList" class="song-list" aria-live="polite">
      <!-- Songs are injected here -->
    </div>
  </section>

  <section id="newSongSection" class="card" style="display:none;">
    <h2>üîß Nueva canci√≥n</h2>
    <label for="songTitle">T√≠tulo</label>
    <input id="songTitle" type="text" placeholder="Nombre de la canci√≥n">
    <label for="songNotes">Notas / Acordes</label>
    <textarea id="songNotes" rows="4" placeholder="Por ejemplo: Verso, Coro, notas..."></textarea>
    <div style="margin-top:10px;text-align:right">
      <button id="addSongBtn" class="btn primary small">A√±adir canci√≥n</button>
    </div>
  </section>

  <section id="weekSection" class="card" style="display:none;">
    <h2>üìã Canciones para la semana</h2>
    <label for="weekList">Contenido (editable en modo edici√≥n)</label>
    <textarea id="weekList" rows="6" placeholder="Lista de canciones para el pr√≥ximo servicio..."></textarea>
    <div style="margin-top:10px;text-align:right">
      <button id="saveWeekBtn" class="btn small">Guardar</button>
    </div>
  </section>

  <section class="card">
    <h2>Informaci√≥n</h2>
    <p class="muted">Modo edici√≥n controlado por PIN. El PIN por defecto es <strong>2025</strong>.</p>
  </section>
</main>

<footer>
  Repertorio ‚Äî Demo. Guardado local (localStorage).
</footer>

<!-- PIN modal overlay -->
<div id="pinOverlay" class="overlay" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="pin-box" role="document">
    <h3>Introduce el PIN para editar</h3>
    <p class="muted">Se requiere PIN para activar el modo edici√≥n.</p>
    <div class="pin-row" style="margin-top:10px">
      <input id="pinInput" type="password" placeholder="PIN" style="flex:1;padding:8px;border-radius:8px;border:1px solid #ddd" />
      <button id="pinSubmit" class="btn primary">Entrar</button>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
      <button id="pinCancel" class="btn">Cancelar</button>
    </div>
    <div id="pinMsg" class="text-danger" style="display:none"></div>
  </div>
</div>

<script>
/* ====== Config y estado ====== */
const PIN_CODE = '2025';
let editMode = false;
const storageKey = 'rw_songs_v1';
const weekKey = 'rw_week_v1';

/* ====== Elementos ====== */
const editBtn = document.getElementById('editBtn');
const pinOverlay = document.getElementById('pinOverlay');
const pinInput = document.getElementById('pinInput');
const pinSubmit = document.getElementById('pinSubmit');
const pinCancel = document.getElementById('pinCancel');
const pinMsg = document.getElementById('pinMsg');

const newSongSection = document.getElementById('newSongSection');
const weekSection = document.getElementById('weekSection');
const songListEl = document.getElementById('songList');
const addSongBtn = document.getElementById('addSongBtn');
const songTitle = document.getElementById('songTitle');
const songNotes = document.getElementById('songNotes');
const weekList = document.getElementById('weekList');
const saveWeekBtn = document.getElementById('saveWeekBtn');

const themeBtn = document.getElementById('themeBtn');
const metBtn = document.getElementById('metBtn');
const metLabel = document.getElementById('metLabel');

/* ====== Metronome simple ====== */
let metPlaying = false;
let metTimer = null;
let audioCtx = null;
let bpm = 80;

function clickSound(time){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.value = 1000;
  gain.gain.setValueAtTime(0.0001, time);
  gain.gain.exponentialRampToValueAtTime(0.25, time + 0.001);
  gain.gain.exponentialRampToValueAtTime(0.0001, time + 0.1);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start(time);
  osc.stop(time + 0.12);
}

function startMetronome(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const interval = 60 / bpm * 1000;
  metPlaying = true;
  metLabel.textContent = 'Metr√≥nomo (ON)';
  metBtn.setAttribute('aria-pressed','true');
  playBeat(); // immediate beat
  metTimer = setInterval(playBeat, interval);
}
function playBeat(){
  if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const now = audioCtx.currentTime;
  clickSound(now);
}
function stopMetronome(){
  metPlaying = false;
  metLabel.textContent = 'Metr√≥nomo';
  metBtn.setAttribute('aria-pressed','false');
  if(metTimer) { clearInterval(metTimer); metTimer = null; }
}

metBtn.addEventListener('click', ()=>{
  if(metPlaying) stopMetronome();
  else startMetronome();
});

/* ====== Theme toggle ====== */
function setTheme(t){
  if(t === 'dark') document.documentElement.setAttribute('data-theme','dark');
  else document.documentElement.removeAttribute('data-theme');
  localStorage.setItem('rw_theme','' + (t === 'dark'));
}
themeBtn.addEventListener('click', ()=>{
  const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
  setTheme(isDark ? 'light' : 'dark');
});
if(localStorage.getItem('rw_theme') === 'true') setTheme('dark');

/* ====== Songs data (localStorage simple demo) ====== */
function defaultSongs(){
  return [
    {id: cryptoRandomId(), title:'Grande Eres T√∫', notes:'Verso / Coro / Puente'},
    {id: cryptoRandomId(), title:'Aqu√≠ Estoy', notes:'Intro: G C Em D'},
    {id: cryptoRandomId(), title:'Mi Salvador', notes:'Ton: D ‚Äî Coro fuerte'}
  ];
}
function cryptoRandomId(){
  return 'id_' + Math.random().toString(36).slice(2,9);
}
function loadSongs(){
  const raw = localStorage.getItem(storageKey);
  if(!raw) { const d = defaultSongs(); localStorage.setItem(storageKey, JSON.stringify(d)); return d; }
  try { return JSON.parse(raw); } catch(e){ return defaultSongs(); }
}
function saveSongs(arr){
  localStorage.setItem(storageKey, JSON.stringify(arr));
}

/* ====== Render UI ====== */
function renderSongs(){
  const songs = loadSongs();
  songListEl.innerHTML = '';
  for(const s of songs){
    const wrap = document.createElement('div');
    wrap.className = 'song card';
    const h = document.createElement('h3');
    h.textContent = s.title;
    const p = document.createElement('p');
    p.textContent = s.notes || '';
    wrap.appendChild(h);
    wrap.appendChild(p);

    // actions (edit/delete) visible only in editMode
    const actions = document.createElement('div');
    actions.className = 'song-actions';
    if(editMode){
      const ebtn = document.createElement('button');
      ebtn.className = 'btn small';
      ebtn.textContent = 'Editar';
      ebtn.addEventListener('click', ()=> openEditSong(s.id));
      const dbtn = document.createElement('button');
      dbtn.className = 'btn small';
      dbtn.textContent = 'Borrar';
      dbtn.addEventListener('click', ()=> {
        if(confirm('¬øBorrar canci√≥n?')) {
          deleteSong(s.id);
        }
      });
      actions.appendChild(ebtn);
      actions.appendChild(dbtn);
      wrap.appendChild(actions);
    }
    songListEl.appendChild(wrap);
  }
}

function openEditSong(id){
  const songs = loadSongs();
  const s = songs.find(x=>x.id===id);
  if(!s) return alert('No encontrado');
  // fill form and scroll to it
  songTitle.value = s.title;
  songNotes.value = s.notes;
  window.scrollTo({top:0,behavior:'smooth'});
  // replace add button behavior to "guardar edici√≥n"
  addSongBtn.textContent = 'Guardar cambios';
  addSongBtn.removeEventListener('click', handleAddSong);
  addSongBtn.addEventListener('click', function saveEd(){
    const t = songTitle.value.trim();
    if(!t) return alert('Pon t√≠tulo');
    s.title = t;
    s.notes = songNotes.value;
    saveSongs(songs);
    renderSongs();
    // reset form and button
    songTitle.value = ''; songNotes.value = '';
    addSongBtn.textContent = 'A√±adir canci√≥n';
    addSongBtn.removeEventListener('click', saveEd);
    addSongBtn.addEventListener('click', handleAddSong);
  });
}

function deleteSong(id){
  let songs = loadSongs();
  songs = songs.filter(s => s.id !== id);
  saveSongs(songs);
  renderSongs();
}

/* ====== Add song handler ====== */
function handleAddSong(){
  const t = songTitle.value.trim();
  if(!t) return alert('Pon t√≠tulo');
  const notes = songNotes.value.trim();
  const songs = loadSongs();
  songs.unshift({id: cryptoRandomId(), title: t, notes});
  saveSongs(songs);
  songTitle.value = ''; songNotes.value = '';
  renderSongs();
}
addSongBtn.addEventListener('click', handleAddSong);

/* ====== Week list persistence ====== */
saveWeekBtn.addEventListener('click', ()=>{
  localStorage.setItem(weekKey, weekList.value || '');
  alert('Guardado');
});

function loadWeek(){
  const w = localStorage.getItem(weekKey) || '‚Äî Sin contenido ‚Äî';
  weekList.value = (localStorage.getItem(weekKey) || '');
}

/* ====== PIN modal and edit mode ====== */
function openPinModal(){
  pinOverlay.classList.add('show');
  pinOverlay.setAttribute('aria-hidden','false');
  pinInput.value = '';
  pinMsg.style.display = 'none';
  pinInput.focus();
}
function closePinModal(){
  pinOverlay.classList.remove('show');
  pinOverlay.setAttribute('aria-hidden','true');
}
pinCancel.addEventListener('click', closePinModal);
pinOverlay.addEventListener('click', (e)=>{
  if(e.target === pinOverlay) closePinModal();
});
pinSubmit.addEventListener('click', ()=>{
  const v = (pinInput.value || '').trim();
  if(v === PIN_CODE){
    pinMsg.style.display = 'none';
    closePinModal();
    toggleEditMode(true);
  } else {
    pinMsg.textContent = 'PIN incorrecto';
    pinMsg.style.display = 'block';
    pinInput.focus();
  }
});
pinInput.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter') pinSubmit.click();
});

/* Toggle edit mode (on/off or set explicit) */
function toggleEditMode(force){
  if(typeof force === 'boolean') editMode = force;
  else editMode = !editMode;
  // update UI
  newSongSection.style.display = editMode ? 'block' : 'none';
  weekSection.style.display = editMode ? 'block' : 'none';
  // change edit button text
  if(editMode){
    editBtn.textContent = 'Salir del modo edici√≥n ‚úñÔ∏è';
    editBtn.setAttribute('aria-pressed','true');
  } else {
    editBtn.textContent = 'Editar ‚úèÔ∏è';
    editBtn.setAttribute('aria-pressed','false');
    // ensure add button returns to normal
    addSongBtn.textContent = 'A√±adir canci√≥n';
    addSongBtn.removeEventListener('click', handleAddSong);
    addSongBtn.addEventListener('click', handleAddSong);
  }
  // hide per-song action buttons by re-rendering
  renderSongs();
}

/* Clicking edit button opens modal if not in editMode, or exits if already in editMode */
editBtn.addEventListener('click', ()=>{
  if(!editMode) openPinModal();
  else {
    // ask confirm to exit
    if(confirm('Salir del modo edici√≥n?')) toggleEditMode(false);
  }
});

/* Init */
(function init(){
  loadWeek();
  renderSongs();
  // ensure addSongBtn has default handler
  addSongBtn.addEventListener('click', handleAddSong);
})();

/* Accessibility: close modal on ESC */
document.addEventListener('keydown', (e)=> {
  if(e.key === 'Escape'){
    if(pinOverlay.classList.contains('show')) closePinModal();
  }
});
</script>
</body>
</html>